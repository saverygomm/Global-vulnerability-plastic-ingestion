---
title: "Avery-Gomm et al. Global seabird plastic ingestion susceptibility can be predicted using phylogeny and behavioural traits "
authors: "Stephanie Avery-Gomm, Craig White"
date: '2019-04-19'
editor_options: 
chunk_output_type: console
---

The purpose of this code is to re-run "Analysis of empirical data: evaluation of traits associated with plastic ingestion". 

This phylogenetic mixed model is implemented using the asreml package (ASReml-R v3) to identify the minimum adequate model, and identify the underlying determinants of observed frequency of occurrence of plastic ingestion in the 212 seabird species for which plastic ingestion data exists. A subscription to download the ASreml-R package can be purchased here: https://www.vsni.co.uk/software/asreml-r/.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r initialize}

# Initialize
getwd()

# Initializing
# Clear workspace
rm(list=ls())
gc()

sessionInfo()  
# Confirm R Version = 3.0.2
R.Version<- R.Version()
R.Version$version.string
if(R.Version$version.string != "R version 3.0.2 (2013-09-25)"){print("WRONG VERSION OF R. SWITCH TO R version 3.0.2 (2013-09-25)")}else{print("CORRECT VERSION: R version 3.0.2 (2013-09-25)")}

# For asreml chunks: R version 3.0.2 (2013-09-25)
# R version 3.0.2 (2013-09-25)
# Platform: x86_64-apple-darwin10.8.0 (64-bit)
 
# # First time? install. packages.
# Not first time? Load Packages
    library(caper)
    library(car)
    library(phylolm)
    library(lmtest)
    library(boot)
    library(lme4)
    library(gtools)
    library(MuMIn)
    library(beepr) # used to alert when code finished running
    library(dplyr) # req for asreml
    library(lattice) # req for asreml
    library(ape) # req for phytools
    library(maps) # req for phytools
    library(phytools) # used for 'read.tree'
    library(knitr)
    library(MCMCglmm)


`%notin%` <- Negate(`%in%`) # Add this function!

options(scipen=999, digits = 3)

# pin is used to calculate standard errors for phylogenetic heritability in PMM
    # using the 'delta' method, as in pin files for stand-alone ASReml
    # http://www.homepages.ed.ac.uk/iwhite/asreml/
    # http://www.homepages.ed.ac.uk/iwhite/asreml/uop
    # http://www.vsni.co.uk/forum/viewtopic.php?t=660
    pin <- dget("./R.analysis/pin.R")
    

```

```{r setup_questions}

# Setup options

# Phylogenetic treees.
    # Have changes been made to the phylogenetic trees?   
    use.published.phylogenetic.tree <- TRUE  
    # If not, then use.published = TRUE. This loads versions of the phylognetic input files for the asreml analysis.
    # If yes, changes have been made to the phylogenetic trees (not recommended) then use.published = FALSE and new input files for the asreml are created. If chosing this option, run.new.asreml should be set to TRUE.

# Rerunning asreml models?
    run.new.asreml <- TRUE  
    # TRUE will rerun the models and generate the output asreml files for 5 models, which can be explored. 
    # FALSE will load the published models which can be explored at the summary stage.
    
    if(run.new.asreml == TRUE){library(asreml)} 
        # If run.new.asreml == FALSE you do not need to install asreml. This is a subscription only program


```

Load trees. The code to re-do trees does not need to be run unless the phylogenetic tree has been redownloaded or the seabird subset of the phylogenetic tree has been changed (i.e., if subset.consensus.tree.phy == FALSE). May change all results.
```{r asreml_prep_trees_R.3.0.2}

if(use.published.phylogenetic.tree == TRUE){
    tree.seabird <- read.tree("./output/ConsensusTree_seabird_matched.phy") # This is the published subset of tree.complete based on seabird species names from data 
    tree.complete <- read.tree("./output/ConsensusTree.phy") # This should always be the published version downloaded in 2018. 

    load(file = paste0("./output/asreml.products/tree.seabird.IA_","2018-11-08_PUBLISHED",".RData"))
    load(file = paste0("./output/asreml.products/tree.seabird.IAasreml_","2018-11-08_PUBLISHED",".RData"))
    load(file = paste0("./output/asreml.products/tree.complete.IA_","2018-11-08_PUBLISHED",".RData"))
    load(file = paste0("./output/asreml.products/tree.complete.IAasreml_","2018-11-08_PUBLISHED",".RData"))

    print("Finished loading published trees")

    }else{
 
 
# TREES
    
# For a NEW seabird subsetted phylogenetic tree (produced by "subset.consensus.tree.phy_if_TRUE.R") 
    tree.seabird <- read.tree(paste0("./output/ConsensusTree_seabird_matched",Sys.Date(),".phy"))  
    tree.complete <- read.tree("./output/ConsensusTree.phy") # This should always be the published version downloaded in 2018. 
 
    # Make sure nodes in the tree are unique
     tree.seabird$node.label <- as.character(c(1:length(tree.seabird$node.label)))
     
     # Inverse Relatedness Matrix and Phylogenetic Covariance Matrix
        tree.seabird.IA <- MCMCglmm::inverseA(tree.seabird, nodes = "TIPS") 
            # disregard Warning message: In inverseA(tree, nodes = "TIPS") : no branch lengths: compute.brlen from ape has been used
        beep()
        str(tree.seabird.IA)
                    # Published example
                    # List of 7
                    #  $ Ainv      :Formal class 'dgCMatrix' [package "Matrix"] with 6 slots
                    #   .. ..@ i       : int [1:115721] 0 1 2 3 4 5 6 7 8 9 ...
                    #   .. ..@ p       : int [1:352] 0 340 680 1020 1360 1700 2040 2380 2720 3060 ...
                    #   .. ..@ Dim     : int [1:2] 351 351
                    #   .. ..@ Dimnames:List of 2
                    #   .. .. ..$ : chr [1:351] "Larus_cachinnans" "Larus_thayeri" "Larus_glaucescens" "Larus_glaucoides" ...
                    #   .. .. ..$ : NULL
                    #   .. ..@ x       : num [1:115721] 59.8 -10.2 -10.2 -10.2 -10.2 ...
                    #   .. ..@ factors : list()
                    #  $ inbreeding: num [1:570] 0.03143 0.97143 0.6 0.00571 0.08571 ...
                    #  $ dii       : num [1:570] 0.03143 0.97143 0.6 0.00571 0.08571 ...
                    #  $ node.names: chr [1:351] "Larus_cachinnans" "Larus_thayeri" "Larus_glaucescens" "Larus_glaucoides" ...
                    #  $ pedigree  : chr [1:570, 1:3] "0" NA NA NA ...
                    #   ..- attr(*, "dimnames")=List of 2
                    #   .. ..$ : NULL
                    #   .. ..$ : chr [1:3] "node.names" "" ""
                    #  $ phylogeny : logi TRUE
                    #  $ mii       : num [1:570] 0 0 0 0 0 0 0 0 0 0 ...
    
    # Converts sparseMatrix to asreml's giv format
        tree.seabird.IAasreml <- MCMCglmm::sm2asreml(tree.seabird.IA$Ainv, tree.seabird.IA$node.names) 
        beep()
        str(tree.seabird.IAasreml)
                    # Published example
                    # 'data.frame':	58036 obs. of  3 variables:
                    #  $ Row     : num  1 2 2 3 3 3 4 4 4 4 ...
                    #  $ Column  : int  1 1 2 1 2 3 1 2 3 4 ...
                    #  $ Ainverse: num  59.8 -10.2 59.8 -10.2 -10.2 ...
                    #  - attr(*, "rowNames")= chr  "Larus_cachinnans" "Larus_thayeri" "Larus_glaucescens" "Larus_glaucoides" ...

        
# For full dataset
    
    # Make sure nodes in the tree are unique
    tree.complete$node.label <- as.character(c(1:length(tree.complete$node.label)))
  
    # Inverse Relatedness Matrix and Phylogenetic Covariance Matrix
        tree.complete.IA <- MCMCglmm::inverseA(tree.complete, nodes = "TIPS") 
            # Warning message: In inverseA(tree, nodes = "TIPS") : no branch lengths: compute.brlen from ape has been used
        beep()
        str(tree.complete.IA)
                 # Published example 
                 # List of 7
                 # $ Ainv      :Formal class 'dgCMatrix' [package "Matrix"] with 6 slots
                 #  .. ..@ i       : int [1:98707589] 0 1 2 3 4 5 6 7 8 9 ...
                 #  .. ..@ p       : int [1:9994] 0 9935 19870 29805 39740 49675 59610 69545 79480 89415 ...
                 #  .. ..@ Dim     : int [1:2] 9993 9993

    # Converts sparseMatrix to asreml's giv format
        tree.complete.IAasreml <- MCMCglmm::sm2asreml(tree.complete.IA$Ainv, tree.complete.IA$node.names)
        beep()
        str(tree.complete.IAasreml)
                 # Published example
                 #        'data.frame':	49358791 obs. of  3 variables:
                 # $ Row     : num  1 2 2 3 3 3 4 4 4 4 ...
                 # $ Column  : int  1 1 2 1 2 3 1 2 3 4 ...
                 # $ Ainverse: num  1675 -323 1675 -323 -323 ...
                 # - attr(*, "rowNames")= chr  "Larus_cachinnans" "Larus_thayeri" "Larus_glaucescens" "Larus_glaucoides" ...
                 # and so on
        
# Save
    # save(tree.seabird.IA, file = paste0("./output/asreml.products/tree.seabird.IA_",Sys.Date(),".RData"))
    # save(tree.seabird.IAasreml, file = paste0("./output/asreml.products/tree.seabird.IAasreml_",Sys.Date(),".RData"))
    # save(tree.complete.IA, file = paste0("./output/asreml.products/tree.complete.IA_",Sys.Date(),".RData"))
    # save(tree.complete.IAasreml, file = paste0("./output/asreml.products/tree.complete.IAasreml_",Sys.Date(),".RData"))

    par(xpd = FALSE) 
    
    print("Finished new trees")
        }
    
```

Load plastic data generated by merging Data S1 and Data S2 using first script (1_Phylo analysis input prep.Rmd)
```{r load.data}

# Load file created with 1_Phylo analysis input prep.Rmd
data2 <- read.csv("./output/data2.csv", stringsAsFactors = T, strip.white = T)

# Add 'animal' req for asreml
data2$animal <- data2$TipLabel_BirdTree 

# Load tree
tree.seabird$node.label <- as.character(c(1:length(tree.seabird$node.label)))
```

Analysis of Frequency of Plastic Ingestion, implemented in ASReml-R V3 (available by subscription). 

*Table S2 (a).* Wald-type F-tests output for the minimum adequate phylogenetic mixed model, showing significance of fixed effects on the frequency of occurrence for plastic ingestion for sampled seabirds *where diet is represented by dominant prey type*. Phylogenetic heritability was high (0.85 ± 0.07 SE). (b) Parameter estimates for the frequency of occurrence among sampled seabirds.  
```{r TableS2AB.asreml_phylogenetic_mixed_model_analysis_FO_R.3.0.2_DOMINANT-PREY-TYPES}

if(run.new.asreml == FALSE){ 
  # This version is run with Date_Decade. It is preferrable to Date_FirstYR for the prediction stage bc it has fewer levels. 

# Below are n models, which show how the full model was simplified by stepwise backwards elimination, sequentially removing parameter estimates with the highest p value until only those with a conservative threshold of p < 0.10 remained. This is how a minimum adequate model was generated for use in developing predictions 

    # load(file = "./output/asreml.products/2021-08-21_m1.Diet.asreml_R.3.0.2.RData") 
    # load(file = "./output/asreml.products/2021-08-21_m2.Diet.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m3.Diet.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m4.Diet.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m5.Diet.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m6.Diet.asreml_R.3.0.2.RData")

}else{
 
# Data summary of the empirical data that was used in the asreml phylogenetic mixed-model
    data.sources <- unique(data2$Source) 
    length(data.sources) #154
    
    number.of.birds <- sum(data2$n, na.rm = TRUE)
    number.of.birds #  48820
    
    number.of.sps <- unique(data2$TipLabel_BirdTree) 
    length(number.of.sps) # 212
    

# Stepwise Simplification with 'Diet, Anthropegenic Subsidy, Pelagic Specialist, Feeding Method Simple, sqrtN, and the rest.

# Full Model

    m1.0.asreml <- asreml(fixed = logit.FO ~ Order 
                          + scaled.body.mass 
                          + Date_Decade 
                          + sqrtN 
                          + Feeding.Method.Simple 
                          + Age.Class 
                          + Diet 
                          + Anthropogenic.Subsidy_rank 
                          + pelagic_specialist_CR,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
     wald.asreml(m1.0.asreml, ssType="conditional", denDF="numeric")
    
# Remove Order
    m2.0.asreml <- asreml(fixed = logit.FO ~  scaled.body.mass +
                              Date_Decade + sqrtN + Feeding.Method.Simple +
                              + Age.Class +
                              + Diet + Anthropogenic.Subsidy_rank + pelagic_specialist_CR,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    wald.asreml(m2.0.asreml, ssType="conditional", denDF="numeric")
    
            
    
# Remove pelagic_specialist_CR
    m3.0.asreml <- asreml(fixed = logit.FO ~ scaled.body.mass +
                              Date_Decade + sqrtN + Feeding.Method.Simple +
                              + Age.Class +
                              + Diet + Anthropogenic.Subsidy_rank,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    wald.asreml(m3.0.asreml, ssType="conditional", denDF="numeric")
    
    
# Remove scaled.body.mass
    m4.0.asreml <- asreml(fixed = logit.FO ~
                              Date_Decade + sqrtN + Feeding.Method.Simple +
                              + Age.Class +
                              + Diet + Anthropogenic.Subsidy_rank,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    #Significance of fixed effects
    wald.asreml(m4.0.asreml, ssType="conditional", denDF="numeric")
    
    
# Remove sqrtN
    m5.0.asreml <- asreml(fixed = logit.FO ~
                              Date_Decade + Feeding.Method.Simple +
                              + Age.Class +
                              + Diet + Anthropogenic.Subsidy_rank,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    #Significance of fixed effects
    wald.asreml(m5.0.asreml, ssType="conditional", denDF="numeric")
    
    
# Remove Anthropogenic.Subsidy_rank *** FINAL MODEL ***
    m6.0.asreml <- asreml(fixed = logit.FO ~
                              Date_Decade + Feeding.Method.Simple +
                              + Age.Class +
                              + Diet,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    #Significance of fixed effects
    wald.asreml(m6.0.asreml, ssType="conditional", denDF="numeric")
    
         
    #                       Df  denDF F.inc F.con Margin          Pr
    # (Intercept)            1   45.4  1.21  1.21        0.276428562
    # Date_Decade            5 1449.5  4.92  6.65      A 0.000003900
    # Feeding.Method.Simple  6  223.1  1.79  2.33      A 0.033655302
    # Age.Class              4 1453.6  8.65  8.69      A 0.000000629
    # Diet                   4  352.4  2.79  2.79      A 0.026265553
    
    #Parameter estimates for fixed effects
    summary(m6.0.asreml, all=T)$coef.fi
    
    #                                       solution std error   z ratio
    # Diet_Carrion.NonFishVertebrates        0.00000        NA       NA
    # Diet_Cephalopods                      -4.72426     1.482 -3.18815
    # Diet_Crustaceans                      -3.71698     1.380 -2.69357
    # Diet_Fish                             -3.94279     1.345 -2.93159
    # Diet_Other.Inverts                    -3.92820     1.615 -2.43297
    # Age.Class_A                            0.00000        NA       NA
    # Age.Class_Mixed                       -1.05525     0.346 -3.05041
    # Age.Class_Nest-bound                   2.28525     0.606  3.77244
    # Age.Class_SA                           0.66839     0.379  1.76411
    # Age.Class_SA_A                        -0.61448     0.353 -1.73879
    # Feeding.Method.Simple_Aerial.Pursuit   0.00000        NA       NA
    # Feeding.Method.Simple_Bottom.Feeding  -3.63287     2.711 -1.33986
    # Feeding.Method.Simple_Diving          -3.29047     1.946 -1.69049
    # Feeding.Method.Simple_Plunging         0.57710     1.452  0.39754
    # Feeding.Method.Simple_Scavenging      -3.58854     1.768 -2.03000
    # Feeding.Method.Simple_Skimming        -0.15395     2.032 -0.07575
    # Feeding.Method.Simple_Surface.Seizing -0.00515     1.375 -0.00375
    # Date_Decade_1960s                      0.00000        NA       NA
    # Date_Decade_1970s                      0.78719     0.609  1.29346
    # Date_Decade_1980s                     -0.15444     0.613 -0.25206
    # Date_Decade_1990s                      1.06995     0.674  1.58854
    # Date_Decade_2000s                      0.18365     0.622  0.29504
    # Date_Decade_2010s                     -0.90144     0.600 -1.50162
    # (Intercept)                            0.77094     4.872  0.15825

    
    #Parameter estimates for random effects
    summary(m6.0.asreml)
    
    # $call
    # asreml(fixed = logit.FO ~ Date_Decade + Feeding.Method.Simple + 
    #     +Age.Class + +Diet, random = ~giv(animal, var = T), data = data2, 
    #     na.method.Y = "omit", na.method.X = "omit", ginverse = list(animal = tree.seabird.IAasreml))
    # 
    # $loglik
    # [1] -2878
    # 
    # $nedf
    # [1] 1477
    # 
    # $sigma
    # [1] 3.88
    # 
    # $varcomp
    #                          gamma component std.error z.ratio constraint
    # giv(animal, var = T).giv  5.73      86.3    18.158    4.75   Positive
    # R!variance                1.00      15.1     0.584   25.83   Positive
    
    #Calculate phylogenetic heritability (also known as lambda)
    pin(m6.0.asreml, ~ V1/(V1+V2))
    
            # Estimate     SE
            # 0.85 0.0874
  

# Save
    save(m1.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m1.Diet.asreml_R.3.0.2.RData"))
    save(m2.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m2.Diet.asreml_R.3.0.2.RData"))
    save(m3.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m3.Diet.asreml_R.3.0.2.RData"))
    save(m4.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m4.Diet.asreml_R.3.0.2.RData"))
    save(m5.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m5.Diet.asreml_R.3.0.2.RData"))
    save(m6.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m6.Diet.asreml_R.3.0.2.RData"))
}

```

We also ran the analysis with seperate prey types instead of dominant prey type. 

*Table S3 (a).* Wald-type F-tests output for the minimum adequate phylogenetic mixed model, showing significance of fixed effects on the frequency of occurrence for plastic ingestion for sampled seabirds *when diet is represented by the presence or absence of individual prey types, instead of dominant prey type.* Phylogenetic heritability was high (0.86 ± 0.08 SE). (b) Parameter estimates for the frequency of occurrence among sampled seabirds.  
```{r TableS3A.B.asreml_phylogenetic_mixed_model_analysis_FO_R.3.0.2_SEPERATE-PREY-TYPES}

rm(m1.0.asreml,m2.0.asreml,m3.0.asreml,m4.0.asreml,m5.0.asreml,m6.0.asreml)

if(run.new.asreml == FALSE){ 

  # This version is run with Date_Decade. It is preferrable to Date_FirstYR for the prediction stage bc it has fewer levels. It does not influence the minimum adequate model. 
  # This version has each prey type seperated out. None end up being retained in minimum adequate model, telling us that perhaps dominant prey type is more important than whether a given species eats fish - despite our crude categorical assignments of a complex food system.

    # load(file = "./output/asreml.products/2021-08-21_m1.CCCFO.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m2.CCCFO.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m3.CCCFO.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m4.CCCFO.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m5.CCCFO.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m6.CCCFO.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m7.CCCFO.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m8.CCCFO.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m9.CCCFO.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m10.CCCFO.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m11.CCCFO.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m12.CCCFO.asreml_R.3.0.2.RData")
  
   
}else{
  

dim(data2) # 1528  46

        # Data summary of the empirical data that was used in the asreml phylogenetic mixed-model (excluding cases where FO wasn't available or species where trait data was NA (i.e., diet totally known etc))
        data.sources <- unique(data2$Source) # 154 Sources
        data.sources
        number.of.birds <- sum(data2$n, na.rm = TRUE)
        number.of.birds #  48820 

        number.of.sps <- data2 %>%
            filter(!is.na(Source)) %>%
            droplevels()
        number.of.sps <- unique(number.of.sps$TipLabel_BirdTree) # 212
        number.of.sps # 208
        levels(data2$Diet)
        
tree.seabird$node.label <- as.character(c(1:length(tree.seabird$node.label)))


# Stepwise Simplification 
  # with factors: Order + scaled.body.mass + Date_Decade + sqrtN + Feeding.Method.Simple + Age.Class + Fish + Cephalopods + Crustaceans + Other.Inverts + Carrion.NonFishVertebrates + Anthropogenic.Subsidy_rank + pelagic_specialist_CR. We considered including DMS.responsive_Dell.Ariccia as a factor in the main analysis, but this would introduce NA's for 189/212 species, resulting in a much smaller dataset (because of the na.method selected).

# Full Model

    m1.0.asreml <- asreml(fixed = logit.FO ~ 
                              Order
                              + scaled.body.mass
                              + Date_Decade
                              + sqrtN
                              + Feeding.Method.Simple
                              + Age.Class +
                              + Fish
                              + Cephalopods
                              + Crustaceans
                              + Other.Inverts
                              + Carrion.NonFishVertebrates
                              + Anthropogenic.Subsidy_rank
                              + pelagic_specialist_CR
                              ,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    wald.asreml(m1.0.asreml, ssType="conditional", denDF="numeric")
    
# Remove Order
    m2.0.asreml <- asreml(fixed = logit.FO ~ 
                               scaled.body.mass
                              + Date_Decade 
                              + sqrtN 
                              + Feeding.Method.Simple
                              + Age.Class +
                              + Fish + Cephalopods + Crustaceans + Other.Inverts + Carrion.NonFishVertebrates 
                              + Anthropogenic.Subsidy_rank 
                              + pelagic_specialist_CR,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    wald.asreml(m2.0.asreml, ssType="conditional", denDF="numeric")
    
   
    
# Remove Other.Inverts
    m3.0.asreml <- asreml(fixed = logit.FO ~  
                              scaled.body.mass
                              + Date_Decade 
                              + sqrtN 
                              + Feeding.Method.Simple
                              + Age.Class +
                              + Fish + Cephalopods + Crustaceans + Carrion.NonFishVertebrates 
                              + Anthropogenic.Subsidy_rank 
                              + pelagic_specialist_CR,                 
                              random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    #Significance of fixed effects
    wald.asreml(m3.0.asreml, ssType="conditional", denDF="numeric")
    

# Remove Cephalopod
    m4.0.asreml <- asreml(fixed = logit.FO ~ 
                            scaled.body.mass
                              + Date_Decade 
                              + sqrtN 
                              + Feeding.Method.Simple
                              + Age.Class +
                              + Fish +  Crustaceans + Carrion.NonFishVertebrates 
                              + Anthropogenic.Subsidy_rank 
                              + pelagic_specialist_CR,  
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    #Significance of fixed effects
    wald.asreml(m4.0.asreml, ssType="conditional", denDF="numeric")
    

# Remove scaled.body.mass
    m5.0.asreml <- asreml(fixed = logit.FO ~ 
                              Date_Decade 
                              + sqrtN 
                              + Feeding.Method.Simple
                              + Age.Class +
                              + Fish +  Crustaceans + Carrion.NonFishVertebrates 
                              + Anthropogenic.Subsidy_rank 
                              + pelagic_specialist_CR,     
                              random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                        data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    #Significance of fixed effects
    wald.asreml(m5.0.asreml, ssType="conditional", denDF="numeric")
    
  
    
# Remove Carrion.NonFishVertebrates
    m6.0.asreml <- asreml(fixed = logit.FO ~ 
                              Date_Decade 
                              + sqrtN 
                              + Feeding.Method.Simple
                              + Age.Class +
                              + Fish +  Crustaceans  
                              + Anthropogenic.Subsidy_rank 
                              + pelagic_specialist_CR,  
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    #Significance of fixed effects
    wald.asreml(m6.0.asreml, ssType="conditional", denDF="numeric")
    
   
    # Remove Anthropogenic.Subsidy_rank
    m7.0.asreml <- asreml(fixed = logit.FO ~ 
                              Date_Decade 
                              + sqrtN 
                              + Feeding.Method.Simple
                              + Age.Class +
                              + Fish +  Crustaceans  
                              + pelagic_specialist_CR,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    #Significance of fixed effects
    wald.asreml(m7.0.asreml, ssType="conditional", denDF="numeric")
    
    
    # Remove pelagic_specialist_CR
    m8.0.asreml <- asreml(fixed = logit.FO ~ 
                              Date_Decade 
                              + sqrtN 
                              + Feeding.Method.Simple
                              + Age.Class +
                              + Fish +  Crustaceans,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    #Significance of fixed effects
    wald.asreml(m8.0.asreml, ssType="conditional", denDF="numeric")
    
    
 # Remove sqrtN 
    m9.0.asreml <- asreml(fixed = logit.FO ~ 
                              Date_Decade 
                              + Feeding.Method.Simple
                              + Age.Class +
                              + Fish +  Crustaceans,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    #Significance of fixed effects
    wald.asreml(m9.0.asreml, ssType="conditional", denDF="numeric")
    
    
# Remove Fish 
    m10.0.asreml <- asreml(fixed = logit.FO ~
                               Date_Decade 
                              + Feeding.Method.Simple
                              + Age.Class +
                              + Crustaceans,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    #Significance of fixed effects
    wald.asreml(m10.0.asreml, ssType="conditional", denDF="numeric")
    
  
# Remove Crustaceans 
    m11.0.asreml <- asreml(fixed = logit.FO ~
                               Date_Decade 
                              + Feeding.Method.Simple
                              + Age.Class,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    #Significance of fixed effects
    wald.asreml(m11.0.asreml, ssType="conditional", denDF="numeric")
    

# Remove Feeding.Method.Simple *** FINAL/ MINIMUM ADEQUATE MODEL ***
    m12.0.asreml <- asreml(fixed = logit.FO ~
                               Date_Decade 
                              + Age.Class,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    #Significance of fixed effects
    wald.asreml(m12.0.asreml, ssType="conditional", denDF="numeric")
    
    # LogLikelihood Converged 
    #                       Df  denDF F.inc F.con Margin         Pr
    # (Intercept)  1   50.6  1.14  1.14        0.290832713
    # Date_Decade  5 1461.1  4.89  6.40      A 0.000006795
    # Age.Class    4 1462.7  8.69  8.69      A 0.000000628

    #Parameter estimates for fixed effects
    summary(m12.0.asreml, all=T)$coef.fi
    
    #                      solution std error z ratio
    # Age.Class_A            0.0000        NA      NA
    # Age.Class_Mixed       -1.0372     0.346 -2.9967
    # Age.Class_Nest-bound   2.3135     0.607  3.8097
    # Age.Class_SA           0.6968     0.379  1.8378
    # Age.Class_SA_A        -0.5905     0.353 -1.6716
    # Date_Decade_1960s      0.0000        NA      NA
    # Date_Decade_1970s      0.9011     0.608  1.4829
    # Date_Decade_1980s     -0.0327     0.611 -0.0535
    # Date_Decade_1990s      1.1784     0.674  1.7481
    # Date_Decade_2000s      0.3367     0.622  0.5415
    # Date_Decade_2010s     -0.7427     0.599 -1.2390
    # (Intercept)           -4.7532     4.729 -1.0052
  
    #Parameter estimates for random effects
    summary(m12.0.asreml)
    
    # $call
    # asreml(fixed = logit.FO ~ Date_Decade + Age.Class, random = ~giv(animal, 
    #     var = T), data = data2, na.method.Y = "omit", na.method.X = "omit", 
    #     ginverse = list(animal = tree.seabird.IAasreml))
    # 
    # $loglik
    # [1] -2891
    # 
    # $nedf
    # [1] 1488
    # 
    # $sigma
    # [1] 3.89
    # 
    # $varcomp
    #                          gamma component std.error z.ratio constraint
    # giv(animal, var = T).giv  6.03      91.3    18.245    5.01   Positive
    # R!variance                1.00      15.1     0.585   25.88   Positive
    # 
    # attr(,"class")
    # [1] "summary.asreml"
    
    #Calculate phylogenetic heritability (also known as lambda)
    pin(m12.0.asreml, ~ V1/(V1+V2))
    
    # Estimate     SE
    # 0.858 0.083
    
    
# Summary:
print(paste0("According to the published dataset representing ",number.of.birds," birds and ", length(data.sources)," data sources, WHEN WE INCLUDE SEPERATE DIET TYPES INSTEAD OF DOMINANT PREY TYPE the factors that best predict plastic ingestion across all available empirical data for ", length(number.of.sps), " seabirds are Age_Class (Nest-bound >> Subadult > Adult > Subadult/Adult >> Mixed) and Date_Decade (variable - 90s > 70s > 60s > 00s > 80s > 10s). No prey types are significant, suggesting that perhaps dominant prey type is a better predictor of plastic ingestion across the full phylogeny of seabirds, despite being a coarse categorization."))

# Save
    save(m1.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m1.Diet.asreml_R.3.0.2.RData"))
    save(m2.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m2.Diet.asreml_R.3.0.2.RData"))
    save(m3.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m3.Diet.asreml_R.3.0.2.RData"))
    save(m4.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m4.Diet.asreml_R.3.0.2.RData"))
    save(m5.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m5.Diet.asreml_R.3.0.2.RData"))
    save(m6.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m6.Diet.asreml_R.3.0.2.RData"))
    save(m7.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m7.Diet.asreml_R.3.0.2.RData"))
    save(m8.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m8.Diet.asreml_R.3.0.2.RData"))
    save(m9.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m9.Diet.asreml_R.3.0.2.RData"))
    save(m10.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m10.Diet.asreml_R.3.0.2.RData"))
    save(m11.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m11.Diet.asreml_R.3.0.2.RData"))
    save(m12.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m12.Diet.asreml_R.3.0.2.RData"))

    }

```


*Table S4 (a).* Reevaluating the olfactory trap hypothesis. Wald-type F-tests output for the minimum adequate phylogenetic mixed model, showing significance of fixed effects on the frequency of occurrence for plastic ingestion for a subset of sampled Procellariiformes *when diet is represented by the presence or absence of individual prey types, instead of dominant prey type*. Phylogenetic heritability for the minimum adequate model was high (0.84 ± 0.17 SE). (b) Parameter estimates for the frequency of occurrence among a subset of sampled Procellariiformes. 

Other.Invert = jellyfish, insects, marine insects (Halobates, Coleoptera)

```{r TableS4A.B_asreml_phylogenetic_mixed_model_analysis_FO_R.3.0.2_DMS.RESPONSIVENESS-PROCELLARIFORMES_SEPERATE PREY TYPES}

# This version is run with Date_Decade. It is preferrable to Date_FirstYR for the prediction stage bc it has fewer levels.

# Below are n models, which show how the full model was simplified by stepwise backwards elimination, sequentially removing parameter estimates with the highest p value until only those with a conservative threshold of p < 0.10 remained. This is how a minimum adequate model was generated for use in developing predictions 

if(run.new.asreml == FALSE){ 
    
     # Load asreml or run anew, below

    # load(file = "./output/asreml.products/2021-08-21_m1.CCCFO-procellarid.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m2.CCCFO-procellarid.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m3.CCCFO-procellarid.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m4.CCCFO-procellarid.asreml_R.3.0.2.RData")

  
  }else{

    data2.DMS <- data2 %>%
    filter(Order == "PROCELLARIIFORMES") %>%
    # filter(!is.na(DMS.responsive_Dell.Ariccia)) %>% # <<< this filters out species that would be left out anyways because DMS.responsive_Dell.Arricia is NA
    droplevels()
         
    dim(data2.DMS) #  now 1071  46

    # Data summary of the empirical data that was used in the asreml phylogenetic mixed-model (excluding cases where FO wasn't available or species where trait data was NA (i.e., diet totally known etc))
        data.sources <- unique(data2.DMS$Source) 
        length(data.sources) # 122 Sources
        number.of.birds <- sum(data2.DMS$n, na.rm = TRUE)
        number.of.birds # 29038
        
        number.of.sps <- data2.DMS %>%
            filter(!is.na(Source)) %>%
            droplevels()
        number.of.sps <- unique(number.of.sps$TipLabel_BirdTree)
        number.of.sps <- length(number.of.sps) # 23  
        number.of.sps # 100

        # Number of species with dms data?
        numb.dms <- data2.DMS %>% 
          dplyr::select(TipLabel_BirdTree,DMS.responsive_Dell.Ariccia) %>%
          filter(DMS.responsive_Dell.Ariccia != "Unknown") %>%
          droplevels() 

        numb.dms<-numb.dms %>%          
          dplyr::select(TipLabel_BirdTree)
        levels(numb.dms$TipLabel_BirdTree)
        numb.dms<- length(levels(numb.dms$TipLabel_BirdTree))
        numb.dms # 19

       # Number of diet types among species with DMS data?
        diet.types <- data2 %>%
          filter(!is.na(DMS.responsive_Dell.Ariccia)) %>% 
          droplevels()
        unique(diet.types$Diet) # [1] Crustaceans Cephalopods Fish       
        
    # Confirm prey types have been recoded:
      levels(data2.DMS$Fish) # "No"  "Yes" 
      levels(data2.DMS$DMS.responsive_Dell.Ariccia)  #  "N" "Y"
      
# Stepwise Simplification with seperate prey types,
    
    # Full Model 

    m1.0.asreml <- asreml(fixed = logit.FO ~  
                          # Order
                          # + pelagic_specialist_CR
                          + scaled.body.mass
                          + Date_Decade 
                          + sqrtN 
                          + Feeding.Method.Simple 
                          + Age.Class 
                          + Fish
                          + Cephalopods
                          + Crustaceans
                          + Other.Inverts 
                          + Carrion.NonFishVertebrates
                          + Anthropogenic.Subsidy_rank
                          + DMS.responsive_Dell.Ariccia,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2.DMS,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    wald.asreml(m1.0.asreml, ssType="conditional", denDF="numeric")
    
  
# Remove Carrion.NonFishVertebrates
    m2.0.asreml <- asreml(fixed = logit.FO ~ 
                          Order
                          + pelagic_specialist_CR  
                          + Date_Decade 
                          + sqrtN 
                          + Feeding.Method.Simple 
                          + Age.Class 
                          + Fish 
                          + Cephalopods 
                          + Crustaceans 
                          + Other.Inverts 
                          # + Carrion.NonFishVertebrates
                          + Anthropogenic.Subsidy_rank
                          + DMS.responsive_Dell.Ariccia,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2.DMS,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    wald.asreml(m2.0.asreml, ssType="conditional", denDF="numeric")
    
    
# Remove scaled.body.mass
    m3.0.asreml <- asreml(fixed = logit.FO ~ 
                          Order
                          + pelagic_specialist_CR  
                          # + scaled.body.mass 
                          + Date_Decade 
                          + sqrtN 
                          + Feeding.Method.Simple 
                          + Age.Class 
                          + Fish  
                          + Cephalopods 
                          + Crustaceans 
                          + Other.Inverts
                          # + Carrion.NonFishVertebrates
                          + Anthropogenic.Subsidy_rank
                          + DMS.responsive_Dell.Ariccia,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2.DMS,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit") # this will exclude records where fixed factor data are missing, and where response data (logit.FO) are missing.
    
    wald.asreml(m3.0.asreml, ssType="conditional", denDF="numeric")
    
# Remove Order, pelagic_specialist_CR, Fish, Cephalopods bc they don't vary). ** MINIMUM ADEQUATE MODEL **
    m4.0.asreml <- asreml(fixed = logit.FO ~ 
                          # Order
                          # + pelagic_specialist_CR
                          # + scaled.body.mass
                          + Date_Decade 
                          + sqrtN 
                          + Feeding.Method.Simple 
                          + Age.Class 
                          # + Fish
                          # + Cephalopods
                          # + Crustaceans
                          + Other.Inverts
                          # + Carrion.NonFishVertebrates
                          + Anthropogenic.Subsidy_rank
                          + DMS.responsive_Dell.Ariccia,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2.DMS,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit") # this will exclude records where fixed factor data are missing, and where response data (logit.FO) are missing.
    
    wald.asreml(m4.0.asreml, ssType="conditional", denDF="numeric")
    
    # LogLikelihood Converged 
    # $Wald
    #                             Df denDF  F.inc   F.con Margin             Pr
    # (Intercept)                  1   6.1 0.0387  0.0249        0.879737258057
    # Date_Decade                  5 495.9 9.4080 11.0300      A 0.000000000434
    # sqrtN                        1 500.5 5.8600  2.9030      A 0.089020251326
    # Feeding.Method.Simple        3  10.6 3.1240  2.9790      A 0.080154178644
    # Age.Class                    4 498.2 4.3750  4.3840      A 0.001714506784
    # Other.Inverts                1  18.6 1.1090  5.9810      A 0.024599461070
    # Anthropogenic.Subsidy_rank   1  11.6 2.3120  3.6410      A 0.081457401604
    # DMS.responsive_Dell.Ariccia  1  17.1 5.7500  5.7500      A 0.028149296631
    
#Parameter estimates for fixed effects
    summary(m4.0.asreml, all=T)$coef.fi    
    
    #                                          solution std error z ratio
    # DMS.responsive_Dell.Ariccia_N           0.0000        NA      NA
    # DMS.responsive_Dell.Ariccia_Y           3.6420    1.5188   2.398
    # Anthropogenic.Subsidy_rank_No           0.0000        NA      NA
    # Anthropogenic.Subsidy_rank_Yes         -2.3795    1.2468  -1.908
    # Other.Inverts_No                        0.0000        NA      NA
    # Other.Inverts_Yes                       3.0213    1.2353   2.446
    # Age.Class_A                             0.0000        NA      NA
    # Age.Class_Mixed                        -1.5165    0.6720  -2.257
    # Age.Class_Nest-bound                    3.3634    1.3825   2.433
    # Age.Class_SA                            0.6312    0.6603   0.956
    # Age.Class_SA_A                         -1.3634    0.7013  -1.944
    # Feeding.Method.Simple_Diving            0.0000        NA      NA
    # Feeding.Method.Simple_Plunging         10.7302    4.2992   2.496
    # Feeding.Method.Simple_Scavenging        0.0000        NA      NA
    # Feeding.Method.Simple_Skimming          6.0920    2.4438   2.493
    # Feeding.Method.Simple_Surface.Seizing   5.4065    3.2430   1.667
    # sqrtN                                  -0.0791    0.0464  -1.704
    # Date_Decade_1960s                       0.0000        NA      NA
    # Date_Decade_1970s                       2.4132    1.1920   2.025
    # Date_Decade_1980s                       1.4205    1.1648   1.220
    # Date_Decade_1990s                       2.3274    1.3437   1.732
    # Date_Decade_2000s                       0.9716    1.1970   0.812
    # Date_Decade_2010s                      -1.4137    1.1755  -1.203
    # (Intercept)                            -9.3600    8.5768  -1.091
    
    #Parameter estimates for random effects
    summary(m4.0.asreml)
    
    #    $call
    # asreml(fixed = logit.FO ~ +Date_Decade + sqrtN + Feeding.Method.Simple + 
    #     Age.Class + Other.Inverts + Anthropogenic.Subsidy_rank + 
    #     DMS.responsive_Dell.Ariccia, random = ~giv(animal, var = T), 
    #     data = data2.DMS, na.method.Y = "omit", na.method.X = "omit", 
    #     ginverse = list(animal = tree.seabird.IAasreml))
    # 
    # $loglik
    # [1] -995
    # 
    # $nedf
    # [1] 501
    # 
    # $sigma
    # [1] 4.03
    # 
    # $varcomp
    #                          gamma component std.error z.ratio constraint
    # giv(animal, var = T).giv   5.4      87.6     50.42    1.74   Positive
    # R!variance                 1.0      16.2      1.04   15.63   Positive
    # 
    # attr(,"class")
    # [1] "summary.asreml"

    #Calculate phylogenetic heritability (also known as lambda)
    pin(m4.0.asreml, ~ V1/(V1+V2))
    
    # Estimate    SE
    # 0.844 0.167

    # By default, four plots are currently generated: a histogram of the residuals, a Normal Q-Q plot, a plot of residuals against fitted values and a plot of residuals against unit number. If the residual structure of the model contains multiple sections, the default plots are conditioned on the factor whose levels define the sections. For multivariate analyses, the plots are conditioned on trait.
    
    plot(m4.0.asreml)
  
            
    # Save
    save(m1.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m1.0.asreml.CCCFO-procellarid.asreml_R.3.0.2.RData"))
    save(m2.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m2.0.asreml.CCCFO-procellarid.asreml_R.3.0.2.RData"))
    save(m3.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m3.0.asreml.CCCFO-procellarid.asreml_R.3.0.2.RData"))
    save(m4.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m4.0.asreml.CCCFO-procellarid.asreml_R.3.0.2.RData"))
    
      }
    
```
  
*Table S5 (a).* Revaluating the olfactory trap hypothesis. Wald-type F-tests output for the minimum adequate phylogenetic mixed model, showing significance of fixed effects on the frequency of occurrence for plastic ingestion for a subset of sampled Procellariiformes *when diet is represented by dominant prey type*. Phylogenetic heritability for the minimum adequate model was high (0.88 ± 0.10 SE). (b) Parameter estimates for the frequency of occurrence among a subset of sampled Procellariiformes. 
```{r TableS5A.B_asreml_phylogenetic_mixed_model_analysis_FO_R.3.0.2_DMS.RESPONSIVENESS-PROCELLARIFORMES-DOMINANT-PREY-TYPE}

# This version is run with Date_Decade. It is preferrable to Date_FirstYR for the prediction stage bc it has fewer levels. It does not influence the minimum adequate model. 

# Below are n models, which show how the full model was simplified by stepwise backwards elimination, sequentially removing parameter estimates with the highest p value until only those with a conservative threshold of p < 0.10 remained. This is how a minimum adequate model was generated for use in developing predictions 


if(run.new.asreml == FALSE){ 
    
    # load(file = "./output/asreml.products/2021-08-21_m1.Diet-procellarid.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m2.Diet-procellarid.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m3.Diet-procellarid.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m4.Diet-procellarid.asreml_R.3.0.2.RData")
    # load(file = "./output/asreml.products/2021-08-21_m5.Diet-procellarid.asreml_R.3.0.2.RData")
     

}else{
  

  data2.DMS <- data2 %>%
    filter(Order == "PROCELLARIIFORMES") %>%
    # filter(!is.na(DMS.responsive_Dell.Ariccia)) %>%
    droplevels()
  
    dim(data2.DMS) # 1071 44

    # Data summary of the empirical data that was used in the asreml phylogenetic mixed-model (excluding cases where FO wasn't available or species where trait data was NA (i.e., diet totally known etc))
        data.sources <- unique(data2.DMS$Source) # 111 Sources
        length(data.sources) # 122
        
        number.of.birds <- sum(data2.DMS$n, na.rm = TRUE)
        number.of.birds # 29038

        number.of.sps <- data2.DMS %>%
            filter(!is.na(Source)) %>%
            droplevels()
        number.of.sps <- unique(number.of.sps$TipLabel_BirdTree)
        number.of.sps <- length(number.of.sps) # 100
        number.of.sps # 100 
        diet.levels <- unique(data2.DMS$Diet)
        
        # Number of species with dms data?
        numb.dms <- data2.DMS %>% 
          dplyr::select(TipLabel_BirdTree,DMS.responsive_Dell.Ariccia) %>%
          filter(DMS.responsive_Dell.Ariccia != "Unknown") %>%
          droplevels()

        numb.dms<-numb.dms %>%          
          dplyr::select(TipLabel_BirdTree)
        levels(numb.dms$TipLabel_BirdTree)
        numb.dms <- length(levels(numb.dms$TipLabel_BirdTree))
        numb.dms # 19  << only 19 will be included in analysis bc DMS.responsive_Dell.Ariccia is NA for the rest
        

# Stepwise Simplification - 

# Full Model (Order not Relevant, pelagic_specialist_CR not Relevant)

    m1.0.asreml <- asreml(fixed = logit.FO ~   
                          Order
                          + pelagic_specialist_CR
                          + scaled.body.mass
                          + Date_Decade 
                          + sqrtN 
                          + Feeding.Method.Simple 
                          + Age.Class 
                          + Diet 
                          + Anthropogenic.Subsidy_rank
                          + DMS.responsive_Dell.Ariccia,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2.DMS,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    wald.asreml(m1.0.asreml, ssType="conditional", denDF="numeric")
  
    
    # Remove scaled.body.mass
    m2.0.asreml <- asreml(fixed = logit.FO ~ 
                          # Order
                          + pelagic_specialist_CR
                           # + scaled.body.mass
                          + Date_Decade 
                          + sqrtN 
                          + Feeding.Method.Simple 
                          + Age.Class 
                          + Diet 
                          + Anthropogenic.Subsidy_rank
                          + DMS.responsive_Dell.Ariccia,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2.DMS,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    wald.asreml(m2.0.asreml, ssType="conditional", denDF="numeric")
    
    
# Remove DMS.responsive_Dell.Ariccia
    m3.0.asreml <- asreml(fixed = logit.FO ~ 
                          # Order
                          + pelagic_specialist_CR
                           # + scaled.body.mass
                          + Date_Decade 
                          + sqrtN 
                          + Feeding.Method.Simple 
                          + Age.Class 
                          + Diet 
                          + Anthropogenic.Subsidy_rank
                          # + DMS.responsive_Dell.Ariccia
                          ,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2.DMS,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    wald.asreml(m3.0.asreml, ssType="conditional", denDF="numeric")

      
# Remove Diet 
    m4.0.asreml <- asreml(fixed = logit.FO ~  
                          # Order
                          + pelagic_specialist_CR
                           # + scaled.body.mass
                          + Date_Decade 
                          + sqrtN 
                          + Feeding.Method.Simple 
                          + Age.Class 
                           # + Diet 
                          + Anthropogenic.Subsidy_rank
                          # + DMS.responsive_Dell.Ariccia
                          ,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2.DMS,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    #Significance of fixed effects
    wald.asreml(m4.0.asreml, ssType="conditional", denDF="numeric")


# Remove Anthropogenic.Subsidy_rank ** FINAL MODEL **
    m5.0.asreml <- asreml(fixed = logit.FO ~  
                           # Order
                          + pelagic_specialist_CR
                           # + scaled.body.mass
                          + Date_Decade 
                          + sqrtN 
                          + Feeding.Method.Simple 
                          + Age.Class 
                           # + Diet 
                          # + Anthropogenic.Subsidy_rank
                          # + DMS.responsive_Dell.Ariccia
                          ,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = data2.DMS,
                          #weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml),
                          na.method.X="omit", na.method.Y="omit")
    
    #Significance of fixed effects
    wald.asreml(m5.0.asreml, ssType="conditional", denDF="numeric")
    
    # $Wald
    #                       Df  denDF  F.inc  F.con Margin             Pr
    # (Intercept)            1   25.5 0.0648  0.058        0.811682422389
    # Date_Decade            5 1008.0 8.3810 11.220      A 0.000000000151
    # sqrtN                  1 1007.7 5.8850  4.210      A 0.040448667881
    # Feeding.Method.Simple  4   71.4 2.2820  2.491      A 0.050680897015
    # Age.Class              4 1010.4 8.0340  8.034      A 0.000002238021
      
 
    #Parameter estimates for fixed effects
    summary(m5.0.asreml, all=T)$coef.fi
    
    #                                           solution std error z ratio
    # Age.Class_A                             0.0000        NA      NA
    # Age.Class_Mixed                        -0.8823    0.4503  -1.959
    # Age.Class_Nest-bound                    2.8887    0.7740   3.732
    # Age.Class_SA                            0.4227    0.4812   0.878
    # Age.Class_SA_A                         -1.4059    0.4571  -3.076
    # Feeding.Method.Simple_Diving            0.0000        NA      NA
    # Feeding.Method.Simple_Plunging          8.2257    2.7997   2.938
    # Feeding.Method.Simple_Scavenging        6.5585    3.0627   2.141
    # Feeding.Method.Simple_Skimming          5.6527    2.5940   2.179
    # Feeding.Method.Simple_Surface.Seizing   6.4976    2.6789   2.425
    # sqrtN                                  -0.0788    0.0384  -2.052
    # Date_Decade_1960s                       0.0000        NA      NA
    # Date_Decade_1970s                       0.9899    1.0768   0.919
    # Date_Decade_1980s                      -0.1323    1.0469  -0.126
    # Date_Decade_1990s                       1.8217    1.1179   1.630
    # Date_Decade_2000s                       0.4398    1.0669   0.412
    # Date_Decade_2010s                      -1.5471    1.0568  -1.464
    # (Intercept)                            -7.8789    9.6698  -0.815
        
    
    #Parameter estimates for random effects
    summary(m5.0.asreml)
    
    #     $call
    # asreml(fixed = logit.FO ~ Date_Decade + sqrtN + Feeding.Method.Simple + 
    #     Age.Class, random = ~giv(animal, var = T), data = data2.DMS, 
    #     na.method.Y = "omit", na.method.X = "omit", ginverse = list(animal = tree.seabird.IAasreml))
    # 
    # $loglik
    # [1] -2040
    # 
    # $nedf
    # [1] 1020
    # 
    # $sigma
    # [1] 4.13
    # 
    # $varcomp
    #                          gamma component std.error z.ratio constraint
    # giv(animal, var = T).giv  6.98       119    33.352    3.57   Positive
    # R!variance                1.00        17     0.784   21.73   Positive
    # 
    # attr(,"class")
    # [1] "summary.asreml"
    

    #Calculate phylogenetic heritability (also known as lambda)
    pin(m5.0.asreml, ~ V1/(V1+V2))
    
            # Estimate     SE # No difference
            # 0.875 0.0994
    
    # By default, four plots are currently generated: a histogram of the residuals, a Normal Q-Q plot, a plot of residuals against fitted values and a plot of residuals against unit number. If the residual structure of the model contains multiple sections, the default plots are conditioned on the factor whose levels define the sections. For multivariate analyses, the plots are conditioned on trait.
    
    plot(m5.0.asreml)
    
  
    # Save
    save(m1.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m1.Diet-procellarid.asreml_R.3.0.2.RData"))
    save(m2.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m2.Diet-procellarid.asreml_R.3.0.2.RData"))
    save(m3.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m3.Diet-procellarid.asreml_R.3.0.2.RData"))
    save(m4.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m4.Diet-procellarid.asreml_R.3.0.2.RData"))
    save(m5.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"_m5.Diet-procellarid.asreml_R.3.0.2.RData"))

   
      }
    
```
   

```{r expolore_existing_model}
# Loaded existing models? Check their results here:

pick.a.model <- NULL # your model here

    # Significance of fixed effects
    wald.asreml(pick.a.model, ssType="conditional", denDF="numeric")
    
    #Parameter estimates for fixed effects
    summary(pick.a.model, all=T)$coef.fi
    
    #Parameter estimates for random effects
    summary(pick.a.model)
    
    # By default, four plots are currently generated: a histogram of the residuals, a Normal Q-Q plot, a plot of residuals against fitted values and a plot of residuals against unit number. If the residual structure of the model contains multiple sections, the default plots are conditioned on the factor whose levels define the sections. For multivariate analyses, the plots are conditioned on trait.
    plot(pick.a.model)
    
    #Calculate phylogenetic heritability (also known as lambda)
    pin(pick.a.model, ~ V1/(V1+V2))

  
```

## End