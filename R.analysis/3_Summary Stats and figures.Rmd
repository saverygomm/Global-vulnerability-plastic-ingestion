---
title: "3_Summary statistics and figures"
author: "Stephanie Avery-Gomm"
date: "17/07/2021"
output: html_document
editor_options: 
chunk_output_type: console
---

This script produces Figure 2 and Figure 1 (in that order)

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
root.dir = dirname(getwd()) # this might work better for PC users.
knitr::opts_knit$set(root.dir = root.dir)

```

```{r initialize}

# Initialize
getwd()

# Initializing
# Clear workspace
rm(list=ls())
gc()

sessionInfo() 

# Run this in     
    
# R version 4.0.4 (2021-02-15)
# Platform: x86_64-apple-darwin17.0 (64-bit)
# Running under: macOS Mojave 10.14.6

# Confirm R Version = 4.0.2
R.Version<- R.Version()
R.Version$version.string
if(R.Version$version.string != "R version 4.0.4 (2021-02-15)"){print("WRONG VERSION OF R. SWITCH TO R version 4.0.4 (2021-02-15)")}else{print("You are running the correct version of R")}

# # First time? Load packages that are the same as the ones downloaded to run this project. 
# install.packages('checkpoint', repos='http://cran.us.r-project.org')
library(checkpoint)
checkpoint::setSnapshot("2021-07-13")

# install.packages("ape", type = "source")
# install.packages("beepr", type = "source")
# install.packages("boot", type = "source")
# install.packages("caper", type = "source")
# install.packages("car", type = "source")
# install.packages("dplyr", type = "source")
# install.packages("gtools", type = "source")
# install.packages("knitr", type = "source")
# install.packages("lattice", type = "source")
# install.packages("lme4", type = "source")
# install.packages("lmtest", type = "source")
# install.packages("maps", type = "source")
# install.packages("MCMCglmm", type = "source")
# install.packages("MuMIn", type = "source")
# install.packages("phylolm", type = "source")
# install.packages("phytools", type = "source")
# install.packages("rotl", type = "source")
# install.packages("tidyverse", type = "source")

# Load Packages
library(caper)
library(car)
library(phylolm)
library(lmtest)
library(phytools) # used for 'read.tree'
library(boot)
library(lme4)
library(gtools)
library(ape)
library(MCMCglmm)
library(MuMIn)
library(tidyverse)
library(beepr)
library(ggplot2)

`%notin%` <- Negate(`%in%`) # Add this function!

# pin is used to calculate standard errors for phylogenetic heritability in PMM
# using the 'delta' method, as in pin files for stand-alone ASReml
# http://www.homepages.ed.ac.uk/iwhite/asreml/
# http://www.homepages.ed.ac.uk/iwhite/asreml/uop
# http://www.vsni.co.uk/forum/viewtopic.php?t=660

options(scipen=999, digits = 3)

```

Figure 2. Age-specific weighted mean frequency of occurrence of plastic ingestion (± weighted variation) for species where both nest-bound and adult birds have been sampled (n = 23). The three species where both adults and nest-bound birds are well-studied (Black-footed Albatross, Flesh-footed Shearwater, Wedge-tailed Shearwater) illustrate the age-specific disparity in susceptibility to plastic ingestion, with younger birds of many species having a higher frequency. Well-studied species are defined as those with ≥ 100 birds sampled across ≥ 3 records (i.e., 3 different studies, sampling locations, and/or years). 
 **must save this figure manually - suggest 550x900**
 
```{r Explore.DataS5.FO.Summary.AGE-SPECIFIC.subsets(not.incl.mixed.ageclasses)}

# Load 
summary.complete2.age <- read.csv("./supplementary material/Data S5. Age-specific weighted mean frequency of occurrence of plastic ingestion and summary study information for studied seabird species (n = 189).csv", strip.white = FALSE, blank.lines.skip = TRUE, stringsAsFactors = TRUE)

# Recall thresholds to identify susceptibility & how well sampled species are 
  high.FO.threshold <- 0.5
  low.FO.threshold <- 0.1
  good.sample.size <- 100
  not.sampled <- 0
  high.records <- 3
  
  print(paste0("high.FO.threshold: ",high.FO.threshold,", / low.FO.threshold: ",low.FO.threshold,", / good.sample.size: ",good.sample.size,", / not.sampled: ",not.sampled,", high.records: ",high.records)) 
    # [1] "high.FO.threshold: 0.5, low.FO.threshold: 0.1, good.sample.size: 100, not.sampled: 0, high.records: 3"

#### For the sake of Figure 2, define the subset of species that have age classes (only considering adult, subadult and nest-bound, n = 141) that are: 
# (1) well studied and are apparently susceptible to plastic ingestion
# (2) well studied and apparently avoid plastic ignestion and 
# (3) overlooked by plastic ingestion research to date = no studies 
  
summary.complete2.age <- summary.complete2.age %>%
  filter(Age.Class %in% c("Adult","Nest-bound")) %>%
  arrange(Common.name_BirdTree) %>%
  droplevels()
  
# WELL STUDIED SUBSET
    well.studied.sps <- summary.complete2.age %>%
    filter(well.studied == "Yes") %>%
    arrange(Common.name_BirdTree) %>%
    droplevels()
  
    well.studied.species <- unique(well.studied.sps$TipLabel_BirdTree)
    well.studied.common <- unique(well.studied.sps$Common.name_BirdTree)
    length(well.studied.species) #24.  
    
    well.studied.species
      #  [1] "Aethia_cristatella"         "Aethia_psittacula"          "Aethia_pygmaea"             "Alle_alle"                  "Calonectris_diomedea"       "Daption_capense"           
      #  [7] "Fulmarus_glacialis"         "Oceanites_oceanicus"        "Oceanodroma_leucorhoa"      "Phoebastria_immutabilis"    "Phoebastria_nigripes"       "Procellaria_aequinoctialis"
      # [13] "Puffinus_carneipes"         "Puffinus_gravis"            "Puffinus_griseus"           "Puffinus_pacificus"         "Puffinus_tenuirostris"      "Somateria_mollissima"      
      # [19] "Spheniscus_magellanicus"    "Sula_dactylatra"            "Thalassarche_bulleri"       "Thalassarche_salvini"       "Uria_aalge"                 "Uria_lomvia"    
    
    well.studied.common
        # [1] Black-footed Albatross  Buller's Albatross      Cape Petrel             Common Eider            Common Murre            Crested Auklet          Flesh-footed Shearwater
        #  [8] Great Shearwater        Laysan Albatross        Leach's Storm-petrel    Little Auk              Magellanic Penguin      Masked Booby            Northern Fulmar        
        # [15] Parakeet Auklet         Salvin's Albatross      Scopoli's Shearwater    Short-tailed Shearwater Sooty Shearwater        Thick-billed Murre      Wedge-tailed Shearwater
        # [22] Whiskered Auklet        White-chinned Petrel    Wilson's Storm-petrel  

  
# SUSCEPTIBLE & WELL STUDIED
      susceptible.well.studied <- summary.complete2.age %>%
        filter(well.studied == "Yes") %>%
        filter(susceptibility == "susceptible") %>%
        arrange(Common.name_BirdTree) %>%
        droplevels()
      
      susceptible.well.studied.common <- unique(susceptible.well.studied$Common.name_BirdTree)
      susceptible.well.studied.species <- unique(susceptible.well.studied$TipLabel_BirdTree)
    
      length(susceptible.well.studied.species) # 6
      
      susceptible.well.studied.common
     # Black-footed Albatross Flesh-footed Shearwater Great Shearwater Laysan Albatross Northern Fulmar Short-tailed Shearwater
    
      susceptible.well.studied.species
    # Phoebastria_nigripes    Puffinus_carneipes      Puffinus_gravis         Phoebastria_immutabilis Fulmarus_glacialis      Puffinus_tenuirostris
      
            # what is the IUCN status of these species?
            iucn<-data2 %>%
                dplyr::select(TipLabel_BirdTree, Common.name_BirdTree, X2019.IUCN.Red.List.category) %>%
                distinct() %>%
                filter(Common.name_BirdTree %in% susceptible.well.studied.common) %>%
                droplevels()
            
            iucn
            #                 TipLabel_BirdTree    Common.name_BirdTree X2019.IUCN.Red.List.category
            # 1    Phoebastria_nigripes  Black-footed Albatross                           NT
            # 2      Puffinus_carneipes Flesh-footed Shearwater                           NT
            # 3         Puffinus_gravis        Great Shearwater                           LC
            # 4 Phoebastria_immutabilis        Laysan Albatross                           NT
            # 5      Fulmarus_glacialis         Northern Fulmar                           LC
            # 6   Puffinus_tenuirostris Short-tailed Shearwater                           LC


# NOT SUSCEPTIBLE & WELL STUDIED
        NOT.susceptible.well.studied <- summary.complete2.age %>%
        filter(well.studied == "Yes") %>%
        filter(susceptibility == "not susceptible") %>% 
        arrange(Common.name_BirdTree) %>%
        droplevels()
    
      NOT.susceptible.well.studied.common <- unique(NOT.susceptible.well.studied$Common.name_BirdTree)
      NOT.susceptible.well.studied.species <- unique(NOT.susceptible.well.studied$TipLabel_BirdTree)
    
      length(NOT.susceptible.well.studied.species) #10
        
      NOT.susceptible.well.studied.species
      #  [1] Thalassarche_bulleri       Somateria_mollissima       Uria_aalge                 Aethia_cristatella         Sula_dactylatra            Aethia_psittacula         
      #  [7] Thalassarche_salvini       Uria_lomvia                Aethia_pygmaea             Procellaria_aequinoctialis             
      
        
      NOT.susceptible.well.studied.common
      # [1] Buller's Albatross   Common Eider         Common Murre         Crested Auklet       Masked Booby         Parakeet Auklet      Salvin's Albatross   Thick-billed Murre  
      #  [9] Whiskered Auklet     White-chinned Petrel 

    
print(paste0("We present weighted mean FO for all studied species (n = ",length(levels(summary.complete2.age$TipLabel_BirdTree)),", Data S4). The same is presented for each species and age class (i.e., Nest-bound, Subadult, Adult, not including combination age class categories (i.e., Adult/Subadult, Mixed; Data S5), highlighting those that are well studied (n = ",length(levels(summary.complete2.age$TipLabel_BirdTree)),"). Well studied species are defined as those with  ≥",good.sample.size," birds sampled across ≥",high.records,", records (i.e., ",high.records," different studies, sampling locations, and/or years). For well studied species, we identify species that are susceptible to ingesting plastic as those where mean FO ≥",high.FO.threshold," for any age class. There are ",length(well.studied.species)," seabird species that qualify as having one or more well studied age class,  ", length(susceptible.well.studied.species)," species from the Order Procellariiformes that we classified as having one or more age classes that are suceptible to ingesting plastic (LIST SPECIES from susceptible.well.studied: Black-footed Albatross (Phoebastria_nigripes), Flesh-footed Shearwater (Puffinus_carneipes), Great Shearwater (Puffinus_gravis), Laysan Albatross (Phoebastria_immutabilis), Northern Fulmar (Fulmarus_glacialis), Short-tailed Shearwaterr (Puffinus_tenuirostris)), and ",length(NOT.susceptible.well.studied.species)," species that are apparently not susceptible to plastic ingestion (LIST SPECIES from NOT.susceptible.well.studied: Buller's Albatross (Thalassarche_bulleri),Common Eider (Somateria_mollissima), Common Murre (Uria_aalge), Crested Auklet (Aethia_cristatella), Masked Booby (Sula_dactylatra), Parakeet Auklet (Aethia_psittacula), Salvin's Albatross (Thalassarche_salvini),  Thick-billed Murre (Uria_lomvia), Whiskered Auklet (Aethia_pygmaea), White-chinned Petrel (Procellaria_aequinoctialis)).")) 

# As of 2021-08-05 # "We present weighted mean FO for all studied species (n = 212, Data S4). The same is presented for each species and age class (i.e., Nest-bound, Subadult, Adult, not including combination age class categories (i.e., Adult/Subadult, Mixed; Data S5), highlighting those that are well studied (n = 141). Well studied species are defined as those with  ≥100 birds sampled across ≥3, records (i.e., 3 different studies, sampling locations, and/or years). For well studied species, we identify species that are susceptible to ingesting plastic as those where mean FO ≥0.5 for any age class. There are 24 seabird species that qualify as having one or more well studied age class,  6 species from the Order Procellariiformes that we classified as having one or more age classes that are suceptible to ingesting plastic (LIST SPECIES from susceptible.well.studied: Black-footed Albatross (Phoebastria_nigripes), Flesh-footed Shearwater (Puffinus_carneipes), Great Shearwater (Puffinus_gravis), Laysan Albatross (Phoebastria_immutabilis), Northern Fulmar (Fulmarus_glacialis), Short-tailed Shearwaterr (Puffinus_tenuirostris)), and 10 species that are apparently not susceptible to plastic ingestion (LIST SPECIES from NOT.susceptible.well.studied: Buller's Albatross (Thalassarche_bulleri), Common Eider (Somateria_mollissima), Common Murre (Uria_aalge), Crested Auklet (Aethia_cristatella), Masked Booby (Sula_dactylatra), Parakeet Auklet (Aethia_psittacula), Salvin's Albatross (Thalassarche_salvini),  Thick-billed Murre (Uria_lomvia), Whiskered Auklet (Aethia_pygmaea), White-chinned Petrel (Procellaria_aequinoctialis))."

```

```{r Figure2_facet.grob.plot.DataS5.FO.Summary.AGE-SPECIFIC}

# Load Data S5
summary.complete2.age <- read.csv("./supplementary material/Data S5. Age-specific weighted mean frequency of occurrence of plastic ingestion and summary study information for studied seabird species (n = 189).csv", strip.white = FALSE, blank.lines.skip = TRUE, stringsAsFactors = TRUE)

# This plot prints to console - printing straight to PDF causes issues.

# Identify species with Nest-bound AND Adult data for figure 
age.subset <- summary.complete2.age %>% 
  filter(Age.Class %in% c("Nest-bound", "Adult")) %>%
  # filter(well.studied == "Yes") %>%
  # dplyr::select(Common.name_BirdTree) %>%
  group_by(TipLabel_BirdTree) %>%
  dplyr::mutate(n_distinct = n_distinct(Age.Class)) %>%
  filter(n_distinct == 2) %>%
  arrange(Order, Common.name_BirdTree) %>%
  droplevels()

age.comparison.common <- levels(age.subset$Common.name_BirdTree)
length(age.comparison.common) # 23

age.comparison.common
#  [1] "Atlantic Puffin"         "Black-footed Albatross"  "Brown Noddy"             "Common White Tern"       "Flesh-footed Shearwater" "Grey-backed Tern"        "Laysan Albatross"       
#  [8] "Leach's Storm-petrel"    "Masked Booby"            "Northern Fulmar"         "Providence Petrel"       "Red-footed Booby"        "Red-tailed Tropicbird"   "Scopoli's Shearwater"   
# [15] "Short-tailed Shearwater" "Shy Albatross"           "Sooty Tern"              "Southern Giant Petrel"   "Tristram's Storm-petrel" "Wandering Albatross"     "Wedge-tailed Shearwater"
# [22] "White-chinned Petrel"    "Wilson's Storm-petrel"

# Plot a subset of wtd.mean.FO +/- wtd.var.FO horizontally, and label as priority or not
# priority == < 100 samples, and FO > 0.50
      df <- summary.complete2.age %>% 
              filter(Common.name_BirdTree %in% age.comparison.common) %>%
              filter(Age.Class %in% c("Nest-bound", "Adult")) %>%
              # filter(well.studied == "Yes") %>%
              arrange(Order, Common.name_BirdTree) %>%
              mutate(Order = str_to_title(Order)) %>%
              droplevels()
    
      dim(df) # 46 24
      head(df)
       
      
      # As Factor
      df$Age.Class <- as.factor(df$Age.Class)
      df$well.studied <- as.factor(df$well.studied)
      df$Order<- as.factor(df$Order)
      df$susceptibility    <- as.factor(df$susceptibility)

    # Set up alphabetical sps names for plotting
      class(df$Common.name_BirdTree)
      level_order <- (levels(as.factor(df$Common.name_BirdTree)))
      level_order <- as.data.frame(level_order)
      level_order <- level_order %>%  arrange(desc(level_order))
      level_order <- as.vector(level_order$level_order)
      
      df$Order <- factor(df$Order, levels= c("Anseriformes", "Charadriiformes", "Phaethontiformes", "Gaviiformes", "Pelecaniformes","Suliformes", "Sphenisciformes", "Procellariiformes" ))
      df$susceptibility <- factor(df$susceptibility, levels= c("not susceptible", "intermediate", "susceptible"))
      df$well.studied <- factor(df$well.studied, levels= c("Yes", "No", NA))
      df$Age.Class <- factor(df$Age.Class, levels= c("Adult", "Nest-bound"))

    # for putting facet labels on top using grob https://stackoverflow.com/questions/28093412/labels-on-top-with-facet-grid-or-space-option-with-facet-wrap
    library(plyr)
    library(grid)
    
    # for highlighting axis label  text https://newbedev.com/apply-bold-font-on-specific-axis-ticks # couldn't get this to work. 
    # specify which species we want to highlight
    df$Common.name_BirdTree <- as.factor(df)
    bold.species <- c("Black-footed Albatross", "Flesh-footed Shearwater", "Wedge-tailed Shearwater")
    bold.labels <- ifelse(levels(df$Common.name_BirdTree %in% bold.species, yes = "bold", no = "plain"))
    library(ggtext) # for highlighting axis label text
    library(glue) # for highlighting axis label  text
    # highlight = function(x, pat, color="black", family="") { 
    #   ifelse(grepl(pat, x), glue("<b style='font-family:{family}; color:{color}'>{x}</b>"), x)
    # }

# Plot

p1 <-ggplot(df, aes(x = factor(Common.name_BirdTree, levels = level_order), y = wtd.mean.FO, color = Age.Class)) +
    geom_point(size = 2, aes(colour = Age.Class, shape = well.studied), position = position_dodge(width = .75))+
    scale_colour_manual(values=c('#73D055FF', "#440154FF")) + #73D055FF', '#2D708EFF', "#39568CFF","#482677FF","#440154FF"
    scale_shape_manual(values=c(16,1)) +
    geom_errorbar(aes(ymin = (wtd.mean.FO-wtd.var.FO), ymax = (wtd.mean.FO+wtd.var.FO)), 
                  position = position_dodge(width = .75))+
        theme_bw() +
    coord_flip() +
    facet_wrap(~ Order,
               scales = "free_y",
               ncol = 1
               ) +
    theme(strip.text.y = element_blank()) +
    theme(strip.background = element_rect(fill="white")) +
    theme(strip.text = element_text(colour = 'black')) +
    theme(legend.position = "bottom",
          legend.direction = "horizontal",
          legend.box = "vertical",
          legend.justification = "left",
          legend.box.just = "left",
          legend.margin = margin(6, 6, 6, 6),
          # legend.box.background = element_rect(),
          legend.text = element_text(size=10),
          legend.title = element_text(size = 10)) +
    theme(axis.title.x = element_text(size=10), 
          axis.title.y = element_text(size=10), 
          axis.text.x = element_text(size= 10), # face=ifelse(levels(df$well.studied == "well studied", "bold","italic"))
          axis.text.y = element_text(size= 10)) +
    labs(
        y = "Weighted mean frequency of occurrence of plastic ingestion \n (± weighted variance)",
        x = "",
        colour = "Age class",
        shape = paste0("Well studied")) # +
    # scale_x_discrete(labels = c("Atlantic Puffin",
                                # "Brown Noddy",             
                                # "Common White Tern",       
                                # "Grey-backed Tern",
                                # "Sooty Tern",
                                # "Red-tailed Tropicbird",
                                # "Masked Booby",
                                # "Red-footed Booby",
                                # expression(bold("Black-footed Albatross")),
                                # expression(bold("Flesh-footed Shearwater")),
                                # "Laysan Albatross",
                                # "Leach's Storm-petrel",
                                # "Northern Fulmar",
                                # "Providence Petrel",   
                                # "Scopoli's Shearwater",
                                # "Short-tailed Shearwater",
                                # "Shy Albatross",
                                # "Southern Giant Petrel",
                                # "Tristram's Storm-petrel",
                                # "Wandering Albatross",
                                #  expression(bold("Wedge-tailed Shearwater")),
                                # "White-chinned Petrel",
                                # "Wilson's Storm-petrel"
                                #  )) 

p1 # < haven't resized the facets yet

# Generate a ggplot2 plot grob.
g1 = ggplotGrob(p1) 

# Get the items in the g1 layout corresponding to the panels to get the number of 'items' for each 'label'.
N = dlply(df, .(Order), function(x) length(row.names(x)))
panels1 <- g1$layout$t[grepl("panel", g1$layout$name)]
panels1
# [1]  8 13 18 23

g1$heights[[8]] = unit(5, "null")
g1$heights[[13]] = unit(1, "null")
g1$heights[[18]] = unit(2, "null")
g1$heights[[23]] = unit(15, "null")

# Replace the default panel heights with relative heights
g1$heights[panels1] <- unit(N, "null")

# This function erases the current device or moves to a new page.
grid.newpage()
# Produces graphical output from a graphical object.
grid.draw(g1)

```

Figure 1. Weighted mean frequency of occurrence (FO) of plastic ingestion for the 212 studied seabird species. Phylogenetic heritability was high in our results. This indicates that closely related species are more likely to have similar FO of plastic ingestion than species drawn at random from the phylogenetic tree. 
  **dev.off()**

```{r Figure1.Phyloplas.wtd.mean.FO.212.of.351.sps}

# Load dataset with weighted species-level mean FOs (species level estimate of FO is average of FOs, weighted by sample size for each study)
    df <- read.csv("./supplementary material/Data S4. Weighted mean frequency of occurrence of plastic ingestion and summary data for studied seabird species (n = 212).csv")
    tree <- read.tree("./output/ConsensusTree_seabird_matched.phy") 
    
plot.pdf <- TRUE # If this is TRUE plot won't show in console.

if(plot.pdf == TRUE){
    # pdf(file = paste0("./figs_tables/PHYLOPLAS.Predicted__Figure_",Sys.Date(),".pdf"),
    pdf(file = "./figs_tables/Figure 1. Weighted mean frequency of occurrence (FO) of plastic ingestion for the 212 studied seabird species.pdf",
        height = 25,
        width = 25,
        paper = "USr") #a4r
}
par(ps = 12, cex = 1, cex.main = 1)


# tree.all <- read.tree("./output/ConsensusTree_seabird_matched.phy")
plot.tree <- compute.brlen(tree, method = "Grafen", power = 1/2)
plot.tree <- ladderize(plot.tree, right = TRUE)

# This read/write stage is essential to getting the bars to line up with the tree & labels
write.tree(plot.tree, "Plotting - tree.phy") 
plot.tree <- read.tree("Plotting - tree.phy")

treeheight <- max(nodeHeights(plot.tree))

df<- mutate(df, Order = str_to_upper(Order))

plot.data_predictions <- df %>%
      mutate(TipLabel = TipLabel_BirdTree,
             N = 1, 
             mean = wtd.mean.FO,
             sd = round(wtd.var.FO,2),
             se = round(wtd.var.FO,2)) %>%
      dplyr::select(TipLabel_BirdTree, N, mean, sd, se, Order) %>%
      mutate(Order = as.character(Order)) %>% # Order.title = as.character(Order.title), 
      arrange(TipLabel_BirdTree)

head(plot.data_predictions)

row.names(plot.data_predictions) <- plot.data_predictions$TipLabel_BirdTree

# View(plot.data_predictions)
# str(plot.data_predictions)

plot.data<- plot.data_predictions

# plot.data$Order <- NA

# for(i in 1:nrow(plot.data)){
# plot.data$Order[i] <- as.character(data.2$Order[data.2$TipLabel_BirdTree == plot.data$TipLabel_BirdTree[i]][1])
# }
# row.names(plot.data) <- as.character(plot.data$TipLabel_BirdTree)

#Species missing from the tree
plot.data <- droplevels(plot.data)
plot.data$TipLabel_BirdTree <- as.factor(plot.data$TipLabel_BirdTree)
species.list <- unique(plot.data$TipLabel_BirdTree)
species.list[!species.list %in% plot.tree$tip.label]

#Remove tips for species that are not in the data set for plotting
plot.tree <- drop.tip(plot.tree, tip = plot.tree$tip.label[!plot.tree$tip.label %in% plot.data$TipLabel_BirdTree])
plot.data <- plot.data[plot.tree$tip.label,] # This breaks it


### Set up the colours for the plots and tree branches

# Mimicing viridis colour palette for colour blindness
# https://www.thinkingondata.com/something-about-viridis-library/
col.PROCELLARIIFORMES <- "#440154FF" # purple 481567FF
col.SPHENISCIFORMES <- "#453781FF" # purple blue
col.SULIFORMES <- "#39568CFF" # blue
col.PELECANIFORMES <- "#2D708EFF" # dark teal
col.GAVIIFORMES <- "#1F968BFF" # teal
col.PHAETHONTIFORMES <- "#3CBB75FF" # grean-teal
col.CHARADRIIFORMES <- "#73D055FF" # green
col.ANSERIFORMES <- "#DCE319FF" # yellow  copy this to line 557 otherwise one branch is pink clcolr[all]   

col.significant <- "black"
col.not.significant <- "grey50"

tree.plot.colours <- data.frame(c(col.ANSERIFORMES, col.CHARADRIIFORMES, col.GAVIIFORMES,
                                  col.PHAETHONTIFORMES, col.PROCELLARIIFORMES, col.SPHENISCIFORMES, col.SULIFORMES, col.PELECANIFORMES))

row.names(tree.plot.colours) <- c("ANSERIFORMES", "CHARADRIIFORMES", "GAVIIFORMES", 
                                  "PHAETHONTIFORMES", "PROCELLARIIFORMES", "SPHENISCIFORMES",
                                  "SULIFORMES", "PELECANIFORMES")

plot.data$col <- NA
plot.data$col[plot.data$Order == "ANSERIFORMES"] <- col.ANSERIFORMES
plot.data$col[plot.data$Order == "CHARADRIIFORMES"] <- col.CHARADRIIFORMES
plot.data$col[plot.data$Order == "GAVIIFORMES"] <- col.GAVIIFORMES
plot.data$col[plot.data$Order == "PHAETHONTIFORMES"] <- col.PHAETHONTIFORMES
plot.data$col[plot.data$Order == "PROCELLARIIFORMES"] <- col.PROCELLARIIFORMES
plot.data$col[plot.data$Order == "SPHENISCIFORMES"] <- col.SPHENISCIFORMES
plot.data$col[plot.data$Order == "SULIFORMES"] <- col.SULIFORMES
plot.data$col[plot.data$Order == "PELECANIFORMES"] <- col.PELECANIFORMES

col1 <- plot.data$col

head(plot.tree$tip.label)
head(plot.data)

tree.angle <- 270
tree.start <- 180 #0 in North, 180 is south (this bit doesn't work yet)

#Get the colours

  ANSERIFORMES_edge      <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "ANSERIFORMES")))
  CHARADRIIFORMES_edge   <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "CHARADRIIFORMES")))
  GAVIIFORMES_edge       <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "GAVIIFORMES")))
  PHAETHONTIFORMES_edge  <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "PHAETHONTIFORMES")))
  PROCELLARIIFORMES_edge <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "PROCELLARIIFORMES")))
  SPHENISCIFORMES_edge   <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "SPHENISCIFORMES")))
  SULIFORMES_edge        <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "SULIFORMES")))
  PELECANIFORMES_edge    <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "PELECANIFORMES")))
  all                    <- which.edge(plot.tree, group = row.names(plot.data))
  
  ANSERIFORMES_edge      <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "ANSERIFORMES")))
  CHARADRIIFORMES_edge   <- which.edge(plot.tree, group = row.names(subset(plot.data, Order != "ANSERIFORMES")))
  PHAETHONTIFORMES_edge  <- which.edge(plot.tree, group = row.names(subset(plot.data, !(Order == "CHARADRIIFORMES" | Order == "ANSERIFORMES"))))
  GAVIIFORMES_edge       <- which.edge(plot.tree, group = row.names(subset(plot.data, !(Order == "ANSERIFORMES" | Order == "CHARADRIIFORMES" | 
                                                                                            Order == "PHAETHONTIFORMES"))))
  PELECANIFORMES_edge    <- which.edge(plot.tree, group = row.names(subset(plot.data, !(Order == "ANSERIFORMES" | Order == "CHARADRIIFORMES" | 
                                                                                            Order == "PHAETHONTIFORMES" | Order == "GAVIIFORMES"))))
  SULIFORMES_edge        <- which.edge(plot.tree, group = row.names(subset(plot.data, !(Order == "ANSERIFORMES" | Order == "CHARADRIIFORMES" | 
                                                                                            Order == "PHAETHONTIFORMES" | Order == "GAVIIFORMES" | 
                                                                                            Order == "PELECANIFORMES"))))
  SPHENISCIFORMES_edge   <- which.edge(plot.tree, group = row.names(subset(plot.data, !(Order == "ANSERIFORMES" | Order == "CHARADRIIFORMES" | 
                                                                                            Order == "PHAETHONTIFORMES" | Order == "GAVIIFORMES" | 
                                                                                            Order == "PELECANIFORMES" | Order == "SULIFORMES"))))
  PROCELLARIIFORMES_edge <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "PROCELLARIIFORMES")))

#Colours for the tree
  
  #vector as long as the first edge column and populating it with the colour for insects
  clcolr<-rep(as.character(tree.plot.colours["ANSERIFORMES",]), dim(plot.tree$edge)[1]) 
  # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
  clcolr[all]    <- as.character(tree.plot.colours["ANSERIFORMES",])   
  clcolr[ANSERIFORMES_edge]      <-as.character(tree.plot.colours["ANSERIFORMES",])   
  clcolr[CHARADRIIFORMES_edge]   <-as.character(tree.plot.colours["CHARADRIIFORMES",])  
  clcolr[PHAETHONTIFORMES_edge]  <-as.character(tree.plot.colours["PHAETHONTIFORMES",])   
  clcolr[GAVIIFORMES_edge]       <-as.character(tree.plot.colours["GAVIIFORMES",])   
  clcolr[PELECANIFORMES_edge]    <-as.character(tree.plot.colours["PELECANIFORMES",])   
  clcolr[SULIFORMES_edge]        <-as.character(tree.plot.colours["SULIFORMES",])   
  clcolr[SPHENISCIFORMES_edge]   <- as.character(tree.plot.colours["SPHENISCIFORMES",]) 
  clcolr[PROCELLARIIFORMES_edge] <-as.character(tree.plot.colours["PROCELLARIIFORMES",]) 

### Draw Tree - Tiplabels are offset to allow for the polygon
  par(mar = c(5,5,5,5) + 1, xpd = NA)

# (phylo.plot is from ape package)
plot(plot.tree, type = "fan", open.angle = 360 - tree.angle, rotate = 270, 
     root.edge = TRUE, 
     show.tip.label = T, label.offset = .36, cex = 0.45, tip.color = col1, # careful balance between edge width and cex to make sure labels are visable
     edge.width = 1.5,
     x.lim = c(-1 * treeheight, 1.2 * treeheight), 
     y.lim = c(-1 * treeheight, 1.2 * treeheight), 
     edge.color = clcolr)

### Draw Prediction bars, background and labels

# Draw background
  theta.start <- -0.5*(pi/180)*tree.angle/nrow(plot.data) + (pi/180)*tree.start
  theta.subtend <- abs(2*theta.start)
  
  bar.scale <- 0.3 # Multiplication factor for the bars
  bar.offset <- 0.03 #Offset to add white space between the bars and the tree, to separate the colours
  
  x.bg       <- sin(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset)
  y.bg       <- cos(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset)
  x.bg.outer <- sin(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (bar.scale*treeheight))
  y.bg.outer <- cos(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (bar.scale*treeheight))
  x.0.25     <- sin(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.25*bar.scale*treeheight))
  y.0.25     <- cos(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.25*bar.scale*treeheight))
  x.0.5      <- sin(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.5*bar.scale*treeheight))
  y.0.5      <- cos(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.5*bar.scale*treeheight))
  x.0.75     <- sin(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.75*bar.scale*treeheight))
  y.0.75     <- cos(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.75*bar.scale*treeheight))

#par(mfrow = c(1,1), mar = c(4,4,0,0)+0.5)
#plot(y.bg.outer ~ x.bg.outer, type = "n")
  polygon(x = c(x.bg, rev(x.bg.outer)),
          y = c(y.bg, rev(y.bg.outer)),
          col = "grey93", border = "grey93") # This could also be "dark grey" 
  
  lines(y.0.25 ~ x.0.25, col = "black", lwd = 1.5) # This could also be "white"
  lines(y.0.5 ~ x.0.5, col = "black", lwd = 1.5)
  lines(y.0.75 ~ x.0.75, col = "black", lwd = 1.5)
  
  theta.start+c(1:nrow(plot.data))*theta.subtend


# Bars    
  temp.x <- NA
  temp.y <- NA
  temp.theta <- NA
  for(i in 1:nrow(plot.data)){
      #outer layer first
      theta1 <- theta.start + (i-1)*theta.subtend
      theta2 <- theta1 - theta.subtend
      
      x1 <- sin(theta1)*(treeheight + bar.offset)
      x2 <- sin(theta2)*(treeheight + bar.offset)
      y1 <- cos(theta1)*(treeheight + bar.offset)
      y2 <- cos(theta2)*(treeheight + bar.offset)
      
      temp.theta[i] <- theta1
      temp.x[i] <- x1
      temp.y[i] <- y1
      
      x3 <- sin(theta1)*(treeheight + bar.offset + (bar.scale*treeheight)*(plot.data[i,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))
      x4 <- sin(theta2)*(treeheight + bar.offset + (bar.scale*treeheight)*(plot.data[i,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))
      y3 <- cos(theta1)*(treeheight + bar.offset + (bar.scale*treeheight)*(plot.data[i,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))
      y4 <- cos(theta2)*(treeheight + bar.offset + (bar.scale*treeheight)*(plot.data[i,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))
      
      x5 <- sin(theta1)*(treeheight + bar.offset + (bar.scale*treeheight))
      x6 <- sin(theta2)*(treeheight + bar.offset + (bar.scale*treeheight))
      y5 <- cos(theta1)*(treeheight + bar.offset + (bar.scale*treeheight))
      y6 <- cos(theta2)*(treeheight + bar.offset + (bar.scale*treeheight))
 
      polygon(c(x1,x2,x4,x3),
              c(y1,y2,y4,y3),
              #col = "darkorange", border = "darkorange",
              col = col1[i], border = col1[i])
      }


### Add scales

# Upper
lines(y = rep(-0*bar.offset,2), 
      x = c(-1*(treeheight+bar.offset), 
            -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1)
lines(y = c(-0*bar.offset,-1*bar.offset), 
      x = c(-1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
            -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1)
lines(y = c(-0*bar.offset,-1*bar.offset), 
      x = c(-1*(treeheight+bar.offset+(0.5*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
            -1*(treeheight+bar.offset+(0.5*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1)
lines(y = c(-0*bar.offset,-1*bar.offset), 
      x = c(-1*(treeheight+bar.offset+(0.25*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
            -1*(treeheight+bar.offset+(0.25*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1)
lines(y = c(-0*bar.offset,-1*bar.offset), 
      x = c(-1*(treeheight+bar.offset+(0.75*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
            -1*(treeheight+bar.offset+(0.75*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1)
lines(y = c(-0*bar.offset,-1*bar.offset), 
      x = c(-1*(treeheight+bar.offset), 
            -1*(treeheight+bar.offset)),
      lwd = 1)

text(y = -1.5*bar.offset,
     x = c(-1*(treeheight+bar.offset), 
           -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))))[1],
     labels = "0",
     #labels = expression(bold("Does not ingest plastic")),
     cex = .8,
     pos = 1)
text(y = -1.5*bar.offset,
     x = c(-1*(treeheight+bar.offset), 
           -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))))[2],
     #labels = expression(bold("Ingests plastic")),
     labels = "1",
     cex = .8,
     pos = 1)

# Lower
lines(x = rep(-1*bar.offset,2), 
      y = c(-1*(treeheight+bar.offset), 
            -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1)
lines(x = c(-2*bar.offset,-1*bar.offset), 
      y = c(-1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
            -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1)
lines(x = c(-2*bar.offset,-1*bar.offset), 
      y = c(-1*(treeheight+bar.offset+(0.25*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
            -1*(treeheight+bar.offset+(0.25*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1)
lines(x = c(-2*bar.offset,-1*bar.offset), 
      y = c(-1*(treeheight+bar.offset+(0.5*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
            -1*(treeheight+bar.offset+(0.5*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1)
lines(x = c(-2*bar.offset,-1*bar.offset), 
      y = c(-1*(treeheight+bar.offset+(0.75*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
            -1*(treeheight+bar.offset+(0.75*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1)
lines(x = c(-2*bar.offset,-1*bar.offset), 
      y = c(-1*(treeheight+bar.offset), 
            -1*(treeheight+bar.offset)),
      lwd = 1)

text(x = -1.5*bar.offset,
     y = c(-1*(treeheight+bar.offset), 
           -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))))[1],
     labels = "0",
     # labels = expression(bold("Does not ingest plastic")),
     cex = .7,
     pos = 2)

text(x = -1.5*bar.offset,
     y = c(-1*(treeheight+bar.offset), 
           -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))))[2],
     # labels = expression(bold("Ingests plastic")),
     labels = "1",
     cex = .7,
     pos = 2)


text(x = -4*bar.offset,
     y = -1*(treeheight+bar.offset+0.15*(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))),
     labels = expression("Weighted mean"),
     cex = .7,
     pos = 2)
text(x = -4*bar.offset,
     y = -1*(treeheight+bar.offset+0.5*(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))),
     labels = expression("frequency of occurrence"),
     cex = .7,
     pos = 2)
text(x = -4*bar.offset,
     y = -1*(treeheight+bar.offset+0.85*(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))),
     labels = expression("of plastic ingestion"),
     cex = .7,
     pos = 2)


# Add legend            
legend("bottomleft",
       legend =c('Anseriformes', 'Charadriiformes', 'Phaethontiformes', 'Gaviiformes', 'Pelecaniformes', 'Suliformes', 'Sphenisciformes', 'Procellariiformes'),
       pch=16, pt.cex=1.5, cex = .7, bty='n',
       col = c('#DCE319FF', '#73D055FF', '#3CBB75FF', '#1F968BFF', '#2D708EFF', "#39568CFF","#482677FF","#440154FF"),
       title = "Order", title.adj = 0.1)

if(plot.pdf == TRUE){
    dev.off()
    system2(command = "open", args = paste0("./figs_tables/Figure 1. Weighted mean frequency of occurrence (FO) of plastic ingestion for the 212 studied seabird species",".pdf"), wait = FALSE)
}


REFERENCES

# plot phylo tree
# <http://blog.phytools.org/2014/05/plotting-bars-at-tips-of-circular-tree.html>

# ggplot element options
# <https://rstudio-pubs-static.s3.amazonaws.com/3364_d1a578f521174152b46b19d0c83cbe7e.html>

# Define customizxed order for non-alphabetic factor levels (IUCN.Status) for use in ggplot aes REF1 <https://stackoverflow.com/questions/12774210/how-do-you-specifically-order-ggplot2-x-axis-nstead-of-alphabetical-order>

# Grid Arrangement - using gridExtra
# <http://www.sthda.com/english/wiki/wiki.php?id_contents=7930>

```

# End
