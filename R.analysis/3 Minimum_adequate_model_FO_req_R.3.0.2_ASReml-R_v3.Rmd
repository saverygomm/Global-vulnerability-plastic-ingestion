---
title: "Avery-Gomm et al. (TBD) Global seabird plastic ingestion vulnerability predicted using life history and phylogeny"
authors: "Stephanie Avery-Gomm, Craig White"
date: '2019-04-19'
---

The purpose of this code is to re-run "Analysis of empirical data: evaluation of traits associated with plastic ingestion". 

This phylogenetic mixed model is implemented using the asreml package (ASReml-R v3) to identify the minimum adequate model, and identify the underlying determinants of observed frequency of occurrence of plastic ingestion in the 209 seabird species for which plastic ingestion data exists. A subscription to download the ASreml-R package can be purchased here: https://www.vsni.co.uk/software/asreml-r/.

If you do not have access to a subscription of ASReml-R V3, or if you do not want to rerun the models, move on to script "./R.analysis/4 Predicting_FO_req_R.3.5.3.Rmd"
1. Close this script 
2. Switch to R 3.5.3
    Helpful notes:
        - https://support.rstudio.com/hc/en-us/articles/200486138-Changing-R-versions-for-RStudio-desktop
        - An application like R Switch is an easy way to swap between versions of R without needing to reinstall and restart your computer)
3. Open "./R.analysis/4 Predicting_FO_req_R.3.5.3.Rmd"


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r initialize}

# Initialize
getwd()

# Initializing
# Clear workspace
rm(list=ls())
gc()

sessionInfo()  # Matches? 

# For asreml chunks: R version 3.0.2 (2013-09-25)
# R version 3.0.2 (2013-09-25)
# Platform: x86_64-apple-darwin10.8.0 (64-bit)
 
# # First time? install. packages.
# Not first time? Load Packages
    library(caper)
    library(car)
    library(phylolm)
    library(lmtest)
    library(boot)
    library(lme4)
    library(gtools)
    library(MuMIn)
    library(beepr) # used to alert when code finished running
    library(dplyr) # req for asreml
    library(lattice) # req for asreml
    library(ape) # req for phytools
    library(maps) # req for phytools
    library(phytools) # used for 'read.tree'
    library(knitr)
    library(MCMCglmm)


`%notin%` <- Negate(`%in%`) # Add this function!

options(scipen=999, digits = 3)

# pin is used to calculate standard errors for phylogenetic heritability in PMM
    # using the 'delta' method, as in pin files for stand-alone ASReml
    # http://www.homepages.ed.ac.uk/iwhite/asreml/
    # http://www.homepages.ed.ac.uk/iwhite/asreml/uop
    # http://www.vsni.co.uk/forum/viewtopic.php?t=660
    pin <- dget("./R.analysis/pin.R")
    

```

```{r setup_questions}

# Setup options

# Phylogenetic treees.
    # Have changes been made to the phylogenetic trees?   
    use.published.phylogenetic.tree <- TRUE  
    # If not, then use.published = TRUE. This loads versions of the phylognetic input files for the asreml analysis.
    # If yes, changes have been made to the phylogenetic trees (not recommended) then use.published = FALSE and new input files for the asreml are created. If chosing this option, run.new.asreml should be set to TRUE.

# Rerunning asreml models?
    run.new.asreml <- FALSE  
    # TRUE will rerun the models and generate the output asreml files for 5 models, which can be explored. 
    # FALSE will load the published models which can be explored at the summary stage.
    
    if(run.new.asreml == TRUE){library(asreml)} 
        # If run.new.asreml == FALSE you do not need to install asreml. This is a subscription only program

# Rerunning asreml analysis with NEW input data?
    use.published.seabird.FOdata <- TRUE 
    # TRUE = The published versions of datanoNA input data will be used for the asreml analysis
    # FALSE = The newly generated (today) versions of datanoNA will be used for the asreml analysis. If not created today, manual changes to specify date of desired file are needed. 

```

This code does not need to be run unless the phylogenetic tree has been redownloaded or the seabird subset of the phylogenetic tree has been changed (i.e., if subset.consensus.tree.phy == FALSE).
```{r asreml_prep_trees_R.3.0.2}

# Confirm R Version = 3.0.2
R.Version<- R.Version()
R.Version$version.string
if(R.Version$version.string != "R version 3.0.2 (2013-09-25)"){print("WRONG VERSION OF R. SWITCH TO R version 3.0.2 (2013-09-25)")}


if(use.published.phylogenetic.tree == TRUE){
    tree.seabird <- read.tree("./output/ConsensusTree_seabird_matched.phy") # This is the published subset of tree.complete based on seabird species names from data 
    tree.complete <- read.tree("./output/ConsensusTree.phy") # This should always be the published version downloaded in 2018. 

    load(file = paste0("./output/asreml.products/tree.seabird.IA_","2018-11-08_PUBLISHED",".RData"))
    load(file = paste0("./output/asreml.products/tree.seabird.IAasreml_","2018-11-08_PUBLISHED",".RData"))
    load(file = paste0("./output/asreml.products/tree.complete.IA_","2018-11-08_PUBLISHED",".RData"))
    load(file = paste0("./output/asreml.products/tree.complete.IAasreml_","2018-11-08_PUBLISHED",".RData"))

    }else{
 
 
# TREES
    
# For a NEW seabird subsetted phylogenetic tree (produced by "subset.consensus.tree.phy_if_TRUE.R") 
    tree.seabird <- read.tree(paste0("./output/ConsensusTree_seabird_matched",Sys.Date(),".phy"))  
    tree.complete <- read.tree("./output/ConsensusTree.phy") # This should always be the published version downloaded in 2018. 
 
    # Make sure nodes in the tree are unique
     tree.seabird$node.label <- as.character(c(1:length(tree.seabird$node.label)))
     
     # Inverse Relatedness Matrix and Phylogenetic Covariance Matrix
        tree.seabird.IA <- MCMCglmm::inverseA(tree.seabird, nodes = "TIPS") 
            # disregard Warning message: In inverseA(tree, nodes = "TIPS") : no branch lengths: compute.brlen from ape has been used
        beep()
        str(tree.seabird.IA)
                    # Published example
                    # List of 7
                    #  $ Ainv      :Formal class 'dgCMatrix' [package "Matrix"] with 6 slots
                    #   .. ..@ i       : int [1:115721] 0 1 2 3 4 5 6 7 8 9 ...
                    #   .. ..@ p       : int [1:352] 0 340 680 1020 1360 1700 2040 2380 2720 3060 ...
                    #   .. ..@ Dim     : int [1:2] 351 351
                    #   .. ..@ Dimnames:List of 2
                    #   .. .. ..$ : chr [1:351] "Larus_cachinnans" "Larus_thayeri" "Larus_glaucescens" "Larus_glaucoides" ...
                    #   .. .. ..$ : NULL
                    #   .. ..@ x       : num [1:115721] 59.8 -10.2 -10.2 -10.2 -10.2 ...
                    #   .. ..@ factors : list()
                    #  $ inbreeding: num [1:570] 0.03143 0.97143 0.6 0.00571 0.08571 ...
                    #  $ dii       : num [1:570] 0.03143 0.97143 0.6 0.00571 0.08571 ...
                    #  $ node.names: chr [1:351] "Larus_cachinnans" "Larus_thayeri" "Larus_glaucescens" "Larus_glaucoides" ...
                    #  $ pedigree  : chr [1:570, 1:3] "0" NA NA NA ...
                    #   ..- attr(*, "dimnames")=List of 2
                    #   .. ..$ : NULL
                    #   .. ..$ : chr [1:3] "node.names" "" ""
                    #  $ phylogeny : logi TRUE
                    #  $ mii       : num [1:570] 0 0 0 0 0 0 0 0 0 0 ...
    
    # Converts sparseMatrix to asreml's giv format
        tree.seabird.IAasreml <- MCMCglmm::sm2asreml(tree.seabird.IA$Ainv, tree.seabird.IA$node.names) 
        beep()
        str(tree.seabird.IAasreml)
                    # Published example
                    # 'data.frame':	58036 obs. of  3 variables:
                    #  $ Row     : num  1 2 2 3 3 3 4 4 4 4 ...
                    #  $ Column  : int  1 1 2 1 2 3 1 2 3 4 ...
                    #  $ Ainverse: num  59.8 -10.2 59.8 -10.2 -10.2 ...
                    #  - attr(*, "rowNames")= chr  "Larus_cachinnans" "Larus_thayeri" "Larus_glaucescens" "Larus_glaucoides" ...

        
# For full dataset
    
    # Make sure nodes in the tree are unique
    tree.complete$node.label <- as.character(c(1:length(tree.complete$node.label)))
  
    # Inverse Relatedness Matrix and Phylogenetic Covariance Matrix
        tree.complete.IA <- MCMCglmm::inverseA(tree.complete, nodes = "TIPS") 
            # Warning message: In inverseA(tree, nodes = "TIPS") : no branch lengths: compute.brlen from ape has been used
        beep()
        str(tree.complete.IA)
                 # Published example 
                 # List of 7
                 # $ Ainv      :Formal class 'dgCMatrix' [package "Matrix"] with 6 slots
                 #  .. ..@ i       : int [1:98707589] 0 1 2 3 4 5 6 7 8 9 ...
                 #  .. ..@ p       : int [1:9994] 0 9935 19870 29805 39740 49675 59610 69545 79480 89415 ...
                 #  .. ..@ Dim     : int [1:2] 9993 9993

    # Converts sparseMatrix to asreml's giv format
        tree.complete.IAasreml <- MCMCglmm::sm2asreml(tree.complete.IA$Ainv, tree.complete.IA$node.names)
        beep()
        str(tree.complete.IAasreml)
                 # Published example
                 #        'data.frame':	49358791 obs. of  3 variables:
                 # $ Row     : num  1 2 2 3 3 3 4 4 4 4 ...
                 # $ Column  : int  1 1 2 1 2 3 1 2 3 4 ...
                 # $ Ainverse: num  1675 -323 1675 -323 -323 ...
                 # - attr(*, "rowNames")= chr  "Larus_cachinnans" "Larus_thayeri" "Larus_glaucescens" "Larus_glaucoides" ...
                 # and so on
        
# Save
    # save(tree.seabird.IA, file = paste0("./output/asreml.products/tree.seabird.IA_",Sys.Date(),".RData"))
    # save(tree.seabird.IAasreml, file = paste0("./output/asreml.products/tree.seabird.IAasreml_",Sys.Date(),".RData"))
    # save(tree.complete.IA, file = paste0("./output/asreml.products/tree.complete.IA_",Sys.Date(),".RData"))
    # save(tree.complete.IAasreml, file = paste0("./output/asreml.products/tree.complete.IAasreml_",Sys.Date(),".RData"))

    par(xpd = FALSE) 
        }
    
```

Analysis of Frequency of Plastic Ingestion, implemented in ASReml-R V3 (available by subscription)
```{r asreml_phylogenetic_mixed_model_analysis_FO_R.3.0.2_Date_Decade}

# This version is run with Date_Decade. It is preferrable to Date_FirstYR for the prediction stage bc it has fewer levels. It does not influence the minimum adequate model. 

# Below are 6 models, which show how the full model was simplified by stepwise backwards elimination, sequentially removing parameter estimates with the highest p value until only those with a conservative threshold of p < 0.10 remained. This is how a minimum adequate model was generated for use in developing predictions 
    # m1.asreml == full model
    # m2.asreml === stepwise simplification  
    # m3.asreml === stepwise simplification   
    # m4.asreml === stepwise simplification  
    # m5.asreml === minimum adequate model (for predictions)  

if(run.new.asreml == FALSE){ 

    load(file = "./output/asreml.products/PUBLISHED_m1.0.asreml_2019-03-25_R.3.0.2.RData")
    load(file = "./output/asreml.products/PUBLISHED_m1.1.asreml_2019-03-25_R.3.0.2.RData")
    load(file = "./output/asreml.products/PUBLISHED_m1.2.asreml_2019-03-25_R.3.0.2.RData")
    load(file = "./output/asreml.products/PUBLISHED_m1.3.asreml_2019-03-25_R.3.0.2.RData")
    load(file = "./output/asreml.products/PUBLISHED_m1.4.asreml_2019-03-25_R.3.0.2.RData")
    load(file = "./output/asreml.products/PUBLISHED_m1.5.asreml_2019-03-25_R.3.0.2.RData")
        
    print("The factors that best predict plastic ingestion among empirical studies are Age_Class, Date_Decade, Feeding.Method and Diet")

}else{
    
    if(use.published.seabird.FOdata == TRUE){
    # Load published data
    datanoNAs <- read.csv("./output/study_lvl_plastic_data_traits_asreml_FOisNA_removed_2019-03-18_PUBLISHED.csv")
    }else{
    # Choose a data file 
     list.files("./output/")
     datanoNAs <- read.csv(paste0("./output/study_lvl_plastic_data_traits_asreml_FOisNA_removed_",Sys.Date(),".csv")) 
     # # NOTE: Predictive variables CANNOT HAVE NAs. 
     }
       
    
dim(datanoNAs) # 1465   76

        # # Data summary of the empirical data that was used in the asreml phylogenetic mixed-model (excluding cases where FO wasn't available or species where trait data was NA (i.e., diet totally known etc))
        # data.sources <- unique(datanoNAs$Source) # 136 Sources
        # data.sources
        # number.of.birds <- sum(datanoNAs$n, na.rm = TRUE)  
        # number.of.birds # 47680
        # 
        # number.of.sps <- datanoNAs %>%
        #     filter(!is.na(Source)) %>%
        #     droplevels()
        # number.of.sps <- unique(number.of.sps$TipLabel_BirdTree) # 209 instead of 214 species (some species excluded)
        # number.of.sps # 209 
        # diet.levels <- unique(datanoNAs$Diet)

tree.seabird$node.label <- as.character(c(1:length(tree.seabird$node.label)))

###       
### Full Model
###
    m1.0.asreml <- asreml(fixed = logit.F0 ~ Order + scaled.body.mass +
                        Date_Decade + sqrtN + Feeding.Method +
                        Nocturnal.Foraging + Age.Class +
                        Opportunistic.Inferred + Diet,
                      random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                      data = datanoNAs,
                      #weights = "sqrtN",
                      ginverse = list(animal=tree.seabird.IAasreml))
    
    #Parameter estimates for random effects
    summary(m1.0.asreml)
        # $loglik
        # [1] -2810
        # 
        # $nedf
        # [1] 1431
        # 
        # $sigma
        # [1] 3.9
        # 
        # $varcomp
        #                          gamma component std.error z.ratio constraint
        # giv(animal, var = T).giv  5.94      90.6    20.423    4.44   Positive
        # R!variance                1.00      15.2     0.598   25.50   Positive
    
    #Parameter estimates for fixed effects
    summary(m1.0.asreml, all=T)$coef.fi
        #                                         solution std error  z ratio
        # Diet_Carrion.Birds                0.0000        NA       NA
        # Diet_Cephalopods                 -4.7741    1.8056 -2.64403
        # Diet_Crustaceans                 -3.4198    1.8034 -1.89629
        # Diet_Fish                        -3.7865    1.6848 -2.24739
        # Diet_Other.Inverts               -4.9503    2.2126 -2.23733
        # Opportunistic.Inferred_No         0.0000        NA       NA
        # Opportunistic.Inferred_Yes       -0.2799    0.5831 -0.48007
        # Age.Class_A                       0.0000        NA       NA
        # Age.Class_Mixed                  -0.9613    0.3605 -2.66668
        # Age.Class_Nest-bound              2.4833    0.6181  4.01739
        # Age.Class_SA                      0.7192    0.3844  1.87093
        # Age.Class_SA_A                   -0.5345    0.3599 -1.48517
        # Nocturnal.Foraging_No             0.0000        NA       NA
        # Nocturnal.Foraging_Yes            0.6680    0.5096  1.31087
        # Feeding.Method_Aerial.Pursuit     0.0000        NA       NA
        # Feeding.Method_Bottom.Feeding    -3.2952    2.8625 -1.15115
        # Feeding.Method_Dipping           -0.8874    1.5794 -0.56186
        # Feeding.Method_Pattering         -2.0653    2.1019 -0.98257
        # Feeding.Method_Pursuit.Diving    -3.0501    2.0832 -1.46418
        # Feeding.Method_Pursuit.Plunging   2.2025    1.6373  1.34521
        # Feeding.Method_Scavenging        -2.1894    2.4379 -0.89807
        # Feeding.Method_Skimming           0.3421    2.1061  0.16243
        # Feeding.Method_Surface.Plunging  -1.4446    1.6440 -0.87874
        # Feeding.Method_Surface.Seizing    0.7257    1.4488  0.50090
        # sqrtN                            -0.0257    0.0286 -0.89908
        # Date_Decade_1960s                 0.0000        NA       NA
        # Date_Decade_1970s                 0.7124    0.6710  1.06169
        # Date_Decade_1980s                -0.3319    0.6670 -0.49763
        # Date_Decade_1990s                 0.9582    0.7252  1.32125
        # Date_Decade_2000s                 0.1084    0.6790  0.15959
        # Date_Decade_2010s                -1.0160    0.6656 -1.52649
        # scaled.body.mass                 -0.2185    0.4202 -0.51987
        # Order_ANSERIFORMES                0.0000        NA       NA
        # Order_CHARADRIIFORMES            -0.3972   12.6941 -0.03129
        # Order_GAVIIFORMES                -0.8275   13.7856 -0.06003
        # Order_PELECANIFORMES              2.1656   13.9607  0.15512
        # Order_PHAETHONTIFORMES           -2.0690   13.7886 -0.15005
        # Order_PROCELLARIIFORMES           0.4296   12.7464  0.03370
        # Order_SPHENISCIFORMES            -0.0324   13.5382 -0.00239
        # Order_SULIFORMES                 -0.5418   13.3066 -0.04071
        # (Intercept)                       2.5774   10.3534  0.24894

    #Calculate phylogenetic heritability (also known as lambda)
    pin(m1.0.asreml, ~ V1/(V1+V2))
        #  Estimate     SE
        # 0.856 0.0869
    
    #Significance of fixed effects
    wald.asreml(m1.0.asreml, ssType="conditional", denDF="numeric")
        # LogLikelihood Converged 
        # $Wald
        #                        Df  denDF  F.inc  F.con Margin          Pr
        # (Intercept)             1   39.7 1.1580 1.0120        0.320566368
        # Order                   7   44.7 0.1210 0.0521      A 0.999771236
        # scaled.body.mass        1  157.0 0.0115 0.2703      A 0.603876544
        # Date_Decade             5 1407.8 4.7150 6.5530      A 0.000004893
        # sqrtN                   1 1421.1 1.5040 0.8084      A 0.368753746
        # Feeding.Method          9  196.3 2.0470 1.7980      A 0.070657392
        # Nocturnal.Foraging      1  270.4 1.7800 1.7180      A 0.191022188
        # Age.Class               4 1414.7 8.5820 8.5330      A 0.000000838
        # Opportunistic.Inferred  1  300.2 0.1347 0.2304      A 0.631556419
        # Diet                    4  346.2 2.2960 2.2960      A 0.058882878

    
###
### Then stepwise to simplify removing based on factor that has highest p-value until all are < 0.1 
# See if stepwise removal makes something significant. 
###
      
# REMOVE ORDER
    m1.1.asreml <- asreml(fixed = logit.F0 ~  scaled.body.mass +
                        Date_Decade + sqrtN + Feeding.Method +
                        Nocturnal.Foraging + Age.Class +
                        Opportunistic.Inferred + Diet,
                        random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                        data = datanoNAs,
                        #weights = "sqrtN",
                        ginverse = list(animal=tree.seabird.IAasreml))
    
        
    #Parameter estimates for random effects
    summary(m1.1.asreml)
        # $loglik
        # [1] -2825
        # 
        # $nedf
        # [1] 1438
        # 
        # $sigma
        # [1] 3.91
        # 
        # $varcomp
        #                          gamma component std.error z.ratio constraint
        # giv(animal, var = T).giv   4.9      75.1      16.9    4.45   Positive
        # R!variance                 1.0      15.3       0.6   25.52   Positive
    
                
    # Parameter estimates for fixed effects
    summary(m1.1.asreml, all=T)$coef.fi
        #                                        solution std error z ratio
        # Diet_Carrion.Birds                0.0000        NA      NA
        # Diet_Cephalopods                 -4.7541    1.7795  -2.672
        # Diet_Crustaceans                 -3.3560    1.7769  -1.889
        # Diet_Fish                        -3.7465    1.6673  -2.247
        # Diet_Other.Inverts               -4.8873    2.1636  -2.259
        # Opportunistic.Inferred_No         0.0000        NA      NA
        # Opportunistic.Inferred_Yes       -0.3356    0.5646  -0.594
        # Age.Class_A                       0.0000        NA      NA
        # Age.Class_Mixed                  -0.9752    0.3601  -2.708
        # Age.Class_Nest-bound              2.5101    0.6164   4.072
        # Age.Class_SA                      0.7251    0.3848   1.884
        # Age.Class_SA_A                   -0.5529    0.3591  -1.540
        # Nocturnal.Foraging_No             0.0000        NA      NA
        # Nocturnal.Foraging_Yes            0.6642    0.4905   1.354
        # Feeding.Method_Aerial.Pursuit     0.0000        NA      NA
        # Feeding.Method_Bottom.Feeding    -3.3754    2.6765  -1.261
        # Feeding.Method_Dipping           -0.8496    1.5535  -0.547
        # Feeding.Method_Pattering         -1.9406    2.0422  -0.950
        # Feeding.Method_Pursuit.Diving    -3.1013    1.9318  -1.605
        # Feeding.Method_Pursuit.Plunging   2.2671    1.6067   1.411
        # Feeding.Method_Scavenging        -2.1433    2.3478  -0.913
        # Feeding.Method_Skimming           0.4743    2.0327   0.233
        # Feeding.Method_Surface.Plunging  -1.3022    1.5990  -0.814
        # Feeding.Method_Surface.Seizing    0.8158    1.4312   0.570
        # sqrtN                            -0.0242    0.0286  -0.848
        # Date_Decade_1960s                 0.0000        NA      NA
        # Date_Decade_1970s                 0.6948    0.6706   1.036
        # Date_Decade_1980s                -0.3700    0.6668  -0.555
        # Date_Decade_1990s                 0.9379    0.7247   1.294
        # Date_Decade_2000s                 0.0906    0.6786   0.134
        # Date_Decade_2010s                -1.0307    0.6651  -1.550
        # scaled.body.mass                 -0.1784    0.3886  -0.459
        # (Intercept)                       2.0175    5.2180   0.387 
    
    #Calculate phylogenetic heritability (also known as lambda)
    pin(m1.1.asreml, ~ V1/(V1+V2))
        # Estimate     SE
        # 0.831 0.0996  
    
    wald.asreml(m1.1.asreml, ssType="conditional", denDF="numeric")
        # LogLikelihood Converged 
        # $Wald
        #                        Df  denDF   F.inc F.con Margin          Pr
        # (Intercept)             1   49.7 1.39300 1.215        0.275677610
        # scaled.body.mass        1  151.7 0.00167 0.217      A 0.642066905
        # Date_Decade             5 1413.5 4.75300 6.567      A 0.000004745
        # sqrtN                   1 1425.4 1.42100 0.724      A 0.395152868
        # Feeding.Method          9  209.7 2.28400 2.016      A 0.038986772
        # Nocturnal.Foraging      1  287.3 1.76800 1.848      A 0.175049215
        # Age.Class               4 1421.0 8.87000 8.803      A 0.000000509
        # Opportunistic.Inferred  1  333.6 0.23600 0.351      A 0.554042588
        # Diet                    4  378.1 2.43100 2.431      A 0.047224885
 
# Remove scaled.body mass
  m1.2.asreml <- asreml(fixed = logit.F0 ~
                        Date_Decade + sqrtN + Feeding.Method +
                        Nocturnal.Foraging + Age.Class +
                        Opportunistic.Inferred + Diet,
                        random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                        data = datanoNAs,
                        #weights = "sqrtN",
                        ginverse = list(animal=tree.seabird.IAasreml))
  
  
  #Parameter estimates for random effects
  summary(m1.2.asreml)
        #      $loglik
        # [1] -2824
        # 
        # $nedf
        # [1] 1439
        # 
        # $sigma
        # [1] 3.92
        # 
        # $varcomp
        #                          gamma component std.error z.ratio constraint
        # giv(animal, var = T).giv   4.8      73.7    16.577    4.44   Positive
        # R!variance                 1.0      15.3     0.601   25.53   Positive           
                
  # Parameter estimates for fixed effect
  summary(m1.2.asreml, all=T)$coef.fi
        #                                       solution std error z ratio
        # Diet_Carrion.Birds                0.0000        NA      NA
        # Diet_Cephalopods                 -4.6987    1.7723  -2.651
        # Diet_Crustaceans                 -3.2475    1.7592  -1.846
        # Diet_Fish                        -3.6894    1.6607  -2.222
        # Diet_Other.Inverts               -4.8056    2.1526  -2.233
        # Opportunistic.Inferred_No         0.0000        NA      NA
        # Opportunistic.Inferred_Yes       -0.3222    0.5614  -0.574
        # Age.Class_A                       0.0000        NA      NA
        # Age.Class_Mixed                  -0.9739    0.3600  -2.705
        # Age.Class_Nest-bound              2.5151    0.6162   4.082
        # Age.Class_SA                      0.7237    0.3848   1.881
        # Age.Class_SA_A                   -0.5599    0.3588  -1.561
        # Nocturnal.Foraging_No             0.0000        NA      NA
        # Nocturnal.Foraging_Yes            0.6436    0.4863   1.323
        # Feeding.Method_Aerial.Pursuit     0.0000        NA      NA
        # Feeding.Method_Bottom.Feeding    -3.4408    2.6600  -1.294
        # Feeding.Method_Dipping           -0.7738    1.5420  -0.502
        # Feeding.Method_Pattering         -1.8536    2.0293  -0.913
        # Feeding.Method_Pursuit.Diving    -3.0751    1.9220  -1.600
        # Feeding.Method_Pursuit.Plunging   2.2976    1.6027   1.434
        # Feeding.Method_Scavenging        -2.3954    2.2703  -1.055
        # Feeding.Method_Skimming           0.5421    2.0225   0.268
        # Feeding.Method_Surface.Plunging  -1.2708    1.5950  -0.797
        # Feeding.Method_Surface.Seizing    0.8269    1.4295   0.578
        # sqrtN                            -0.0241    0.0286  -0.845
        # Date_Decade_1960s                 0.0000        NA      NA
        # Date_Decade_1970s                 0.6860    0.6703   1.023
        # Date_Decade_1980s                -0.3746    0.6668  -0.562
        # Date_Decade_1990s                 0.9228    0.7240   1.275
        # Date_Decade_2000s                 0.0780    0.6781   0.115
        # Date_Decade_2010s                -1.0414    0.6647  -1.567
        # (Intercept)                       0.9615    4.6518   0.207          
  
  #Calculate phylogenetic heritability (also known as lambda)
  pin(m1.2.asreml, ~ V1/(V1+V2))
    # Estimate    SE
    # 0.828 0.101
     
  
  # Significance of fixed effects
  wald.asreml(m1.2.asreml, ssType="conditional", denDF="numeric")
        # LogLikelihood Converged 
        # $Wald
        #                        Df denDF F.inc F.con Margin          Pr
        # (Intercept)             1    40 1.420 1.414        0.241341682
        # Date_Decade             5  1415 4.761 6.550      A 0.000004929
        # sqrtN                   1  1426 1.411 0.719      A 0.396774717
        # Feeding.Method          9   213 2.294 2.092      A 0.031441692
        # Nocturnal.Foraging      1   292 1.587 1.766      A 0.184958448
        # Age.Class               4  1422 8.913 8.836      A 0.000000479
        # Opportunistic.Inferred  1   341 0.212 0.327      A 0.567606737
        # Diet                    4   376 2.457 2.457      A 0.045278928  
  
# Remove Opportunistic.Inferred
  m1.3.asreml <- asreml(fixed = logit.F0 ~ 
                        Date_Decade + sqrtN + Feeding.Method +
                        Nocturnal.Foraging + Age.Class + Diet,
                        random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                        data = datanoNAs,
                        #weights = "sqrtN",
                        ginverse = list(animal=tree.seabird.IAasreml))
  
  
  #Parameter estimates for random effects
  summary(m1.3.asreml)
        # $loglik
        # [1] -2823
        # 
        # $nedf
        # [1] 1440
        # 
        # $sigma
        # [1] 3.91
        # 
        # $varcomp
        #                          gamma component std.error z.ratio constraint
        # giv(animal, var = T).giv  4.85      74.3      16.6    4.47   Positive
        # R!variance                1.00      15.3       0.6   25.54   Positive     
        
  # Parameter estimates for fixed effect
  summary(m1.3.asreml, all=T)$coef.fi
    #                                     solution std error z ratio
    # Diet_Carrion.Birds                0.0000        NA      NA
    # Diet_Cephalopods                 -4.6850    1.7731 -2.6423
    # Diet_Crustaceans                 -3.2434    1.7601 -1.8427
    # Diet_Fish                        -3.6739    1.6610 -2.2119
    # Diet_Other.Inverts               -4.7601    2.1524 -2.2115
    # Age.Class_A                       0.0000        NA      NA
    # Age.Class_Mixed                  -0.9746    0.3599 -2.7080
    # Age.Class_Nest-bound              2.5085    0.6160  4.0722
    # Age.Class_SA                      0.7204    0.3846  1.8731
    # Age.Class_SA_A                   -0.5588    0.3587 -1.5578
    # Nocturnal.Foraging_No             0.0000        NA      NA
    # Nocturnal.Foraging_Yes            0.6350    0.4868  1.3044
    # Feeding.Method_Aerial.Pursuit     0.0000        NA      NA
    # Feeding.Method_Bottom.Feeding    -3.4053    2.6637 -1.2784
    # Feeding.Method_Dipping           -0.7825    1.5425 -0.5073
    # Feeding.Method_Pattering         -1.8389    2.0309 -0.9055
    # Feeding.Method_Pursuit.Diving    -3.0717    1.9258 -1.5951
    # Feeding.Method_Pursuit.Plunging   2.2148    1.5972  1.3867
    # Feeding.Method_Scavenging        -2.4013    2.2730 -1.0564
    # Feeding.Method_Skimming           0.5283    2.0251  0.2609
    # Feeding.Method_Surface.Plunging  -1.3114    1.5946 -0.8224
    # Feeding.Method_Surface.Seizing    0.8127    1.4297  0.5684
    # sqrtN                            -0.0248    0.0285 -0.8705
    # Date_Decade_1960s                 0.0000        NA      NA
    # Date_Decade_1970s                 0.6645    0.6690  0.9933
    # Date_Decade_1980s                -0.4030    0.6645 -0.6064
    # Date_Decade_1990s                 0.8853    0.7206  1.2284
    # Date_Decade_2000s                 0.0348    0.6735  0.0517
    # Date_Decade_2010s                -1.0868    0.6595 -1.6480
    # (Intercept)                       0.9529    4.6694  0.2041        
  
  #Calculate phylogenetic heritability (also known as lambda)
  pin(m1.3.asreml, ~ V1/(V1+V2))
    # Estimate  SE
    # 0.829 0.1
  
  # Significance of fixed effects
  wald.asreml(m1.3.asreml, ssType="conditional", denDF="numeric")
    # LogLikelihood Converged 
    # $Wald
    #                    Df  denDF F.inc F.con Margin          Pr
    # (Intercept)         1   40.5  1.41 1.402        0.243240903
    # Date_Decade         5 1418.8  4.76 6.668      A 0.000003786
    # sqrtN               1 1426.1  1.42 0.763      A 0.382409016
    # Feeding.Method      9  214.8  2.29 2.053      A 0.035036283
    # Nocturnal.Foraging  1  293.4  1.58 1.716      A 0.191195077
    # Age.Class           4 1423.4  8.90 8.806      A 0.000000506
    # Diet                4  380.3  2.42 2.424      A 0.047770871            

      
# Remove sqrtN
  m1.4.asreml <- asreml(fixed = logit.F0 ~ Date_Decade + Feeding.Method +
                        Nocturnal.Foraging + Age.Class + Diet,
                        random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                        data = datanoNAs,
                        #weights = "sqrtN",
                        ginverse = list(animal=tree.seabird.IAasreml))
  
    #Parameter estimates for random effects
    summary(m1.4.asreml)
        # $loglik
        # [1] -2820
        # 
        # $nedf
        # [1] 1441
        # 
        # $sigma
        # [1] 3.91
        # 
        # $varcomp
        #                          gamma component std.error z.ratio constraint
        # giv(animal, var = T).giv  4.79      73.4      16.4    4.47   Positive
        # R!variance                1.00      15.3       0.6   25.55   Positive
    
    #Parameter estimates for fixed effects
    summary(m1.4.asreml, all=T)$coef.fi
        #                                 solution std error z ratio
        # Diet_Carrion.Birds                 0.000        NA      NA
        # Diet_Cephalopods                  -4.577     1.767 -2.5905
        # Diet_Crustaceans                  -3.124     1.753 -1.7819
        # Diet_Fish                         -3.574     1.656 -2.1584
        # Diet_Other.Inverts                -4.677     2.148 -2.1778
        # Age.Class_A                        0.000        NA      NA
        # Age.Class_Mixed                   -1.026     0.355 -2.8874
        # Age.Class_Nest-bound               2.472     0.614  4.0236
        # Age.Class_SA                       0.727     0.385  1.8915
        # Age.Class_SA_A                    -0.592     0.357 -1.6598
        # Nocturnal.Foraging_No              0.000        NA      NA
        # Nocturnal.Foraging_Yes             0.623     0.486  1.2838
        # Feeding.Method_Aerial.Pursuit      0.000        NA      NA
        # Feeding.Method_Bottom.Feeding     -3.494     2.654 -1.3164
        # Feeding.Method_Dipping            -0.887     1.537 -0.5770
        # Feeding.Method_Pattering          -1.910     2.026 -0.9428
        # Feeding.Method_Pursuit.Diving     -3.147     1.918 -1.6413
        # Feeding.Method_Pursuit.Plunging    2.146     1.593  1.3465
        # Feeding.Method_Scavenging         -2.299     2.266 -1.0147
        # Feeding.Method_Skimming            0.456     2.019  0.2259
        # Feeding.Method_Surface.Plunging   -1.377     1.591 -0.8656
        # Feeding.Method_Surface.Seizing     0.734     1.426  0.5151
        # Date_Decade_1960s                  0.000        NA      NA
        # Date_Decade_1970s                  0.664     0.669  0.9924
        # Date_Decade_1980s                 -0.390     0.664 -0.5870
        # Date_Decade_1990s                  0.883     0.721  1.2248
        # Date_Decade_2000s                  0.043     0.673  0.0639
        # Date_Decade_2010s                 -1.037     0.657 -1.5787
        # (Intercept)                        0.842     4.643  0.1814
    
      
    # Significance of fixed effects
     wald.asreml(m1.4.asreml, ssType="conditional", denDF="numeric")
        # LogLikelihood Converged 
        # $Wald
        #                    Df  denDF F.inc F.con Margin          Pr
        # (Intercept)         1   40.4  1.43  1.43        0.239567251
        # Date_Decade         5 1420.5  4.76  6.53      A 0.000005189
        # Feeding.Method      9  215.2  2.31  2.04      A 0.035797336
        # Nocturnal.Foraging  1  294.2  1.46  1.66      A 0.198160553
        # Age.Class           4 1424.3  9.13  9.06      A 0.000000318
        # Diet                4  381.6  2.39  2.39      A 0.050698696  
       
     #Calculate phylogenetic heritability (also known as lambda)
    pin(m1.4.asreml, ~ V1/(V1+V2))
    # Estimate    SE
    # 0.827 0.101
    
###### FINAL MODEL! 
# Remove Nocturnal.Foraging
  m1.5.asreml <- asreml(fixed = logit.F0 ~ Date_Decade + Feeding.Method +
                        Age.Class + Diet,
                        random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                        data = datanoNAs,
                        #weights = "sqrtN",
                        ginverse = list(animal=tree.seabird.IAasreml))
  
  
   # Significance of fixed effects
   wald.asreml(m1.5.asreml, ssType="conditional", denDF="numeric")
        # LogLikelihood Converged 
        # $Wald
        #                Df  denDF F.inc F.con Margin          Pr
        # (Intercept)     1   41.3  1.40  1.40        0.244298042
        # Date_Decade     5 1421.0  4.76  6.51      A 0.000005382
        # Feeding.Method  9  216.9  2.29  2.30      A 0.017225773
        # Age.Class       4 1424.6  9.19  9.16      A 0.000000265
        # Diet            4  351.4  2.24  2.24      A 0.064363153
   
   
    #Parameter estimates for random effects
    summary(m1.5.asreml)
        #  $call
        # asreml(fixed = logit.F0 ~ Date_Decade + Feeding.Method + Age.Class + 
        #     Diet, random = ~giv(animal, var = T), data = datanoNAs, ginverse = list(animal = tree.seabird.IAasreml))
        # 
        # $loglik
        # [1] -2820
        # 
        # $nedf
        # [1] 1442
        # 
        # $sigma
        # [1] 3.91
        # 
        # $varcomp
        #                          gamma component std.error z.ratio constraint
        # giv(animal, var = T).giv   4.9      75.0    16.609    4.52   Positive
        # R!variance                 1.0      15.3     0.599   25.56   Positive
  
  #Parameter estimates for fixed effects
  summary(m1.5.asreml, all=T)$coef.fi
        #                                 solution std error z ratio
        # Diet_Carrion.Birds                0.0000        NA      NA
        # Diet_Cephalopods                 -4.6086     1.770 -2.6037
        # Diet_Crustaceans                 -3.4059     1.743 -1.9541
        # Diet_Fish                        -3.5459     1.658 -2.1386
        # Diet_Other.Inverts               -4.8862     2.147 -2.2759
        # Age.Class_A                       0.0000        NA      NA
        # Age.Class_Mixed                  -1.0337     0.355 -2.9104
        # Age.Class_Nest-bound              2.4829     0.614  4.0413
        # Age.Class_SA                      0.7131     0.384  1.8553
        # Age.Class_SA_A                   -0.6122     0.356 -1.7177
        # Feeding.Method_Aerial.Pursuit     0.0000        NA      NA
        # Feeding.Method_Bottom.Feeding    -3.7856     2.658 -1.4243
        # Feeding.Method_Dipping           -0.7852     1.537 -0.5109
        # Feeding.Method_Pattering         -1.9189     2.031 -0.9446
        # Feeding.Method_Pursuit.Diving    -3.3275     1.923 -1.7301
        # Feeding.Method_Pursuit.Plunging   2.2505     1.594  1.4118
        # Feeding.Method_Scavenging        -2.5869     2.263 -1.1430
        # Feeding.Method_Skimming           0.4994     2.025  0.2466
        # Feeding.Method_Surface.Plunging  -1.3181     1.593 -0.8274
        # Feeding.Method_Surface.Seizing    0.8595     1.423  0.6038
        # Date_Decade_1960s                 0.0000        NA      NA
        # Date_Decade_1970s                 0.6720     0.669  1.0044
        # Date_Decade_1980s                -0.3650     0.664 -0.5497
        # Date_Decade_1990s                 0.9112     0.720  1.2649
        # Date_Decade_2000s                 0.0629     0.673  0.0935
        # Date_Decade_2010s                -1.0186     0.657 -1.5510
        # (Intercept)                       1.2341     4.677  0.2639
  
  #Calculate phylogenetic heritability (also known as lambda)
  pin(m1.5.asreml, ~ V1/(V1+V2))
     #      Estimate     SE
     # 0.83 0.0993
  
  
# By default, four plots are currently generated: a histogram of the residuals, a Normal Q-Q plot, a plot of residuals against fitted values and a plot of residuals against unit number. If the residual structure of the model contains multiple sections, the default plots are conditioned on the factor whose levels define the sections. For multivariate analyses, the plots are conditioned on trait.
  plot(m1.5.asreml)
  
  anova(m1.5.asreml)
    # Wald tests for fixed effects
    # 
    # Response: logit.F0
    # 
    # Terms added sequentially; adjusted for those above
    # 
    #                Df Sum of Sq Wald statistic Pr(Chisq)    
    # (Intercept)     1        21            1.4   0.23896    
    # Date_Decade     5       365           23.8   0.00023 ***
    # Feeding.Method  9       317           20.7   0.01417 *  
    # Age.Class       4       563           36.8 0.0000002 ***
    # Diet            4       136            8.9   0.06354 .  
    # residual (MS)            15                             
    # ---
    # Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
    
       
print("According to the published dataset, the factors that best predict plastic ingestion across all avaiable empirical data for 209 seabirds are Age_Class, Date_Decade, Feeding.Method and Diet. Changes to the phylogenetic tree, the empirical data included in the model, or the model parameters may change this result.")
        
# Save
save(m1.0.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"m1.0.asreml_R.3.0.2.RData"))
save(m1.1.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"m1.1.asreml_R.3.0.2.RData"))
save(m1.2.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"m1.2.asreml_R.3.0.2.RData"))
save(m1.3.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"m1.3.asreml_R.3.0.2.RData"))
save(m1.4.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"m1.4.asreml_R.3.0.2.RData"))
save(m1.5.asreml, file = paste0("./output/asreml.products/",Sys.Date(),"m1.5.asreml_R.3.0.2.RData"))

}

```

```{r}
# Loaded existing models? Check their results here:

pick.a.model <- NULL # your model here

    # Significance of fixed effects
    wald.asreml(pick.a.model, ssType="conditional", denDF="numeric")
    
    #Parameter estimates for fixed effects
    summary(pick.a.model, all=T)$coef.fi
    
    #Parameter estimates for random effects
    summary(pick.a.model)
    
    # By default, four plots are currently generated: a histogram of the residuals, a Normal Q-Q plot, a plot of residuals against fitted values and a plot of residuals against unit number. If the residual structure of the model contains multiple sections, the default plots are conditioned on the factor whose levels define the sections. For multivariate analyses, the plots are conditioned on trait.
    plot(pick.a.model)
    
    #Calculate phylogenetic heritability (also known as lambda)
    pin(pick.a.model, ~ V1/(V1+V2))

  
```


Savoca et al. (2016)[1] presented support for the hypothesis that that emission of dimethyl sulphide (DMS) by biota on bio-fouled plastics represents an olfactory trap for foraging seabirds, and that it explains patterns of plastic ingestion among procellariiform seabirds19. 

This was challenged by Dell’Ariccia et al. (2017), who provide a critique of 3 key aspects of the Savoca analysis: 1) DMS responsiveness is not binomial, as it is presented, 2) some of the species assignments were incorrect and 3) other than the phylogenetic relationship between species that are responsive and those that excavate burrows - there is no reasonable link between these to factors - thus use of excavates burrow as a proxy for responsiveness is poorly supported. 

To address challenges of the hypothesis, and calls by Dell'Ariccia et al. to include other predictors (diet, marine habitat preference, and other foraging characteristics) that have been shown in previous studies to correlate with variation in plastic ingestion rates we chose to include an analysis of dimethyl suphide in a seperate analysis on Procellariform seabirds. We restricted this exploration to Procellariformes because responsiveness to dimethyl-sulphide has only been evaluated for 23 of 209 species (19 or 98 [20%] Procellariform). We used binomial data from Dell'Ariccia et al. (2017) (not the critiqued data provided by Savoca et al. (2016)), and assigned 'unknown' to the species for which dimethyl suplhide responsiveness is unknown, which we were aware couldundermine the strength of the analysis. Our full model for this analysis included all the previously mentioned factors, plus dimethyl-sulphide and was likewise simplified by stepwise backwards elimination using a conservative threshold of P < 0.10. 

1. Savoca, M. S., Wohlfeil, M. E., Ebeler, S. E. & Nevitt, G. A. Marine plastic debris emits a keystone infochemical for olfactory foraging seabirds. Science Advances 2, e1600395 (2016).
2. Dell’Ariccia, G. et al. Comment on “Marine plastic debris emits a keystone infochemical for olfactory foraging seabirds” by Savoca et al. Science Advances 3, e1700526 (2017).

We found dimethly sulphide responsiveness was not in the minimum adequate model. However, a P-value near the threshold for stepwise backwards elimination (P = 0.106) is consistent with the hypothesis that some seabirds may be attracted to ingesting bio-fouled plastic because they use dimethyl-sulphide as an olfactory cue when foraging.
 
                summary(m4.asreml.dms, all=T)$coef.fi
                
                # DMS.responsive_Dell.Ariccia_No        0.0000        NA      NA
                # DMS.responsive_Dell.Ariccia_Unknown  -1.1413    0.6753 -1.6901
                # DMS.responsive_Dell.Ariccia_Yes       0.3976    0.9618  0.4134
                
```{r asreml_phylogenetic_mixed_model_analysis_FO_R.3.0.2_DMS.sensitivity_PROCELLARIFORMES}

# This version is run with Date_Decade. It is preferrable to Date_FirstYR for the prediction stage bc it has fewer levels. It does not influence the minimum adequate model. 

# Below are 6 models, which show how the full model was simplified by stepwise backwards elimination, sequentially removing parameter estimates with the highest p value until only those with a conservative threshold of p < 0.10 remained. This is how a minimum adequate model was generated for use in developing predictions 
    # m1.asreml.dms == full model
    # m2.asreml.dms === stepwise simplification  
    # m3.asreml.dms === stepwise simplification   
    # m4.asreml.dms === stepwise simplification  
    # m5.asreml.dms === minimum adequate model (for predictions)  

if(run.new.asreml == FALSE){ 
    
        load(file = paste0("./output/asreml.products/PUBLISHED_m1.asreml.dms_","2019-03-25","_R.3.0.2.RData"))
        load(file = paste0("./output/asreml.products/PUBLISHED_m2.asreml.dms_","2019-03-25","_R.3.0.2.RData"))
        load(file = paste0("./output/asreml.products/PUBLISHED_m3.asreml.dms_","2019-03-25","_R.3.0.2.RData"))
        load(file = paste0("./output/asreml.products/PUBLISHED_m4.asreml.dms_","2019-03-25","_R.3.0.2.RData"))
        load(file = paste0("./output/asreml.products/PUBLISHED_m5.asreml.dms_","2019-03-25","_R.3.0.2.RData"))
               
        print("When we restrict our exploration of the significance of DMS.Responsiveness to only Procellariformes - the only group with reasonable data on dimethy sulphide responsiveness (20% of species, 19/98)  we find it is NOT a significant predictor (although it was one of the last to be removed). The minimum adequate model includes: Date_Decade (peak in 1990), sqrtN (-0.0770), Feeding.Method (Pursuit.Plunging > Surface.Plunging > Surface.Seizing > Scavenging > Skimming), Age.Class (Nest-bound highest), Opportunistic.Inferred (Non opportunistic birds much higher FO).")

}else{
    
    if(use.published.seabird.FOdata == TRUE){
    # Load published data
    datanoNAs.DMS <- read.csv("./output/study_lvl_plastic_data_traits_asreml_FOisNA_removed_2019-03-18_procellariformes_PUBLISHED.csv")
    }else{
    # Choose a data file 
     list.files("./output/")
     datanoNAs.DMS <- read.csv(paste0("./output/study_lvl_plastic_data_traits_asreml_FOisNA_removed_",Sys.Date(),"_procellariformes.csv")) 
     # # NOTE: Predictive variables CANNOT HAVE NAs. 
     }
        
    dim(datanoNAs.DMS) # 1034   76 
    # View(datanoNAs.DMS)

    tree.seabird$node.label <- as.character(c(1:length(tree.seabird$node.label)))

    ## Run the model WITHOUT Excavates burrow, WITHOUT Order (all same order!)
      m1.asreml.dms <- asreml(fixed = logit.F0 ~  scaled.body.mass +  
                            Date_Decade + sqrtN + Feeding.Method +
                            DMS.responsive_Dell.Ariccia + Nocturnal.Foraging + Age.Class +
                            Opportunistic.Inferred + Diet,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = datanoNAs.DMS,                     
                          # weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml)) 
      
      # Significance of fixed effects
      wald.asreml(m1.asreml.dms, ssType="conditional", denDF="numeric")
        # LogLikelihood Converged 
        # $Wald
        #                             Df  denDF  F.inc   F.con Margin             Pr
        # (Intercept)                  1   23.3 0.0661  0.0321        0.859275506440
        # scaled.body.mass             1   51.8 0.0219  1.7970      A 0.185867705870
        # Date_Decade                  5  994.0 8.4990 10.4200      A 0.000000000918
        # sqrtN                        1 1002.0 6.1750  5.3000      A 0.021527202819
        # Feeding.Method               7   65.8 2.0360  2.1880      a 0.046484463058
        # DMS.responsive_Dell.Ariccia  2  130.0 5.6640  1.2460      A 0.291115202312
        # Nocturnal.Foraging           1  122.2 0.6859  1.0310      A 0.311830939888
        # Age.Class                    4  997.8 7.1320  7.3950      A 0.000007183835
        # Opportunistic.Inferred       1   83.0 4.4740  4.7250      A 0.032584176644
        # Diet                         2  119.2 0.6195  0.6195      A 0.539911490298
      
      
# Remove Diet
      m2.asreml.dms <- asreml(fixed = logit.F0 ~ scaled.body.mass +  
                            Date_Decade + sqrtN + Feeding.Method +
                            DMS.responsive_Dell.Ariccia + Nocturnal.Foraging + Age.Class +
                            Opportunistic.Inferred ,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = datanoNAs.DMS,                     
                          # weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml)) 
      
      # Significance of fixed effects
      wald.asreml(m2.asreml.dms, ssType="conditional", denDF="numeric")
  
        # LogLikelihood Converged 
        # $Wald
        #                             Df  denDF  F.inc   F.con Margin             Pr
        # (Intercept)                  1   23.8 0.0670  0.0324        0.858573571429
        # scaled.body.mass             1   52.9 0.0226  1.9000      A 0.173909738482
        # Date_Decade                  5  996.1 8.5220 10.5400      A 0.000000000705
        # sqrtN                        1 1003.7 6.1630  5.2760      A 0.021827640641
        # Feeding.Method               7   66.8 2.0550  2.2050      A 0.044681274502
        # DMS.responsive_Dell.Ariccia  2  122.8 5.7160  1.7810      A 0.172749250672
        # Nocturnal.Foraging           1  101.4 0.6810  1.3850      A 0.242078382767
        # Age.Class                    4  999.8 7.1590  7.4740      A 0.000006219862
        # Opportunistic.Inferred       1   84.5 4.4810  4.4810      A 0.037210161198
      
      
      
# REMOVE Nocturnal.Foraging
      m3.asreml.dms <- asreml(fixed = logit.F0 ~ scaled.body.mass +  
                            Date_Decade + sqrtN + Feeding.Method +
                            DMS.responsive_Dell.Ariccia + Age.Class +
                            Opportunistic.Inferred ,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = datanoNAs.DMS,                     
                          # weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml)) 
      
      # Significance of fixed effects
      wald.asreml(m3.asreml.dms, ssType="conditional", denDF="numeric")
        # LogLikelihood Converged 
        # $Wald
        #                             Df  denDF  F.inc  F.con Margin             Pr
        # (Intercept)                  1   23.3 0.0686  0.033        0.857466585446
        # scaled.body.mass             1   52.0 0.0239  1.829      A 0.182070146533
        # Date_Decade                  5  997.5 8.5500 10.550      A 0.000000000694
        # sqrtN                        1 1003.8 6.1310  5.047      A 0.024881491404
        # Feeding.Method               7   64.9 2.0870  2.338      A 0.034259130667
        # DMS.responsive_Dell.Ariccia  2  126.4 5.8060  2.474      A 0.088330318185
        # Age.Class                    4 1001.4 7.2250  7.513      A 0.000005800310
        # Opportunistic.Inferred       1   76.9 3.6680  3.668      A 0.059194417673
      
      
# REMOVE scaled.body.mass
      m4.asreml.dms <- asreml(fixed = logit.F0 ~   
                            Date_Decade + sqrtN + Feeding.Method +
                            DMS.responsive_Dell.Ariccia  + Age.Class +
                            Opportunistic.Inferred ,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = datanoNAs.DMS,                     
                          # weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml)) 
      
      # Significance of fixed effects
      wald.asreml(m4.asreml.dms, ssType="conditional", denDF="numeric")
        # LogLikelihood Converged 
        # $Wald
        #                             Df  denDF  F.inc   F.con Margin            Pr
        # (Intercept)                  1   22.1 0.0675  0.0598        0.80905161826
        # Date_Decade                  5  998.5 8.5150 10.3800      A 0.00000000102
        # sqrtN                        1 1003.9 6.0140  4.7780      A 0.02904954964
        # Feeding.Method               7   68.1 1.8710  2.0630      A 0.05946057725
        # DMS.responsive_Dell.Ariccia  2  129.0 5.4150  2.2800      A 0.10640766984  <<<<<<< Not quite significant, but suggestive
        # Age.Class                    4 1002.5 7.3000  7.5880      A 0.00000505572
        # Opportunistic.Inferred       1   79.2 3.6480  3.6480      A 0.05975998976
      
      
      #Parameter estimates for fixed effects
      summary(m4.asreml.dms, all=T)$coef.fi
        #                                     solution std error z ratio
        # Opportunistic.Inferred_No             0.0000        NA      NA
        # Opportunistic.Inferred_Yes           -2.5237    1.3213 -1.9100
        # Age.Class_A                           0.0000        NA      NA
        # Age.Class_Mixed                      -0.7511    0.4517 -1.6628
        # Age.Class_Nest-bound                  3.0402    0.7737  3.9294
        # Age.Class_SA                          0.4430    0.4804  0.9223
        # Age.Class_SA_A                       -1.2301    0.4594 -2.6775
        # DMS.responsive_Dell.Ariccia_No        0.0000        NA      NA
        # DMS.responsive_Dell.Ariccia_Unknown  -1.1413    0.6753 -1.6901
        # DMS.responsive_Dell.Ariccia_Yes       0.3976    0.9618  0.4134
        # Feeding.Method_Dipping                0.0000        NA      NA
        # Feeding.Method_Pattering             -0.1338    1.6216 -0.0825
        # Feeding.Method_Pursuit.Diving        -4.5069    3.0580 -1.4738
        # Feeding.Method_Pursuit.Plunging       4.2798    1.8500  2.3133
        # Feeding.Method_Scavenging             2.6542    2.0736  1.2800
        # Feeding.Method_Skimming               1.1773    2.4335  0.4838
        # Feeding.Method_Surface.Plunging       2.8046    2.7783  1.0095
        # Feeding.Method_Surface.Seizing        2.0407    1.5642  1.3047
        # sqrtN                                -0.0842    0.0385 -2.1859
        # Date_Decade_1960s                     0.0000        NA      NA
        # Date_Decade_1970s                     1.0755    1.0790  0.9968
        # Date_Decade_1980s                     0.0532    1.0491  0.0507
        # Date_Decade_1990s                     2.0001    1.1192  1.7871
        # Date_Decade_2000s                     0.6950    1.0720  0.6483
        # Date_Decade_2010s                    -1.2736    1.0622 -1.1990
        # (Intercept)                          -1.8549    8.7990 -0.2108
      
      
    # Calculate phylogenetic heritability (also known as lambda)
    pin(m4.asreml.dms, ~ V1/(V1+V2))
        #   Estimate   SE
         # 0.86 0.11
      
    #Parameter estimates for random effects
    summary(m4.asreml.dms)
        # $loglik
        # [1] -2030
        # 
        # $nedf
        # [1] 1013
        # 
        # $sigma
        # [1] 4.12
        # 
        # $varcomp
        #                          gamma component std.error z.ratio constraint
        # giv(animal, var = T).giv  6.16       105    31.573    3.32   Positive
        # R!variance                1.00        17     0.782   21.73   Positive
      
      
      
# REMOVE DMS.responsive_Dell.Ariccia
      m5.asreml.dms <- asreml(fixed = logit.F0 ~   
                           Date_Decade + sqrtN + Feeding.Method +
                            Age.Class +
                            Opportunistic.Inferred ,
                          random= ~giv(animal, var=T),  #'animal' is the phylogeny, 'TipLabel' is the random effect associated with multiple measurements of the same species         
                          data = datanoNAs.DMS,                     
                          # weights = "sqrtN",
                          ginverse = list(animal=tree.seabird.IAasreml)) 
      
      # Significance of fixed effects
      wald.asreml(m5.asreml.dms, ssType="conditional", denDF="numeric")
            # LogLikelihood Converged 
            # $Wald
            #                        Df  denDF  F.inc   F.con Margin             Pr
            # (Intercept)             1   23.6 0.0639  0.0566        0.814094819380
            # Date_Decade             5  999.1 8.4300 10.5300      A 0.000000000725
            # sqrtN                   1 1005.5 6.0700  4.0210      A 0.045198322136
            # Feeding.Method          7   68.5 1.8040  2.4320      A 0.027587299746
            # Age.Class               4 1004.2 7.9590  8.1760      A 0.000001730749
            # Opportunistic.Inferred  1   68.5 6.6080  6.6080      A 0.012326871329
            
  
       # Parameter estimates for random effects
       summary(m5.asreml.dms)
            # $loglik
            # [1] -2032
            # 
            # $nedf
            # [1] 1015
            # 
            # $sigma
            # [1] 4.12
            # 
            # $varcomp
            #                          gamma component std.error z.ratio constraint
            # giv(animal, var = T).giv  6.59       112    32.622    3.43   Positive
            # R!variance                1.00        17     0.782   21.74   Positive
       
      #Parameter estimates for fixed effects
      summary(m5.asreml.dms, all=T)$coef.fi
            #                                             solution std error z ratio
            # Opportunistic.Inferred_No         0.0000        NA      NA
            # Opportunistic.Inferred_Yes       -3.3031    1.2849  -2.571
            # Age.Class_A                       0.0000        NA      NA
            # Age.Class_Mixed                  -0.7937    0.4514  -1.758
            # Age.Class_Nest-bound              3.0764    0.7747   3.971
            # Age.Class_SA                      0.4576    0.4804   0.952
            # Age.Class_SA_A                   -1.3222    0.4576  -2.889
            # Feeding.Method_Dipping            0.0000        NA      NA
            # Feeding.Method_Pattering         -1.2435    1.5293  -0.813
            # Feeding.Method_Pursuit.Diving    -4.2446    3.0541  -1.390
            # Feeding.Method_Pursuit.Plunging   4.9135    1.8361   2.676
            # Feeding.Method_Scavenging         2.0787    2.0892   0.995
            # Feeding.Method_Skimming           1.4737    2.3823   0.619
            # Feeding.Method_Surface.Plunging   2.9750    2.8391   1.048
            # Feeding.Method_Surface.Seizing    2.2045    1.5837   1.392
            # sqrtN                            -0.0770    0.0384  -2.005
            # Date_Decade_1960s                 0.0000        NA      NA
            # Date_Decade_1970s                 1.0778    1.0794   0.999
            # Date_Decade_1980s                 0.0452    1.0495   0.043
            # Date_Decade_1990s                 1.9959    1.1194   1.783
            # Date_Decade_2000s                 0.6958    1.0723   0.649
            # Date_Decade_2010s                -1.2912    1.0624  -1.215
            # (Intercept)                      -2.4454    9.0852  -0.269
      
      # Calculate phylogenetic heritability (also known as lambda)
      pin(m5.asreml.dms, ~ V1/(V1+V2))
             # Estimate    SE
             #    0.868 0.104
             #      
      
      
    print("According to the published dataset, when we restrict our exploration of the significance of DMS.Responsiveness to only Procellariformes - the only group with reasonable data on dimethy sulphide responsiveness (20% of species, 19/98)  we find it is NOT a significant predictor (although it was one of the last to be removed). The minimum adequate model includes: Date_Decade (peak in 1990), sqrtN (-0.0770), Feeding.Method (Pursuit.Plunging > Surface.Plunging > Surface.Seizing > Scavenging > Skimming), Age.Class (Nest-bound highest), Opportunistic.Inferred (Non opportunistic birds much higher FO).")
            
    # Save
    save(m2.asreml.dms, file = paste0("./output/asreml.products/",Sys.Date(),"m1.asreml.dms_R.3.0.2.RData"))
    save(m2.asreml.dms, file = paste0("./output/asreml.products/",Sys.Date(),"m2.asreml.dms_R.3.0.2.RData"))
    save(m3.asreml.dms, file = paste0("./output/asreml.products/",Sys.Date(),"m3.asreml.dms_R.3.0.2.RData"))
    save(m4.asreml.dms, file = paste0("./output/asreml.products/",Sys.Date(),"m4.asreml.dms_R.3.0.2.RData"))
    save(m5.asreml.dms, file = paste0("./output/asreml.products/",Sys.Date(),"m5.asreml.dms_R.3.0.2.RData"))

      }
    
```


Now that we've identified factors that matter to the miniumum adequate model (published vrs: Feeding.Method + Nocturnal.Foraging + Age.Class + Diet), we can use this to make predictions. 

1. Save
2. Close this script 
3. Switch to R 3.5.3
    Helpful notes:
        - https://support.rstudio.com/hc/en-us/articles/200486138-Changing-R-versions-for-RStudio-desktop
        - An application like R Switch is an easy way to swap between versions of R without needing to reinstall and restart your computer)
3. Open "./R.analysis/4 Predicting_FO_req_R.3.5.3.Rmd"

