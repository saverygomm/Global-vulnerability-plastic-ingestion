---
title: "Avery-Gomm et al. (TBD) Global seabird plastic ingestion vulnerability predicted using life history and phylogeny"
authors: "Stephanie Avery-Gomm, Craig White"
date: '2019-04-19'
---

This script produces figures and tables. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
root.dir = dirname(getwd()) # this might work better for PC users.
knitr::opts_knit$set(root.dir = root.dir)

```


```{r initialize}

# Initialize
getwd()

# Initializing
# Clear workspace
rm(list=ls())
gc()

# Run this in     
    
    # R version 3.5.3 (2019-03-11)
    # Platform: x86_64-apple-darwin15.6.0 (64-bit)
    # Running under: macOS Sierra 10.12.6

# # First time? Load packages that are the same as the ones downloaded to run this project by using 'checkpoint' to load packages as of a specified date
install.packages("checkpoint")
library(checkpoint)
checkpoint::setSnapshot("2019-04-19")

# Not first time? Assume these all will load your sessionInfo() matches
    sessionInfo()
    # R version 3.5.3 (2019-03-11)
    # Platform: x86_64-apple-darwin15.6.0 (64-bit)
    # Running under: macOS Sierra 10.12.6
    # See README for full R 3.5.3 session details.

# Load Packages
library(ape)
library(caper)
library(car)
library(phylolm)
library(lmtest)
library(phytools) # used for 'read.tree'
library(boot)
library(lme4)
library(gtools)
library(ape)
library(MCMCglmm)
library(MuMIn)
library(plyr)
library(beepr)
# install.packages("cowplot")
library(cowplot)
library(ggplot2)
library(tidyverse)
# install.packages("gridExtra") 
library(gridExtra) # for grid.arrange
    
`%notin%` <- Negate(`%in%`) # Add this function!
options(scipen=999, digits = 3)


```

```{r setup_questions}

small.samples.have.less.than <- 50
low.FO.is.less.than <- 0.6

use.published <- TRUE

```


```{r load_empirical_and_prediction_data}
# Load prediction & empirical.FO data 

if(use.published == TRUE){
   
# Published versions
    # This used for Fig 1 from publication - phylogenetic tree with empirical mean FO and fixed factors
    datanoNAs <- read.csv(paste0("./output/study_lvl_plastic_data_traits_asreml_FOisNA_removed_2019-03-18_PUBLISHED.csv")) # latest version is "2019-03-18"
    
    # This used for getting summary stats of the full dataset
    data.clean <- read.csv("./output/study_lvl_plastic_data2_traits_clean_2019-03-18_PUBLISHED.csv")
    
    # This used for all other figures
    prediction.summary_Age<- read.csv("./output/MCMCglmm.products/m1.6.MCMCglmm_Adult_2010s.FO.predictions.345.species_2019-03-25_PUBLISHED.csv")    
    
    tree <- read.tree("./output/ConsensusTree_seabird_matched.phy") # Use published

    print("Loaded *published* date files + including published phylogenetic tree for seabirds")

        
}else{    
    
    
# Or load newly created versions from "2. File_prep_req_R.3.5.3.Rmd"
    
    # This used for all other figures
    list.files("./output/MCMCglmm.products/")
    prediction.summary_Age<- read.csv(paste0("./output/MCMCglmm.products/m1.6.MCMCglmm_Adult_2010s.FO.predictions.345.species_",Sys.Date(),".csv"))
    
    # This used for getting summary stats of the full dataset (before subsetted for ASReml or MCMCglmm analysis)
    list.files("./output/")
    data.clean <- read.csv(paste0("./output/study_lvl_plastic_data2_traits_clean_",Sys.Date(),".csv"))
    
    # This used for Fig 1 from publication - phylogenetic tree with empirical mean FO and fixed factors
    list.files("./output/")
    datanoNAs <- read.csv(paste0("./output/study_lvl_plastic_data_traits_asreml_FOisNA_removed_", Sys.Date(),".csv"))
    
    tree <- read.tree("./output/ConsensusTree_seabird_matched.phy") # Use published (does not need to be altered unless change is made to *what* is considered a seabird in "2. File_prep_req_R.3.5.3.Rmd")

    print("Loaded recently created data (i.e., Sys.Date() or specified date files) + published phylogenetic tree for seabirds")
    
}

```


```{r empirical.data.summary}

# To get a list of references that were used in this analysis, pull "source" from the data summary of the empirical data that was used in the asreml phylogenetic mixed-model (excluding cases where FO wasn't available or species where trait data was NA (i.e., diet totally known etc))

data.sources <- unique(datanoNAs$Source) # 135 Sources, 153 if you exclude NAs, which you should.
data.sources
number.of.birds <- sum(datanoNAs$n, na.rm = TRUE) # 47565 instead of 48658 birds (some studies excluded!)

refs<- read.csv("./data/references.csv")
head(refs)
colnames(refs)
refs2<- refs %>%
    filter(Source %in% data.sources)
# View(refs2) # only 121 of 135 sources are in the literbase or match.
dim(refs2)

data.sources.df<- as.data.frame(data.sources)

data.sources2<- left_join(data.sources.df, refs, by = c("data.sources" = "Source"))
dim(data.sources2)
# View(data.sources2)

write.csv(data.sources2, paste0("./figs_tables/References_",Sys.Date(),".csv"), row.names = FALSE)

# Curious how many species studied (that were INCLUDED in the subset used in the phylogenetic mixed model. Recalling some studies were excluded)
studied.species <- datanoNAs %>%
    filter(!is.na(Source)) %>%
    droplevels()
studied.species <- unique(studied.species$TipLabel_BirdTree) # 209 instead of 214 species (some species excluded)
number.of.sps<- length(studied.species)
number.of.sps

ingested.true <- datanoNAs %>%
    filter(n > 0) %>%
    filter(Plastic == "Yes") %>%
    droplevels() %>%
    # select(TipLabel_BirdTree) %>%
    distinct(TipLabel_BirdTree)
ingested.true <- nrow(ingested.true)
ingested.true

ingested.false <- number.of.sps - ingested.true
ingested.false # 70

unstudied <- 345 - number.of.sps
unstudied # 136 + 10 NOT INCLUDED bc of insufficient quality / NA BirdTree matches 
average.FO.for.ingested.sps  <- datanoNAs %>%
    filter(n > 0) %>%
    filter(FO > 0.00)
average.FO.for.ingested.sps <- round((mean(average.FO.for.ingested.sps$FO)*100), digits = 0)
average.FO.for.ingested.sps # 58

number.of.birds.in.ASREML <- sum(datanoNAs$n)
number.of.birds.in.ASREML # 47680

number.of.birds.in.MCMCglmm <- sum(prediction.summary_Age$sample.size)
number.of.birds.in.MCMCglmm # 48750

str(prediction.summary_Age)
birds.predict.plastic.even.though.none.found.n.morethan50 <- prediction.summary_Age %>%
    filter(sample.size > 50) %>%
    filter(emp.meanFO == 0) %>%
    distinct(TipLabel_BirdTree) %>%
    droplevels()
how.many <- nrow(birds.predict.plastic.even.though.none.found.n.morethan50)
how.many
x <-levels(birds.predict.plastic.even.though.none.found.n.morethan50$TipLabel_BirdTree)
# [1] "Anous_stolidus"            "Aptenodytes_patagonicus"   "Brachyramphus_marmoratus" 
#  [4] "Megadyptes_antipodes"      "Melanitta_perspicillata"   "Phalacrocorax_atriceps"   
#  [7] "Phalacrocorax_capensis"    "Procelsterna_cerulea"      "Pygoscelis_adeliae"       
# [10] "Pygoscelis_papua"          "Somateria_spectabilis"     "Spheniscus_demersus"      
# [13] "Sterna_lunata"             "Sterna_paradisaea"         "Sterna_sandvicensis"      
# [16] "Synthliboramphus_antiquus"
                
print(paste0("We compiled trait data for 345 out of 355 seabird species and empirical data on FO of plastic ingestion data for ", number.of.sps ," seabird species (", round((number.of.sps/355)*100, digits = 0),"% of the worldâ€™s total). This dataset includes ", nrow(data.sources.df)," peer-reviewed sources and represents ", (number.of.birds.in.MCMCglmm)," individual birds. In total ", ingested.true, " (",round((ingested.true/number.of.sps*100), digits = 0),"%) of species sampled between ", min(datanoNAs$Date_FirstYR, na.rm = T), " and ", max(datanoNAs$Date_LastYR, na.rm = T), " have been reported to ingested plastic. Among species that were found to ingest plastic an average of ", average.FO.for.ingested.sps, "% of individuals had plastic in their gut. In total, ",ingested.false, " seabird species (",round(((ingested.false)/355*100), digits = 0),"%) have been reported to ingest no plastic and ", unstudied," species have never been studied (", round((unstudied/355)*100, digits = 0),"%). Based on our predictive model, we predict that ", (nrow(prediction.summary_Age %>% filter(mean.FO > 0) %>% distinct(TipLabel_BirdTree))/355)*100,"% of seabird species have ingested at least some plastic - including ",how.many, " species where >100 birds have been sampled but no plastic has previously been found. We cannot generate predictions for 10 species which we lacked trait data on."))

            average.meanFO <- prediction.summary_Age %>%
                mutate(new.n = 100) %>%
                mutate(test.var = mean.FO*new.n)
            average.meanFOx <- mean(average.meanFO$test.var)


# What about the larger dataset "dataclean" (before removal of records for quality control reasons - when creating the ASReml and MCMCglmm datasets)?

dim(data.clean) # Published = 1658   76
            
sps.studied<- nrow(data.clean %>%
    filter(!is.na(Source)) %>%
    distinct(TipLabel_BirdTree))

sps.studied # Published = 210

ingest.true<- nrow(data.clean %>%
    filter(!is.na(Source)) %>%
    filter(Plastic == "Yes") %>%
    droplevels() %>%
    distinct(TipLabel_BirdTree))

ingest.true # Published = 210

ingest.no <- sps.studied - ingest.true

data.clean.refs <-length(unique(data.clean$Source))

print(paste0("Initally, we collated empirical data on plastic ingestion data for ", sps.studied ," seabird species. This dataset includes ", data.clean.refs," peer-reviewed sources. Some data was excluded from analysis due to unclear sample sizes, sampling dates or FO. Those excluded data can be found in './FYI/excluded_bc...folder'"))

```

*Published*
Table of 345 predictions (out of 355 possible seabird species, 97%)
```{r published_Table.of.Predictions}

colnames(prediction.summary_Age)

Table.Predictions <- prediction.summary_Age %>% 
    mutate(credible.interval = paste0(lower.HPDinterval," - ", upper.HPDinterval)) %>%
    dplyr::select(SISRecID_BLVr9, Common.name_BirdTree, TipLabel_BirdTree, BLFamilyLatin, BLFamilyEnglish, Order, priority.highFO.lowN, mean.FO, credible.interval, sampled, sample.size, -minFO, -maxFO, emp.meanFO, emp.sdFO, Feeding.Method, Diet, X2016.IUCN.Red.List.category, Age.Class, Date_Decade)


Table.Predictions$X2016.IUCN.Red.List.category <- recode(Table.Predictions$X2016.IUCN.Red.List.category, "EX" = "Extinct", "CR (PE)" = "Critically Endangered, Presumed Extinct", "CR" = "Critically Endangered", "EN" = "Endangered", "VU" = "Vulnerable", "NT" = "Near Threatened", "LC" = "Least Concern", "DD" = "Data Deficient")

levels(Table.Predictions$Age.Class)[levels(Table.Predictions$Age.Class) =="A"] <- "Adult"
head(Table.Predictions)
colnames(Table.Predictions)
        
write.csv(Table.Predictions, file = paste0("./figs_tables/Table. Predictions for 345 species_",Sys.Date(),".csv"), row.names = F)

```

*Published* Scatter plot of predicted FO, highlighting 'priority' species
```{r published_plot_priority_species, echo=FALSE}

# Predicted values come from 
head(prediction.summary_Age)
length(levels(prediction.summary_Age$TipLabel_BirdTree)) # 345 (10 species were excluded because data was not available for one or more of the critical factors)
length(levels(prediction.summary_Age$Common.name_BirdTree))    
colnames(prediction.summary_Age)

# Prelim plot 
plot(prediction.summary_Age$sample.size, prediction.summary_Age$mean)

# Better Plot

# Make wider, colour sample.size = 0 red, add quadrants
    log.small.samples.have.less.than <- log(small.samples.have.less.than)

    
PrioritySpecies <- ggplot(prediction.summary_Age, aes(x = log(sample.size), y = mean.FO)) +
            geom_point(size = 2, shape = 16, aes(colour = factor(priority.highFO.lowN))) + # allows fill
            # geom_point(shape = 16, size = 3, aes(colour = factor(priority))) +
            # geom_point(size = 2, shape, 21, aes(colour = factor(priority))) +
            scale_x_continuous(expand = c(0, 0), limits = c(0,8)) + 
            scale_y_continuous(expand = c(0, 0), limits = c(0,1)) +
            scale_colour_manual(values = c("black", "red")) +
            ylab("Predicted plastic ingestion \n(frequency of occurrence)") +
            xlab("ln(sample size)") +
            title(paste0("Predicted FO of Seabirds. Priority species are those with n < ", small.samples.have.less.than," and FO >",low.FO.is.less.than)) +
    labs(colour="Priority") + # if shape, then shape = "title" +
    theme(axis.title.x = element_text(size=10), 
              axis.title.y = element_text(size=10), 
              axis.text.x = element_text(size= 8), 
              axis.text.y = element_text(size= 8)) +
     geom_vline(xintercept = c(log.small.samples.have.less.than)) +
     geom_hline(yintercept = c(low.FO.is.less.than)) +
     theme(legend.key = element_blank(), strip.background = element_blank()) +
          background_grid(major = "xy", minor = "none") + 
    background_grid(major = "xy", minor = "none") +
        # theme(axis.text=element_text(size=12),
        # axis.title=element_text(size=12)) +
        theme(axis.title.x = element_text(size=10), 
              axis.title.y = element_text(size=10), 
              axis.text.x = element_text(size= 8), 
              axis.text.y = element_text(size= 8)) +
          theme(legend.position = "bottom",
                legend.direction = "horizontal",
                legend.box = "vertical",
                legend.justification = "left",
                legend.box.just = "left",
                legend.margin = margin(6, 6, 6, 6),
                # legend.box.background = element_rect(),
                legend.title = element_text(size = 10),
                legend.text = element_text(size= 8)) 
   
PrioritySpecies

# Add grey shaded area to graph
    AddGreyRectagle <- TRUE
    
    if(AddGreyRectagle == TRUE){
        PrioritySpeciesredo <- PrioritySpecies + 
            annotate("rect", 
                     xmin = -Inf, 
                     xmax = log.small.samples.have.less.than,
                     # xmax = c(subset.sample.size.max), 
                     ymin = low.FO.is.less.than, 
                     ymax = 1, 
                     alpha = 0.5, fill="grey")
            }

PrioritySpeciesredo

ggsave(paste0("./figs_tables/PrioritySpecies_dotplot_",Sys.Date(),".pdf"), width = 10, height = 10, units = "cm")


    
```

Table of priority species
```{r Table.Priority.Species}

# Table of priority species
colnames(prediction.summary_Age)

 Table.priority <- prediction.summary_Age %>%
    filter(priority.highFO.lowN == "Yes") %>%
    select(Common.name_BirdTree,TipLabel_BirdTree, mean.FO:sample.size, emp.meanFO, rangeFO, X2016.IUCN.Red.List.category)
 
 # View(Table.priority)
 nrow(Table.priority) # 79 species have a high FO (>60) and low sample.size (<50)
 
 write.csv(Table.priority, paste0("./figs_tables/Table.Priority.Species_",Sys.Date(),".csv"), row.names = F)

```

Plot FO Â± Credible Interval for each species, ordered by sample size, coloured by priority.
```{r credible_interval_exploration, echo=FALSE}

# PLOT PRIORITY with HPD Intervals
    # Plot a subset of precise FO predictions horizontally, and label as priority or not 
        # precise == range between upper and lower HPD interval ~ 0.15 or less
        # priority == < 100 samples, and FO > 0.50
    df <- prediction.summary_Age %>%
          filter(interval < 0.5) %>% # PINEAPPLE ADJUST HERE?
          filter(sample.size < 100)
    
    nrow(df) # 15
    df
    
    
PriorityPrecisePredictions <- ggplot(df, aes(mean.FO, Common.name_BirdTree)) +       
    geom_point(size = 2, aes(colour = factor(priority.highFO.lowN))) +
    scale_colour_manual(values = c("black", "red")) +
    geom_errorbarh(aes(xmax = upper.HPDinterval, xmin = lower.HPDinterval, height = 0)) +
    labs(
        x = "Predicted frequency of plastic ingestion\n(Â± credible interval)",
        y = "",
        colour = "Priority"
        # shape = "Transmission"
       ) +
    theme(
      legend.position = c(1, 1),
      legend.justification = c("right", "top"),
      legend.box.just = "right",
      legend.margin = margin(6, 6, 6, 6),
      legend.box.background = element_rect(),
      legend.title = element_text(size = 10),
      legend.text = element_text(size= 8)
    ) +
    theme(axis.title.x = element_text(size=10), 
          axis.title.y = element_text(size=10), 
          axis.text.x = element_text(size=8), 
          axis.text.y = element_text(size=8)) +
    # Sort by IUCN status, but hide the labels bc we are using shapes
    facet_grid(Order ~ ., 
       # labeller = ,
       scales = "free_y", 
       space = "free_y") +
    theme(strip.background =element_rect(fill="white")) +
    theme(strip.text = element_text(colour = 'white'))
    
PriorityPrecisePredictions

ggsave(paste0("./figs_tables/PrecisePredictions_w.Priority_",Sys.Date(),".pdf"), width = 15, height = 15, units = "cm")

```

*Published* What order are priority species in? This figure has smaller text (14,12) and is better for manuscripts than posters 
```{r published_Order_Priority_Species, echo=FALSE}

# Plot a subset of precise FO predictions horizontally, and label as priority or not 
        # precise == range between upper and lower HPD interval ~ 0.15 or less
        # priority == < 100 samples, and FO > 0.50
    df <- prediction.summary_Age %>% 
            # filter(interval < 0.5) %>% 
            filter(priority.highFO.lowN == "Yes") %>%
          arrange(desc(Common.name_BirdTree))
    
    nrow(df)
    str(df)
    # Set up alphabetical sps names for plotting
    class(df$Common.name_BirdTree)
    level_order <- (levels(as.factor(df$Common.name_BirdTree)))
    level_order <- as.data.frame(level_order)
    level_order <- level_order %>%  arrange(desc(level_order))
    level_order <- as.vector(level_order$level_order)


Order_Priority_Species <- ggplot(df, aes(x = mean.FO, y = factor(Common.name_BirdTree, levels = level_order))) +
        geom_point(size = 2, colour = "red", aes(shape = factor(Order))) +
        # scale_colour_manual(values = c("red")) +
        # scale_shape_manual(values = c(0,1,2,5,15,16,17,8)) + # ("0","1","2","5","15","16","17","23"
        scale_shape_manual(values = c(19,5,17,1,15,23,25,8)) + # ("0","1","2","5","15","16","17","23"
        geom_errorbarh(aes(xmax = upper.HPDinterval, xmin = lower.HPDinterval), height = 0) +
        labs(
            x = "Predicted frequency of occurrence\n(Â± credible interval)",
            y = "",
            # colour = "Sample Size",
            shape = "Order"
            )  +
          background_grid(major = "xy", minor = "none") +
        # theme(axis.text=element_text(size=12),
        # axis.title=element_text(size=12)) +
        theme(axis.title.x = element_text(size=10), 
              axis.title.y = element_text(size=10), 
              axis.text.x = element_text(size= 8), 
              axis.text.y = element_text(size= 8)) +
          theme(legend.position = "bottom",
                legend.direction = "horizontal",
                legend.box = "vertical",
                legend.justification = "left",
                legend.box.just = "left",
                legend.margin = margin(6, 6, 6, 6),
                # legend.box.background = element_rect(),
                legend.text = element_text(size=8),
                legend.title = element_text(size = 10)) +
    # Sort by IUCN status, but hide the labels bc we are using shapes
    facet_grid(Order ~ ., 
               # labeller = ,
               scales = "free_y", 
               space = "free_y") +
    theme(strip.background =element_rect(fill="white")) +
    theme(strip.text = element_text(colour = 'white')) 
    
Order_Priority_Species + guides(shape=guide_legend(nrow=1,byrow=TRUE))
# rm(Order_Priority_Species)

ggsave(paste0("./figs_tables/Order_Priority_Species_",Sys.Date(),".pdf"), width= 20, height= 35, units="cm")


```

Create a loop that generates a seperate plot for each BLFamilyEnglish, showing prediction w interval for each species.
```{r Loop_generate_BLFamilyEnglish_Species_Prediction_w_HPD, echo=FALSE}

# "Loons/divers" messes up the loop, so here we change the text
df <- prediction.summary_Age %>%
    mutate(BLFamilyEnglish = as.character(BLFamilyEnglish)) %>%
    mutate(BLFamilyEnglish = ifelse(BLFamilyEnglish == "Loons/divers", "Loons, divers", BLFamilyEnglish)) %>%
    mutate(BLFamilyEnglish = as.factor(BLFamilyEnglish))

families <- levels(df$BLFamilyEnglish)


for(i in 1:length(families)){

# print(paste("This graph is",families[i]))

# Subset the data to BLFamilyEnglish of interest
df2 <- df %>%
    filter(BLFamilyEnglish == families[i]) %>%
    droplevels()

nrow(df2)

# Plot BLFamilyEnglish of interest directly to file.   
 ggplot(df2, aes(mean.FO, Common.name_BirdTree)) +   
        geom_point(aes(colour = factor(priority.highFO.lowN))) +
        scale_colour_manual(values = c("black", "red")) +
        geom_errorbarh(aes(xmax = upper.HPDinterval, xmin = lower.HPDinterval, height = 0)) +
        labs(
            title = paste0(families[i]),
            x = "Predicted frequency of occurrence\n(Â± credible interval)",
            y = "",
            colour = "Priority"
            # shape = "Transmission"
           ) +
      theme(legend.position = "none", # c(1, .3),
          legend.justification = c("right", "top"),
          legend.box.just = "right",
          legend.margin = margin(6, 6, 6, 6),
          legend.box.background = element_rect()) +
      theme(axis.title.x = element_text(size=12), 
              axis.title.y = element_text(size=12), 
              axis.text.x = element_text(size=10), 
              axis.text.y = element_text(size=10)) 


# Save each as a separate figure with same dimensions
ggsave(paste0("./figs_tables/Prediction_w_HPD_",families[i],"_",Sys.Date(),".jpeg"), width = 20, height = 30, units = "cm")

}


```

Which species do we predict to have a high FO (>60%)? 
Sort this by BLFamilyEnglish and highlight those with small sample sizes (< 50)
```{r HighFO_Species_by_BLFamilyEnglish, echo=FALSE}

# Create and tidy subset
    # Get subset of relevant species
    subset_highFO <- prediction.summary_Age %>%
        filter(mean.FO > low.FO.is.less.than) %>%
        droplevels()

    dim(subset_highFO)
    # View(subset_highFO)
    
    # Set up alphabetical sps names for plotting
    class(subset_highFO$Common.name_BirdTree)
    level_order <- (levels(as.factor(subset_highFO$Common.name_BirdTree)))
    level_order <- as.data.frame(level_order)
    level_order <- level_order %>%  arrange(desc(level_order))
    level_order <- as.vector(level_order$level_order)

# Here we show species with > 60% predicted FO, with HPD intervals. Sample sizes <50 are highlighted, and the IUCN status is shown. 

HighFOSpecies_by_BLFamilyEnglish <- ggplot(subset_highFO, aes(x = mean.FO, y = factor(Common.name_BirdTree, levels = level_order))) +   
        geom_point(size = 2, aes(colour = factor(small.sample))) +
        # scale_shape_manual(values = c(18,15:17)) +
        scale_colour_manual(values = c("red", "black")) +
        geom_errorbarh(aes(xmax = upper.HPDinterval, xmin = lower.HPDinterval, height = 0)) +
        labs(
                x = "Predicted frequency of occurrence\n(Â± credible interval)",
                y = "",
                colour = "Sample size",
                shape = "BLFamilyEnglish") +
        theme(
              legend.position = "bottom",
              legend.justification = "left",
              legend.box.just = "left",
              legend.margin = margin(0,0,0,0),
              legend.text = element_text(size=8),
              legend.title = element_text(size=10)
              ) + # , legend.box.background = element_rect() # frame the legend
        theme(axis.title.x = element_text(size=10), 
                  axis.title.y = element_text(size=10), 
                  axis.text.x = element_text(size=8), 
                  axis.text.y = element_text(size=10)
              ) +
        # Sort by IUCN status, but hide the labels bc we are using shapes
        facet_grid(BLFamilyEnglish ~ ., 
                       # labeller = ,
                       scales = "free_y", 
                       space = "free_y") +
        theme(strip.background =element_rect(fill="white")) +
        theme(strip.text = element_text(colour = 'white'))

HighFOSpecies_by_BLFamilyEnglish

ggsave(paste0("./figs_tables/HighFOSpecies_by_BLFamilyEnglish_",Sys.Date(),".jpeg"), width = 20, height = 40, units = "cm")

```

Which species do we predict to have a high FO (>60%) AND have a small sample size?? 
Sort this by BLFamilyEnglish and highlight those with small sample sizes (< 50)
```{r HighFO_LowSampleSize_Species_by_BLFamilyEnglish, echo=FALSE}

# Create and tidy subset
    # Get subset of relevant species
    subset <- prediction.summary_Age %>%
        filter(priority.highFO.lowN == "Yes") %>%
        droplevels()

    dim(subset)
    # View(subset)
    
    # Set up alphabetical sps names for plotting
    class(subset$Common.name_BirdTree)
    level_order <- (levels(as.factor(subset$Common.name_BirdTree)))
    level_order <- as.data.frame(level_order)
    level_order <- level_order %>%  arrange(desc(level_order))
    level_order <- as.vector(level_order$level_order)

# Here we show species with > 60% predicted FO, with HPD intervals. Sample sizes <50 are highlighted, and the IUCN status is shown. 

PrioritySpecies_by_BLFamilyEnglish <- ggplot(subset, aes(x = mean.FO, y = factor(Common.name_BirdTree, levels = level_order))) +   
        geom_point(size = 2, aes(colour = factor(small.sample))) +
        # scale_shape_manual(values = c(18,15:17)) +
        scale_colour_manual(values = c("red", "black")) +
        geom_errorbarh(aes(xmax = upper.HPDinterval, xmin = lower.HPDinterval, height = 0)) +
        labs(
                x = "Predicted frequency of occurrence\n(Â± credible interval)",
                y = "",
                colour = "Sample size",
                shape = "BLFamilyEnglish") +
        theme(
              legend.position = "bottom",
              legend.justification = "left",
              legend.box.just = "left",
              legend.margin = margin(0,0,0,0),
              legend.text = element_text(size=8),
              legend.title = element_text(size=10)
              ) + # , legend.box.background = element_rect() # frame the legend
        theme(axis.title.x = element_text(size=10), 
                  axis.title.y = element_text(size=10), 
                  axis.text.x = element_text(size=8), 
                  axis.text.y = element_text(size=10)
              ) +
        # Sort by IUCN status, but hide the labels bc we are using shapes
        facet_grid(BLFamilyEnglish ~ ., 
                       # labeller = ,
                       scales = "free_y", 
                       space = "free_y") +
        theme(strip.background =element_rect(fill="white")) +
        theme(strip.text = element_text(colour = 'white'))

PrioritySpecies_by_BLFamilyEnglish

ggsave(paste0("./figs_tables/PrioirtySpecies_by_BLFamilyEnglish_",Sys.Date(),".jpeg"), width = 20, height = 35, units = "cm")

```

*Published, main text*
Which (Latin) Family Groups have the highest predicted FO? Weighted FO?
(saved figure has both predicted and empirical stacked in one image)
```{r published_Family_Latin_FO_means.SD, echo=FALSE}

# Predicted Values
detach(package:plyr)
str(prediction.summary_Age)


predict.family <- prediction.summary_Age %>%
    group_by(BLFamilyLatin, Order) %>%
    summarise(mean = mean(mean.FO), 
              SD = sd(mean.FO)) %>%
    arrange(BLFamilyLatin) %>%
    mutate(SD = ifelse(is.na(SD), 0, SD))

predict.family

sps.per.family.predict <- prediction.summary_Age %>%
    group_by(BLFamilyLatin) %>%
    count()

sps.per.family.predict

predict.family <- left_join(predict.family, sps.per.family.predict, by = "BLFamilyLatin")
# View(predict.family)
predict.family <- predict.family %>%
    arrange(desc(mean))

x <- as.vector(predict.family$BLFamilyLatin)
x 
predict.family$BLFamilyLatin<- as.character(predict.family$BLFamilyLatin)

predict.family


level_order <- c("Scolopacidae",      "Procellariidae",    "Diomedeidae"    ,   "Pelecanidae"  ,    "Laridae"    ,       "Sulidae"    ,       "Hydrobatidae"   ,   "Fregatidae"  ,      "Stercorariidae"   , "Phaethontidae"  ,   "Oceanitidae"     ,  "Spheniscidae"   ,   "Gaviidae"        ,  "Anatidae"   ,       "Phalacrocoracidae" ,"Alcidae"    )


predict.family2 <- ggplot(predict.family, aes(x = mean, y = factor(BLFamilyLatin, levels = level_order))) + 
        geom_point(size = 3, shape = 16, aes(colour = Order)) +
        scale_colour_manual(values=c("#73D055FF", "#482677FF", "#33638DFF",  "#404788FF", "#3CBB75FF", "#404788FF", "#1F968BFF", "#DCE319FF")) +
        expand_limits(x = c(0,1)) +
        geom_errorbarh(aes(xmax = mean + SD, xmin = mean - SD), height = 0) +
        labs(
            x = "Predicted mean frequency of occurrence\nof plastic ingestion (Â± SD)",
            y = "Family",
            colour = ""
            )  +
          background_grid(major = "xy", minor = "none") +
        # theme(axis.text=element_text(size=12),
        # axis.title=element_text(size=12)) +
        theme(axis.title.x = element_text(size=10), 
              axis.title.y = element_text(size=10), 
              axis.text.x = element_text(size=8), 
              axis.text.y = element_text(size=8)) +
        theme(legend.position="none") # No legend (show in Empirical below only)
    
predict.family2 


# Empirical Values
empirical.family <- prediction.summary_Age %>%
    group_by(BLFamilyLatin, Order) %>%
    summarise(mean = mean(emp.meanFO, na.rm = T), #  CHANGED FROM   summarise(mean = mean(weighted.FO, na.rm = T), 
              SD = sd(emp.meanFO, na.rm = T)) %>%
    arrange(BLFamilyLatin) %>%
    mutate(SD = ifelse(is.na(SD), 0, SD))

empirical.family

sps.per.family.empirical <- prediction.summary_Age %>%
    filter(sample.size > 0) %>%
    group_by(BLFamilyLatin) %>%
    count()

sps.per.family.empirical

empirical.family <- left_join(empirical.family, sps.per.family.empirical, by = "BLFamilyLatin")
empirical.family

empirical.family <- empirical.family %>%
    arrange(desc(mean))

empirical.family$BLFamilyLatin<- as.character(empirical.family$BLFamilyLatin)

empirical.family2 <- ggplot(empirical.family, aes(mean, factor(BLFamilyLatin, levels = level_order))) + 
        geom_point(size = 3, shape = 16, aes(colour = Order)) +
        scale_colour_manual(values=c("#73D055FF", "#482677FF", "#33638DFF",  "#404788FF", "#3CBB75FF", "#404788FF", "#1F968BFF", "#DCE319FF")) +
    expand_limits(x = c(0,1)) +
        geom_errorbarh(aes(xmax = mean + SD, xmin = mean - SD), height = 0) +
        labs(
            x = "Empirical mean frequency of occurrence\nof plastic ingestion (Â± SD)",
            y = "Family",
            colour = "Order")  +
          background_grid(major = "xy", minor = "none") +
       theme(axis.title.x = element_text(size=10), 
              axis.title.y = element_text(size=10), 
              axis.text.x = element_text(size=8), 
              axis.text.y = element_text(size=8))  +
    theme(
    legend.position = c(1, 1),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(3,3,3,3),
    legend.text = element_text(size=8),
    legend.title = element_text(size=8),
    legend.background = element_rect(color = "black", 
    size = 0.3, linetype = "solid"))
  
empirical.family2       
            ## Legend on the outside
            # theme(
            #  legend.direction = "horizontal",
            #  legend.position = "centre",
            #  legend.box = "vertical",
            #  legend.justification = "left",
            #  legend.box.just = "left",
            #  legend.margin = margin(0,0,0,0),
            #  legend.text = element_text(size=8),
            #  legend.title = element_text(size=10)) # , legend.box.background = element_rect() # frame the legend

# This shows the figures side by side, so we can see that the predictions aren't so far off of the empirical data
require(gridExtra)
plot1 <- predict.family2
plot2 <- empirical.family2

grid.arrange(plot2, plot1, ncol=1)

# library("ggpubr") # built under R version 3.4.4
# ggarrange(plot1, plot2, ncol = 1, nrow = 2,  labels = c("A", "B"),
          # common.legend = TRUE, legend = "right", font.label = list(size = 8))

BLFamilyLatin_FO_means.SD.compare <- arrangeGrob(plot2, plot1, ncol=1)

ggsave(paste0("./figs_tables/BLFamilyLatin_FO_means.SD.compare_COLOUR_",Sys.Date(),".pdf"),  BLFamilyLatin_FO_means.SD.compare, width = 12, height = 20, units = "cm")



```

```{r published_Family_latin_FO_means.SD_TABLE}

# Create a table that shows empirical and predicted values side by side. 

predict.family <- select(predict.family, -Order)
Family.Stats <- left_join(empirical.family, predict.family, by = "BLFamilyLatin")
Family.Stats

Family.Stats2 <- Family.Stats %>%
    mutate(Predicted.Mean.FO.SD.n = paste0(round(mean.y, digits = 3), " Â± ", round(SD.y, digits = 3)," (", n.y,")"),
              Empirical.Mean.FO.SD.n = paste0(round(mean.x, digits = 3), " Â± ", round(SD.x, digits = 3)," (", n.x, ")")) %>%
    as.data.frame(Family.Stats2) %>%
    # dplyr::select(1, 5, 9, 10)
    dplyr::select(BLFamilyLatin, Order, Predicted.Mean.FO.SD.n, Empirical.Mean.FO.SD.n)

Family.Stats2
Family.Stats2 <- arrange(Family.Stats2, desc(Predicted.Mean.FO.SD.n))
Family.Stats2

Family.Stats2$BLFamilyLatin<- as.character(Family.Stats2$BLFamilyLatin)

levels(Family.Stats2$BLFamilyLatin)

Family.Stats2

eng <- prediction.summary_Age %>%
    dplyr::select(BLFamilyLatin, BLFamilyEnglish) %>%
    distinct()
eng
Family.Stats3 <- left_join(Family.Stats2, eng, by = "BLFamilyLatin")
Family.Stats3 <- dplyr::select(Family.Stats3, BLFamilyLatin, BLFamilyEnglish, everything())
Family.Stats3
write.csv(Family.Stats3, file = paste0("./figs_tables/BLFamilyLatin_FO_means.SD_",Sys.Date(),".csv"), row.names = FALSE)

# We do not expect that empirical estiamtes will be the same as predictions because emp.mean includes ssamples from across the decades, and age classes while predictions are for adults in 2010. 

```

Among CE, E and VU listed species, which do we predict to have a high FO (>60%)? Sort this by IUCN.Status and highlight those with small sample sizes (< 50)
```{r IUCN_Priority_Species, echo=FALSE}

# Create and tidy subset
    # Get subset of relevant species
    subset <- prediction.summary_Age %>%
        filter(X2016.IUCN.Red.List.category %in% c("CR (PE)", "CR", "EN")) %>% # This is where you add remove categories!
        droplevels()# %>%
        # filter(mean.FO > 0.6) 
    table(subset$X2016.IUCN.Red.List.category)


    # Reorder levels for IUCN 
    subset$X2016.IUCN.Red.List.category <- factor(subset$X2016.IUCN.Red.List.category, levels = c("CR (PE)", "CR", "EN", "VU"))
    
    subset$X2016.IUCN.Red.List.category <- recode(subset$X2016.IUCN.Red.List.category, "CR (PE)" = "Presumed Extinct", "CR" = "Critically Endangered", "EN" = "Endangered", "VU" = "Vulnerable")
        table(subset$X2016.IUCN.Red.List.category)

    # Set up alphabetical sps names for plotting
    class(subset$Common.name_BirdTree)
    level_order <- (levels(as.factor(subset$Common.name_BirdTree)))
    level_order <- as.data.frame(level_order)
    level_order <- level_order %>%  arrange(desc(level_order))
    level_order <- as.vector(level_order$level_order)

# Here we show species with > 60% predicted FO, with HPD intervals. Sample sizes <50 are highlighted, and the IUCN status is shown. 

IUCN_Priority_Species <- ggplot(subset, aes(x = mean.FO, y = factor(Common.name_BirdTree, levels = level_order))) +   
        geom_point(size = 3, aes(colour = factor(small.sample), shape = factor( X2016.IUCN.Red.List.category))) +
        scale_shape_manual(values = c(15:17)) +
        scale_colour_manual(values = c("red", "black")) +
        geom_errorbarh(aes(xmax = upper.HPDinterval, xmin = lower.HPDinterval, height = 0)) +
        labs(
                x = "Predicted frequency of occurrence\n(Â± credible interval)",
                y = "Species (grouped by IUCN Status)",
                colour = "Sample size",
                shape = "IUCN status") +
        theme(
              legend.direction = "horizontal",
              legend.position = "bottom", 
              legend.box = "vertical",
              legend.justification = "left",
              legend.box.just = "left",
              legend.margin = margin(0,0,0,0),
              legend.text = element_text(size=8),
              legend.title = element_text(size=10)) + # , legend.box.background = element_rect() # frame the legend
        theme(axis.title.x = element_text(size=10), 
                  axis.title.y = element_text(size=10), 
                  axis.text.x = element_text(size=8), 
                  axis.text.y = element_text(size=8)
              ) +
        # Sort by IUCN status, but hide the labels bc we are using shapes
        facet_grid(X2016.IUCN.Red.List.category ~ ., 
                       # labeller = X2016.IUCN.Red.List.category,
                       scales = "free_y", 
                       space = "free_y") +
        theme(strip.background =element_rect(fill="white")) +
        theme(strip.text = element_text(colour = 'white'))

IUCN_Priority_Species

ggsave(paste0("./figs_tables/IUCN_Priority_Species_",Sys.Date(),".pdf"), width = 25, height = 20, units = "cm")



```

*Published, main text*
This script uses the data used in the ASREML analysis to present mean frequency of occurence of plastic ingestion across all studies for 209 species, and for all fixed factors
```{r published_Phylogenetic_tree_meanFO_empirical}

# STOP!
# STOP! Make plot console very large - This figure must be saved manually, and needs enough space to load
# STOP!

# # reset plot device if need be
# dev.off()
# dev.new()

# datanoNAS and tree loaded earlier

colnames(datanoNAs)
unique(datanoNAs$Feeding.Method)

plot.error.bars <- TRUE

data.2 <- datanoNAs %>%
    mutate(TipLabel = TipLabel_BirdTree) %>%
    filter(!is.na(Source)) %>%
    filter(!is.na(FO))# remove species where there is no empirical plastic data
colnames(data.2)

# # Reverse Rainbow
# col.PROCELLARIIFORMES <- "red"
# col.SPHENISCIFORMES <- "orange"
# col.SULIFORMES <- "gold"
# col.PELECANIFORMES <- "green4" # "yellow"
# col.GAVIIFORMES <- "forest green" #green"
# col.PHAETHONTIFORMES <- "dodgerblue"
# col.CHARADRIIFORMES <- "darkblue" # "indigo"
# col.ANSERIFORMES <- "purple4"

# Mimicing viridis colour palette for colour blindness
# https://www.thinkingondata.com/something-about-viridis-library/
col.PROCELLARIIFORMES <- "#482677FF"
col.SPHENISCIFORMES <- "#404788FF"
col.SULIFORMES <- "#404788FF"
col.PELECANIFORMES <- "#33638DFF" # "yellow"
col.GAVIIFORMES <- "#1F968BFF" #green"
col.PHAETHONTIFORMES <- "#3CBB75FF"
col.CHARADRIIFORMES <- "#73D055FF" # "indigo"
col.ANSERIFORMES <- "#DCE319FF"

col.significant <- "black"
col.not.significant <- "grey50"

tree.plot.colours <- data.frame(c(col.ANSERIFORMES, col.CHARADRIIFORMES, col.GAVIIFORMES,
                                  col.PHAETHONTIFORMES, col.PROCELLARIIFORMES, col.SPHENISCIFORMES, col.SULIFORMES, col.PELECANIFORMES))

row.names(tree.plot.colours) <- c("ANSERIFORMES", "CHARADRIIFORMES", "GAVIIFORMES",
                                  "PHAETHONTIFORMES", "PROCELLARIIFORMES", "SPHENISCIFORMES",
                                  "SULIFORMES", "PELECANIFORMES")


axis.space.large <- 0.19
axis.space.med   <- 0.115
axis.space.large <- 0.085


# 1. (A) nocturnal
# 2. (D) Opportunistic
# 3. (H) Age
# 4. (I) Order
# 5. (F) Feeding method
# 6. (G) Year
# 7. (E) Diet
# 8. (C) Sample size
# 9. (B) Mass
# 10. (J) Phylogeny 

layout.matrix <- matrix(nrow = 3,
                        data = c(1,1,1,   9,9,9, 8,8,8, 10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,  
                                 2,2,2,  7,7,7, 6,6,6, 10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,  
                                 5,5,5,  3,3,3, 4,4,4, 10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10), 
                        byrow = TRUE)


# Set up figure and do barplots
layout(mat = layout.matrix)

main.plot.mar <- c(6,0,0,0) + 0.5
par(mar = main.plot.mar, oma = c(6,4,0,0), xpd = TRUE)

# 1. nocturnal
summary.nocturnal <- plyr::ddply(data.2, c("Nocturnal.Foraging"), summarise,
                           N    = length(FO),
                           mean = mean(FO, na.rm = TRUE),
                           sd   = sd(FO, na.rm = TRUE),
                           se   = sd / sqrt(N))
summary.nocturnal <- summary.nocturnal %>%
    arrange(mean)
bp <- barplot(height = summary.nocturnal$mean, ylim = c(0,1),
              ylab = "", # expression(bold("Proportion that ingest plastic              ")),
              xlim = c(0.1,2.35),
              names.arg = summary.nocturnal$Nocturnal.Foraging, 
              col = col.not.significant, border = col.not.significant,
              axes = F,
              las = 2)
axis(side = 2, las = 1, at = c(0,0.5,1), lwd = 1.5)
text(x = par("usr")[1] + axis.space.large * (par("usr")[2] - par("usr")[1]), 
     y = 0.95, labels = "(A)")
mtext(side = 1, text = expression("Nocturnality"), line = -10, cex = 0.7)
if(plot.error.bars == TRUE){
  arrows(x0 = bp[,1], x1 = bp[,1],
         y0 = summary.nocturnal$mean,
         y1 = summary.nocturnal$mean + summary.nocturnal$se,
         col = col.significant,
         lwd = 1.5, length = 0)
}

# 2. Opportunistic
summary.opportunistic <- plyr::ddply(data.2, c("Opportunistic.Inferred"), summarise,
                               N    = length(FO),
                               mean = mean(FO, na.rm = TRUE),
                               sd   = sd(FO, na.rm = TRUE),
                               se   = sd / sqrt(N))
summary.opportunistic <- summary.opportunistic %>%
    arrange(mean)
bp <- barplot(height = summary.opportunistic$mean, ylim = c(0,1),
              ylab = "", # expression(bold("Proportion that ingest plastic              ")),
              names.arg = summary.opportunistic$Opportunistic.Inferred, 
              col = col.not.significant, border = col.not.significant,
              xlim = c(0.1,2.35),
              axes = F,
              las = 2)

axis(side = 2, las = 1, at = c(0,0.5,1), lwd = 1.5)
text(x = par("usr")[1] + axis.space.large * (par("usr")[2] - par("usr")[1]), 
     y = 0.95, labels = "(D)")

mtext(side = 1, text = expression("Opportunistic"), line = -10, cex = 0.7)
mtext(text = expression("Frequency of occurrence of plastic ingestion (Â± SD)"),
      side = 2, line = 3, cex = 0.8)
if(plot.error.bars == TRUE){
  arrows(x0 = bp[,1], x1 = bp[,1],
         y0 = summary.opportunistic$mean,
         y1 = summary.opportunistic$mean + summary.opportunistic$se,
         col = col.not.significant,
         lwd = 1.5, length = 0)
}

# 3. Age
summary.age.class <- plyr::ddply(data.2, c("Age.Class"), summarise,
                           N    = length(FO),
                           mean = mean(FO, na.rm = TRUE),
                           sd   = sd(FO, na.rm = TRUE),
                           se   = sd / sqrt(N))

levels(summary.age.class$Age.Class)[levels(summary.age.class$Age.Class) =="A"] <- "Adult"
levels(summary.age.class$Age.Class)[levels(summary.age.class$Age.Class) =="SA"] <- "Subadult"
levels(summary.age.class$Age.Class)[levels(summary.age.class$Age.Class) =="SA_A"] <- "Subadult/Adult"

summary.age.class <- summary.age.class %>%
    arrange(mean)
bp <- barplot(height = summary.age.class$mean, ylim = c(0,1),
              ylab = "", # expression(bold("Proportion that ingest plastic              ")),
              axes = F,
              col = col.significant, border = col.significant,
              names.arg = summary.age.class$Age.Class, las = 2)
axis(side = 2, las = 1, at = c(0,0.5,1), lwd = 1.5, labels = NA)
text(x = par("usr")[1] + axis.space.large * (par("usr")[2] - par("usr")[1]), 
     y = 0.95, labels = "(H)")
mtext(side = 1, text = expression("Age"), line = -10, cex = 0.7)
if(plot.error.bars == TRUE){
  arrows(x0 = bp[,1], x1 = bp[,1],
         y0 = summary.age.class$mean,
         y1 = summary.age.class$mean + summary.age.class$se,
         col = col.not.significant,
         lwd = 1.5, length = 0)
}


# 4. Order

# # Reverse Rainbow
# col.PROCELLARIIFORMES <- "red"
# col.SPHENISCIFORMES <- "orange"
# col.SULIFORMES <- "gold"
# col.PELECANIFORMES <- "yellow" # "yellow"
# col.GAVIIFORMES <- "forest green" #green"
# col.PHAETHONTIFORMES <- "dodgerblue"
# col.CHARADRIIFORMES <- "darkblue" # "indigo"
# col.ANSERIFORMES <- "purple4"

# Mimicing viridis colour palette for colour blindness
# # https://www.thinkingondata.com/something-about-viridis-library/
col.PROCELLARIIFORMES <- "#482677FF"
col.SPHENISCIFORMES <- "#404788FF"
col.SULIFORMES <- "#404788FF"
col.PELECANIFORMES <- "#33638DFF"
col.GAVIIFORMES <- "#1F968BFF" 
col.PHAETHONTIFORMES <- "#3CBB75FF"
col.CHARADRIIFORMES <- "#73D055FF" 
col.ANSERIFORMES <- "#DCE319FF" # copy this to line 557 otherwise one branch is pink clcolr[all]    <- "#DCE319FF"

summary.order <- plyr::ddply(data.2, c("Order"), summarise,
                       N    = length(FO),
                       mean = mean(FO, na.rm = TRUE),
                       sd   = sd(FO, na.rm = TRUE),
                       se   = sd / sqrt(N))


summary.order$Order <- forcats::fct_relevel(summary.order$Order, levels = c( "ANSERIFORMES","CHARADRIIFORMES","PHAETHONTIFORMES","GAVIIFORMES","PELECANIFORMES","SULIFORMES","SPHENISCIFORMES","PROCELLARIIFORMES"))
summary.order <- summary.order[order(summary.order$Order), ]

summary.order <- summary.order %>%
    mutate(Order = str_to_title(Order))

mp <- barplot(height = summary.order$mean, ylim = c(0,1),
              ylab = "", 
              axes = F, 
              col = c(col.ANSERIFORMES, col.CHARADRIIFORMES, 
                      col.PHAETHONTIFORMES, col.GAVIIFORMES, 
                      col.PELECANIFORMES,
                      col.SULIFORMES, col.SPHENISCIFORMES,
                      col.PROCELLARIIFORMES),
              border = c(col.ANSERIFORMES, col.CHARADRIIFORMES, 
                         col.PHAETHONTIFORMES, col.GAVIIFORMES, 
                         col.PELECANIFORMES,
                         col.SULIFORMES, col.SPHENISCIFORMES,
                         col.PROCELLARIIFORMES),
              names.arg = summary.order$Order, 
              las = 2)

col.tick.labels <- c(col.ANSERIFORMES, col.CHARADRIIFORMES, 
                     col.PHAETHONTIFORMES, col.GAVIIFORMES, 
                     col.PELECANIFORMES,
                     col.SULIFORMES, col.SPHENISCIFORMES,
                     col.PROCELLARIIFORMES)
axis(side = 2, las = 1, at = c(0,0.5,1), lwd = 1.5, labels = NA)
text(x = par("usr")[1] + axis.space.large * (par("usr")[2] - par("usr")[1]), 
     y = 0.95, labels = "(I)")

for(i in 1:length(col.tick.labels)){ 
    axis(side = 1, las = 1, at = mp[i], las = 2,
       lwd = NA,
       labels = levels(data$Order)[i],
       col.axis = col.tick.labels[i]) 
                                    }
mtext(side = 1, text = expression("Order"), line = -10, cex = 0.7)
if(plot.error.bars == TRUE){
  arrows(x0 = mp[,1], x1 = mp[,1],
         y0 = summary.order$mean,
         y1 = summary.order$mean + summary.order$se,
         col = col.tick.labels,
         lwd = 1.5, length = 0)
}



# $. Feeding method

summary.feeding <- plyr::ddply(data.2, c("Feeding.Method"), summarise,
                           N    = length(FO),
                           mean = mean(FO, na.rm = TRUE),
                           sd   = sd(FO, na.rm = TRUE),
                           se   = sd / sqrt(N))
summary.feeding <- summary.feeding %>%
    arrange(mean)
bp <- barplot(height = summary.feeding$mean, ylim = c(0,1),
              ylab = "", #expression(bold("Proportion that ingest plastic              ")),
              axes = F, #xlim = c(0.1,2.35),
              col = col.significant, border = col.significant,
              names.arg = summary.feeding$Feeding.Method, las = 2)
axis(side = 2, las = 1, at = c(0,0.5,1), 
     lwd = 1.5)
text(x = par("usr")[1] + axis.space.large * (par("usr")[2] - par("usr")[1]), 
     y = 0.95, labels = "(G)")
mtext(side = 1, text = expression("Foraging Method"), line = -10, cex = 0.7)
if(plot.error.bars == TRUE){
  arrows(x0 = bp[,1], x1 = bp[,1],
         y0 = summary.feeding$mean,
         y1 = summary.feeding$mean + summary.feeding$se,
         col = col.significant,
         lwd = 1.5, length = 0)
}



# 6. Year
summary.date <- plyr::ddply(data.2, c("Date_Decade"), summarise,
                      N    = length(FO),
                      mean = mean(FO, na.rm = TRUE),
                      sd   = sd(FO, na.rm = TRUE),
                      se   = sd / sqrt(N))
bp <- barplot(height = summary.date$mean, ylim = c(0,1),
              ylab = "", #expression(bold("Proportion that ingest plastic              ")),
              axes = F,
              col = col.significant, border = col.significant,
              names.arg = summary.date$Date_Decade, las = 2)

axis(side = 2, las = 1, at = c(0,0.5,1), labels = NA,
     lwd = 1.5)
text(x = par("usr")[1] + axis.space.large * (par("usr")[2] - par("usr")[1]), 
     y = 0.95, labels = "(F)")
mtext(side = 1, text = expression("Decade"), line = -10, cex = 0.7)
if(plot.error.bars == TRUE){
  arrows(x0 = bp[,1], x1 = bp[,1],
         y0 = summary.date$mean,
         y1 = summary.date$mean + summary.date$se,
         col = col.not.significant,
         lwd = 1.5, length = 0)
}



# 7. Diet
summary.diet <- plyr::ddply(data.2, c("Diet"), summarise,
                      N    = length(FO),
                      mean = mean(FO, na.rm = TRUE),
                      sd   = sd(FO, na.rm = TRUE),
                      se   = sd / sqrt(N))
summary.diet <- summary.diet %>%
    arrange(mean)
bp <- barplot(height = summary.diet$mean, ylim = c(0,1),
              ylab = "", #expression(bold("Proportion that ingest plastic              ")),
              axes = F, #xlim = c(0.1,2.35),
              col = col.significant, border = col.significant,
              names.arg = summary.diet$Diet, las = 2)
#text(bp,summary.diet$mean,summary.diet$N,col="black",pos=3, cex = 0.75)
axis(side = 2, las = 1, at = c(0,0.5,1), lwd = 1.5, labels = NA)
text(x = par("usr")[1] + axis.space.large * (par("usr")[2] - par("usr")[1]), 
     y = 0.95, labels = "(E)")
mtext(side = 1, text = expression("Diet"), line = -10, cex = 0.7)
if(plot.error.bars == TRUE){
  arrows(x0 = bp[,1], x1 = bp[,1],
         y0 = summary.diet$mean,
         y1 = summary.diet$mean + summary.diet$se,
         col = col.not.significant,
         lwd = 1.5, length = 0)
}

# 8. Sample size
level_order <- c("1","2","3","4","5","6-10","10-20","21-50","51-100",">100")
    
    
summary.sample.size <- plyr::ddply(data.2, c("n_bins"), 
                            summarise,
                             N    = length(FO),
                             mean = mean(FO, na.rm = TRUE),
                             sd   = sd(FO, na.rm = TRUE),
                             se   = sd / sqrt(N))


summary.sample.size$n_bins <- fct_relevel(summary.sample.size$n_bins, "1","2","3","4","5","6-10","11-20","21-50","51-100",">100")


summary.sample.size <- arrange(summary.sample.size, n_bins)

bp <- barplot(height = summary.sample.size$mean, ylim = c(0,1),
              ylab = "", #expression(bold("Proportion that ingest plastic              ")),
              axes = F,
              col = col.not.significant, border = col.not.significant,
              names.arg = summary.sample.size$n_bins, las = 2)
axis(side = 2, las = 1, at = c(0,0.5,1), labels = NA,
     lwd = 1.5)
text(x = par("usr")[1] + axis.space.large * (par("usr")[2] - par("usr")[1]), 
     y = 0.95, labels = "(C)")
mtext(side = 1, text = expression("Sample Size"), line = -10, cex = 0.7)
if(plot.error.bars == TRUE){
  arrows(x0 = bp[,1], x1 = bp[,1],
         y0 = summary.sample.size$mean,
         y1 = summary.sample.size$mean + summary.sample.size$se,
         col = col.significant,
         lwd = 1.5, length = 0)
}

# 9. Mass
summary.mass <- plyr::ddply(data.2, c("mass_bin"), summarise,
                      N    = length(FO),
                      mean = mean(FO, na.rm = TRUE),
                      sd   = sd(FO, na.rm = TRUE),
                      se   = sd / sqrt(N))
bp <- barplot(height = summary.mass$mean, ylim = c(0,1),
              ylab = "", #expression(bold("Proportion that ingest plastic              ")),
              axes = F,
              col = col.not.significant, border = col.not.significant,
              names.arg = summary.mass$mass_bin, las = 2)

axis(side = 2, las = 1, at = c(0,0.5,1), labels = NA,
     lwd = 1.5)
text(x = par("usr")[1] + axis.space.large * (par("usr")[2] - par("usr")[1]), 
     y = 0.95, labels = "(B)")


mtext(side = 1, text = expression("Bird Mass (g)"), line = -10, cex = 0.7)
if(plot.error.bars == TRUE){
  arrows(x0 = bp[,1], x1 = bp[,1],
         y0 = summary.mass$mean,
         y1 = summary.mass$mean + summary.mass$se,
         col = col.not.significant,
         lwd = 1.5, length = 0)
}

# Phylogeny 

# Match tips and species
#data.2<-data.2[tree.2$tip.label,]

#Set aside original data file
data.original <- data

#Match tips and species
#data.2<-data.2[tree.2$tip.label,]

#Set aside original data file
data.original <- data.2

#My own version of the code from here:
#http://blog.phytools.org/2014/05/plotting-bars-at-tips-of-circular-tree.html

plot.tree <- compute.brlen(tree, method = "Grafen", power = 1/2)
plot.tree <- ladderize(plot.tree, right = TRUE)

treeheight <- max(nodeHeights(plot.tree))

plot.data <- plyr::ddply(data.2, c("TipLabel"), summarise,
                         N    = length(FO),
                         mean = mean(FO, na.rm = TRUE),
                         sd   = sd(FO, na.rm = TRUE),
                         se   = sd / sqrt(N))


plot.data$Order <- NA
for(i in 1:nrow(plot.data)){
  plot.data$Order[i] <- as.character(data.2$Order[data.2$TipLabel == plot.data$TipLabel[i]][1])
}
row.names(plot.data) <- as.character(plot.data$TipLabel)

#Species missing from the tree
plot.data <- droplevels(plot.data)
plot.data$TipLabel <- as.factor(plot.data$TipLabel)
species.list <- as.character(levels(plot.data$TipLabel))
species.list[!species.list %in% plot.tree$tip.label]

#Remove tips for species that are not in the data set for plotting
plot.tree <- drop.tip(plot.tree, tip = plot.tree$tip.label[!plot.tree$tip.label %in% plot.data$TipLabel])

plot.data <- plot.data[plot.tree$tip.label,]

plot.data$col <- NA
plot.data$col[plot.data$Order == "ANSERIFORMES"] <- col.ANSERIFORMES
plot.data$col[plot.data$Order == "CHARADRIIFORMES"] <- col.CHARADRIIFORMES
plot.data$col[plot.data$Order == "GAVIIFORMES"] <- col.GAVIIFORMES
plot.data$col[plot.data$Order == "PHAETHONTIFORMES"] <- col.PHAETHONTIFORMES
plot.data$col[plot.data$Order == "PROCELLARIIFORMES"] <- col.PROCELLARIIFORMES
plot.data$col[plot.data$Order == "SPHENISCIFORMES"] <- col.SPHENISCIFORMES
plot.data$col[plot.data$Order == "SULIFORMES"] <- col.SULIFORMES
plot.data$col[plot.data$Order == "PELECANIFORMES"] <- col.PELECANIFORMES

col1 <- plot.data$col

head(plot.tree$tip.label)
head(plot.data)

tree.angle <- 270
tree.start <- 180 #0 in North, 180 is south (This bit doesn't work yet)

#Get the colours
ANSERIFORMES_edge      <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "ANSERIFORMES")))
CHARADRIIFORMES_edge   <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "CHARADRIIFORMES")))
GAVIIFORMES_edge       <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "GAVIIFORMES")))
PHAETHONTIFORMES_edge  <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "PHAETHONTIFORMES")))
PROCELLARIIFORMES_edge <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "PROCELLARIIFORMES")))
SPHENISCIFORMES_edge   <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "SPHENISCIFORMES")))
SULIFORMES_edge        <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "SULIFORMES")))
PELECANIFORMES_edge    <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "PELECANIFORMES")))
all                    <- which.edge(plot.tree, group = row.names(plot.data))

ANSERIFORMES_edge      <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "ANSERIFORMES")))
CHARADRIIFORMES_edge   <- which.edge(plot.tree, group = row.names(subset(plot.data, Order != "ANSERIFORMES")))
PHAETHONTIFORMES_edge  <- which.edge(plot.tree, group = row.names(subset(plot.data, !(Order == "CHARADRIIFORMES" | Order == "ANSERIFORMES"))))
GAVIIFORMES_edge       <- which.edge(plot.tree, group = row.names(subset(plot.data, !(Order == "ANSERIFORMES" | Order == "CHARADRIIFORMES" |
                                                                                        Order == "PHAETHONTIFORMES"))))
PELECANIFORMES_edge    <- which.edge(plot.tree, group = row.names(subset(plot.data, !(Order == "ANSERIFORMES" | Order == "CHARADRIIFORMES" |
                                                                                        Order == "PHAETHONTIFORMES" | Order == "GAVIIFORMES"))))
SULIFORMES_edge        <- which.edge(plot.tree, group = row.names(subset(plot.data, !(Order == "ANSERIFORMES" | Order == "CHARADRIIFORMES" |
                                                                                        Order == "PHAETHONTIFORMES" | Order == "GAVIIFORMES" |
                                                                                        Order == "PELECANIFORMES"))))
SPHENISCIFORMES_edge   <- which.edge(plot.tree, group = row.names(subset(plot.data, !(Order == "ANSERIFORMES" | Order == "CHARADRIIFORMES" |
                                                                                        Order == "PHAETHONTIFORMES" | Order == "GAVIIFORMES" |
                                                                                        Order == "PELECANIFORMES" | Order == "SULIFORMES"))))
PROCELLARIIFORMES_edge <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "PROCELLARIIFORMES")))

#Colours for the tree
clcolr<-rep(as.character(tree.plot.colours["ANSERIFORMES",]), dim(plot.tree$edge)[1]) #vector as long as the first edge column and populating it with the colour for insects
clcolr[all]    <- "#DCE319FF" #as.character(tree.plot.colours["ANSERIFORMES",])   # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
clcolr[ANSERIFORMES_edge]      <-as.character(tree.plot.colours["ANSERIFORMES",])   # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
clcolr[CHARADRIIFORMES_edge]   <-as.character(tree.plot.colours["CHARADRIIFORMES",])   # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
clcolr[PHAETHONTIFORMES_edge]  <-as.character(tree.plot.colours["PHAETHONTIFORMES",])   # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
clcolr[GAVIIFORMES_edge]       <-as.character(tree.plot.colours["GAVIIFORMES",])   # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
clcolr[PELECANIFORMES_edge]    <-as.character(tree.plot.colours["PELECANIFORMES",])   # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
clcolr[SULIFORMES_edge]        <-as.character(tree.plot.colours["SULIFORMES",])   # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
clcolr[SPHENISCIFORMES_edge]   <-as.character(tree.plot.colours["SPHENISCIFORMES",]) # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
clcolr[PROCELLARIIFORMES_edge] <-as.character(tree.plot.colours["PROCELLARIIFORMES",]) # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not


par(mar = c(5,5,5,5) + 3, xpd = NA)

# (phylo.plot is from ape package)
plot(plot.tree, type = "fan", open.angle = 360 - tree.angle, rotate = 270, 
     root.edge = TRUE, 
     show.tip.label = T, label.offset = .36, cex = 0.7, tip.color = col1,
     edge.width = 1, font = 3, 
     x.lim = c(-1 * treeheight, 1.2 * treeheight), 
     y.lim = c(-1 * treeheight, 1.2 * treeheight), 
     edge.color = clcolr)
text(x = -1.55, # par("usr")[1] + 0.99* (par("usr")[2] - par("usr")[1]),
     y = 1.6,   # par("usr")[3] + 0.99* (par("usr")[4] - par("usr")[3]),
          labels = "(J)")


### Draw Prediction bars, background and labels

# Draw background
theta.start <- -0.5*(pi/180)*tree.angle/nrow(plot.data) + (pi/180)*tree.start
theta.subtend <- abs(2*theta.start)

bar.scale <- 0.3 #Multiplication factor for the bars
bar.offset <- 0.03 #Offset to add white space between the bars and the tree, to separate the colours

x.bg       <- sin(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset)
y.bg       <- cos(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset)
x.bg.outer <- sin(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (bar.scale*treeheight))
y.bg.outer <- cos(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (bar.scale*treeheight))
x.0.25     <- sin(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.25*bar.scale*treeheight))
y.0.25     <- cos(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.25*bar.scale*treeheight))
x.0.5      <- sin(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.5*bar.scale*treeheight))
y.0.5      <- cos(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.5*bar.scale*treeheight))
x.0.75     <- sin(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.75*bar.scale*treeheight))
y.0.75     <- cos(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.75*bar.scale*treeheight))

#par(mfrow = c(1,1), mar = c(4,4,0,0)+0.5)
#plot(y.bg.outer ~ x.bg.outer, type = "n")
polygon(x = c(x.bg, rev(x.bg.outer)),
        y = c(y.bg, rev(y.bg.outer)),
        col = "grey93", border = "grey93") # This could also be "dark grey" 

lines(y.0.25 ~ x.0.25, col = "black", lwd = 1.5) # This could also be "white"
lines(y.0.5 ~ x.0.5, col = "black", lwd = 1.5)
lines(y.0.75 ~ x.0.75, col = "black", lwd = 1.5)

theta.start+c(1:nrow(plot.data))*theta.subtend


# Bars    
temp.x <- NA
temp.y <- NA
temp.theta <- NA
for(i in 1:nrow(plot.data)){
   
    theta1 <- theta.start + (i-1)*theta.subtend
    theta2 <- theta1 - theta.subtend
    
    x1 <- sin(theta1)*(treeheight + bar.offset)
    x2 <- sin(theta2)*(treeheight + bar.offset)
    y1 <- cos(theta1)*(treeheight + bar.offset)
    y2 <- cos(theta2)*(treeheight + bar.offset)
    
    temp.theta[i] <- theta1
    temp.x[i] <- x1
    temp.y[i] <- y1
    
    x3 <- sin(theta1)*(treeheight + bar.offset + (bar.scale*treeheight)*(plot.data[i,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))
    x4 <- sin(theta2)*(treeheight + bar.offset + (bar.scale*treeheight)*(plot.data[i,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))
    y3 <- cos(theta1)*(treeheight + bar.offset + (bar.scale*treeheight)*(plot.data[i,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))
    y4 <- cos(theta2)*(treeheight + bar.offset + (bar.scale*treeheight)*(plot.data[i,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))
    
    x5 <- sin(theta1)*(treeheight + bar.offset + (bar.scale*treeheight))
    x6 <- sin(theta2)*(treeheight + bar.offset + (bar.scale*treeheight))
    y5 <- cos(theta1)*(treeheight + bar.offset + (bar.scale*treeheight))
    y6 <- cos(theta2)*(treeheight + bar.offset + (bar.scale*treeheight))

    polygon(c(x1,x2,x4,x3),
            c(y1,y2,y4,y3),
            col = col1[i], border = col1[i])

}

### Add scales

#Upper
lines(y = rep(-0*bar.offset,2), 
      x = c(-1*(treeheight+bar.offset), 
            -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1.5)
lines(y = c(-0*bar.offset,-1*bar.offset), 
      x = c(-1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
            -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1.5)
lines(y = c(-0*bar.offset,-1*bar.offset), 
      x = c(-1*(treeheight+bar.offset+(0.5*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
            -1*(treeheight+bar.offset+(0.5*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1.5)
lines(y = c(-0*bar.offset,-1*bar.offset), 
      x = c(-1*(treeheight+bar.offset+(0.25*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
            -1*(treeheight+bar.offset+(0.25*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1.5)
lines(y = c(-0*bar.offset,-1*bar.offset), 
      x = c(-1*(treeheight+bar.offset+(0.75*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
            -1*(treeheight+bar.offset+(0.75*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1.5)
lines(y = c(-0*bar.offset,-1*bar.offset), 
      x = c(-1*(treeheight+bar.offset), 
            -1*(treeheight+bar.offset)),
      lwd = 1.5)

text(y = -1.5*bar.offset,
     x = c(-1*(treeheight+bar.offset), 
           -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))))[1],
     labels = "0",
     cex = 0.7,
     pos = 1)
text(y = -1.5*bar.offset,
     x = c(-1*(treeheight+bar.offset), 
           -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))))[2],
     labels = "1",
     cex = 0.7,
     pos = 1)

#Lower
lines(x = rep(-1*bar.offset,2), 
      y = c(-1*(treeheight+bar.offset), 
            -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1.5)
lines(x = c(-2*bar.offset,-1*bar.offset), 
      y = c(-1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
            -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1.5)
lines(x = c(-2*bar.offset,-1*bar.offset), 
      y = c(-1*(treeheight+bar.offset+(0.25*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
            -1*(treeheight+bar.offset+(0.25*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1.5)
lines(x = c(-2*bar.offset,-1*bar.offset), 
      y = c(-1*(treeheight+bar.offset+(0.5*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
            -1*(treeheight+bar.offset+(0.5*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1.5)
lines(x = c(-2*bar.offset,-1*bar.offset), 
      y = c(-1*(treeheight+bar.offset+(0.75*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
            -1*(treeheight+bar.offset+(0.75*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
      lwd = 1.5)
lines(x = c(-2*bar.offset,-1*bar.offset), 
      y = c(-1*(treeheight+bar.offset), 
            -1*(treeheight+bar.offset)),
      lwd = 1.5)

text(x = -1.5*bar.offset,
     y = c(-1*(treeheight+bar.offset), 
           -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))))[1],
     labels = "0",

     cex = 0.7,
     pos = 2)

text(x = -1.5*bar.offset,
     y = c(-1*(treeheight+bar.offset), 
           -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))))[2],
     labels = "1",
     cex = 0.7,
     pos = 2)


text(x = -4*bar.offset,
     y = -1*(treeheight+bar.offset+0.15*(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))),
     labels = expression("Empirical mean"),
     cex = 1,
     pos = 2, 
     font = 1)
text(x = -4*bar.offset,
     y = -1*(treeheight+bar.offset+0.5*(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))),
     labels = expression("frequency of occurrence"),
     cex = 1,
     pos = 2, 
     font = 1)
text(x = -4*bar.offset,
     y = -1*(treeheight+bar.offset+0.85*(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))),
     labels = expression("of plastic ingestion"),
     cex = 1,
     pos = 2, 
     font = 1)

# # Add legend            
#     legend("bottomleft", 
#       legend =c('Anseriformes', 'Charadriiformes', 'Phaethontiformes', 'Gaviiformes', 'Pelecaniformes', 'Suliformes', 'Sphenisciformes', 'Procellariiformes'), 
#     pch=16, pt.cex=1.5, cex = 0.8, bty='n',
#     col = c('#DCE319FF', '#73D055FF', '#3CBB75FF', '#1F968BFF', '#33638DFF', "#404788FF","#404788FF","#482677FF"),
#     title = "Order", title.adj = 0.1)
    

# Save manually as PDF

```


*Published*
This script uses prediction.summary_Age and phylogentic tree to produce a beautiful phylogenetic tree. 
```{r published_Phyloplas_tree_meanFO_prediction}

# Phylogeny 

prediction.summary_Age<- mutate(prediction.summary_Age, Order = str_to_upper(Order))


data.2 <- prediction.summary_Age %>% 
    mutate(Order.title = str_to_title(Order)) %>%
    mutate(TipLabel = TipLabel_BirdTree)

colnames(data.2)

data.2 <- data.2 %>%
    mutate(TipLabel_BirdTree = TipLabel_BirdTree,
           N = 1,
           FO = mean.FO,
           sd = interval, # HPD credible interval!
           se = interval, # HPD credible interval!
           Order = Order) 

row.names(data.2) <- data.2$TipLabel_BirdTree   
head(data.2)
    

plot.error.bars <- TRUE
plot.pdf <- TRUE # If this is TRUE plot won't show in console.

col.significant <- "black"
col.not.significant <- "grey50"

if(plot.pdf == TRUE){
  pdf(file = paste0("./figs_tables/PHYLOPLAS.Predicted__Figure_",Sys.Date(),".pdf"),
      height = 12,
      width = 12,
      paper = "USr") #a4r
}

# Phylogeny 

        ################        
        library(phytools)
        library(ape)
        library(cowplot)
        
        # pdf("./figs/PHYLOPLAS.Predicted.pdf") # Not working
        
        
        tree.all <- read.tree("./output/ConsensusTree_seabird_matched.phy")
        plot.tree <- compute.brlen(tree.all, method = "Grafen", power = 1/2)
        plot.tree <- ladderize(plot.tree, right = TRUE)
        
        write.tree(plot.tree, "Plotting - tree.phy")
        plot.tree <- read.tree("Plotting - tree.phy")
        
        treeheight <- max(nodeHeights(plot.tree))
        
        # prediction.summary_Age <- read.csv(paste0("./output/MCMCglmm.products/m1.6.MCMCglmm_Age.FO.predictions.345.species_","2018-12-20",".csv"))
        
        # prediction.summary_Age <- prediction.summary_Age %>% 
        #     mutate(Order.title = str_to_title(Order)) %>%
        #     mutate(small.sample = ifelse(sample.size < 50, "< 50", "> 50")) %>%
        #     mutate(small.sample = as.factor(small.sample)) %>%
        #     mutate(priority.highFO.lowN = ifelse(mean.FO >= 0.6 & sample.size < 50, "Yes", "No")) %>% 
        #     mutate(priority.highFO.lowN = as.factor(priority.highFO.lowN))
        # 
        # table(prediction.summary_Age$priority.highFO.lowN)
        # table(prediction.summary_Age$small.sample)
        # table(prediction.summary_Age$HPDinterval_category)
        # table(prediction.summary_Age$Order.title)
        # 
        # colnames(prediction.summary_Age)
        # 
        # # Load species trait data so I can merge IUCN status in
        # trait <- read.csv("./data/intermediates/MASTER.keymassdietdmsstatus.traits_2018-11-07.csv")
        # colnames(trait)
        # trait <- select(trait, Common.name_BirdTree, X2016.IUCN.Red.List.category, Opportunistic.Inferred, Body.Mass.g) %>%
        #     distinct() # Sandwich Tern and Silver Gull have two rows bc there are two different SAUS names.
        # dim(trait)
        # test <- left_join(prediction.summary_Age, trait, by = "Common.name_BirdTree")
        # nrow(prediction.summary_Age) == nrow(test) # If there is only one IUCN status for each species then this should = TRUE
        # # prediction.summary_Age <- test
        # 
        plot.data_predictions <- prediction.summary_Age %>%
            mutate(TipLabel_BirdTree = TipLabel_BirdTree,
                   N = 1,
                   mean = mean.FO,
                   sd = interval,
                   se = interval,
                   Order = Order) %>% 
            dplyr::select(TipLabel_BirdTree, N, mean, sd, se, Order) %>% 
            mutate(Order = as.character(Order)) %>% # Order.title = as.character(Order.title), 
            arrange(TipLabel_BirdTree)
        
        row.names(plot.data_predictions) <- plot.data_predictions$TipLabel_BirdTree
        
        # View(plot.data_empirical)
        # View(plot.data_predictions)
        # str(plot.data_empirical)
        str(plot.data_predictions)
        
        plot.data<- plot.data_predictions
        
        # plot.data$Order <- NA
        
        # for(i in 1:nrow(plot.data)){
        # plot.data$Order[i] <- as.character(data.2$Order[data.2$TipLabel_BirdTree == plot.data$TipLabel_BirdTree[i]][1])
        # }
        # row.names(plot.data) <- as.character(plot.data$TipLabel_BirdTree)
        
        #Species missing from the tree
        plot.data <- droplevels(plot.data)
        plot.data$TipLabel_BirdTree <- as.factor(plot.data$TipLabel_BirdTree)
        species.list <- unique(plot.data$TipLabel_BirdTree)
        species.list[!species.list %in% plot.tree$tip.label]
        
        #Remove tips for species that are not in the data set for plotting
        plot.tree <- drop.tip(plot.tree, tip = plot.tree$tip.label[!plot.tree$tip.label %in% plot.data$TipLabel_BirdTree])
        plot.data <- plot.data[plot.tree$tip.label,] # This breaks it
        
        
        ### Set up the colours for the plots and tree branches
        
        # # Reverse Rainbow
        # col.PROCELLARIIFORMES <- "red"
        # col.SPHENISCIFORMES <- "orange"
        # col.SULIFORMES <- "gold"
        # col.PELECANIFORMES <- "green4" # "yellow"
        # col.GAVIIFORMES <- "dodgerblue" #green"
        # col.PHAETHONTIFORMES <- "darkblue"
        # col.CHARADRIIFORMES <- "purple4" # "indigo"
        # col.ANSERIFORMES <- "purple3"
        
        # Mimicing viridis colour palette for colour blindness
        col.PROCELLARIIFORMES <- "#482677FF"
        col.SPHENISCIFORMES <- "#404788FF"
        col.SULIFORMES <- "#404788FF"
        col.PELECANIFORMES <- "#33638DFF" # "yellow"
        col.GAVIIFORMES <- "#1F968BFF" #green"
        col.PHAETHONTIFORMES <- "#3CBB75FF"
        col.CHARADRIIFORMES <- "#73D055FF" # "indigo"
        col.ANSERIFORMES <- "#DCE319FF"
   
        # # Rainbow
        # col.PROCELLARIIFORMES <- "purple4"
        # col.SPHENISCIFORMES <- "darkblue"
        # col.SULIFORMES <- "royalblue"
        # col.PELECANIFORMES <- "forest green" # "yellow"
        # col.GAVIIFORMES <- "green4" #green"
        # col.PHAETHONTIFORMES <- "gold"
        # col.CHARADRIIFORMES <- "orange" # "indigo"
        # col.ANSERIFORMES <- "red"
        
        col.significant <- "black"
        col.not.significant <- "grey50"
        
        
        tree.plot.colours <- data.frame(c(col.ANSERIFORMES, col.CHARADRIIFORMES, col.GAVIIFORMES,
                                          col.PHAETHONTIFORMES, col.PROCELLARIIFORMES, col.SPHENISCIFORMES, col.SULIFORMES, col.PELECANIFORMES))
        
        row.names(tree.plot.colours) <- c("ANSERIFORMES", "CHARADRIIFORMES", "GAVIIFORMES", 
                                          "PHAETHONTIFORMES", "PROCELLARIIFORMES", "SPHENISCIFORMES",
                                          "SULIFORMES", "PELECANIFORMES")
        
        plot.data$col <- NA
        plot.data$col[plot.data$Order == "ANSERIFORMES"] <- col.ANSERIFORMES
        plot.data$col[plot.data$Order == "CHARADRIIFORMES"] <- col.CHARADRIIFORMES
        plot.data$col[plot.data$Order == "GAVIIFORMES"] <- col.GAVIIFORMES
        plot.data$col[plot.data$Order == "PHAETHONTIFORMES"] <- col.PHAETHONTIFORMES
        plot.data$col[plot.data$Order == "PROCELLARIIFORMES"] <- col.PROCELLARIIFORMES
        plot.data$col[plot.data$Order == "SPHENISCIFORMES"] <- col.SPHENISCIFORMES
        plot.data$col[plot.data$Order == "SULIFORMES"] <- col.SULIFORMES
        plot.data$col[plot.data$Order == "PELECANIFORMES"] <- col.PELECANIFORMES
        
        col1 <- plot.data$col
        
        head(plot.tree$tip.label)
        head(plot.data)
        
        tree.angle <- 270
        tree.start <- 180 #0 in North, 180 is south (This bit doesn't work yet)
        
        #Get the colours
        ANSERIFORMES_edge      <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "ANSERIFORMES")))
        CHARADRIIFORMES_edge   <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "CHARADRIIFORMES")))
        GAVIIFORMES_edge       <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "GAVIIFORMES")))
        PHAETHONTIFORMES_edge  <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "PHAETHONTIFORMES")))
        PROCELLARIIFORMES_edge <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "PROCELLARIIFORMES")))
        SPHENISCIFORMES_edge   <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "SPHENISCIFORMES")))
        SULIFORMES_edge        <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "SULIFORMES")))
        PELECANIFORMES_edge    <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "PELECANIFORMES")))
        all                    <- which.edge(plot.tree, group = row.names(plot.data))
        
        ANSERIFORMES_edge      <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "ANSERIFORMES")))
        CHARADRIIFORMES_edge   <- which.edge(plot.tree, group = row.names(subset(plot.data, Order != "ANSERIFORMES")))
        PHAETHONTIFORMES_edge  <- which.edge(plot.tree, group = row.names(subset(plot.data, !(Order == "CHARADRIIFORMES" | Order == "ANSERIFORMES"))))
        GAVIIFORMES_edge       <- which.edge(plot.tree, group = row.names(subset(plot.data, !(Order == "ANSERIFORMES" | Order == "CHARADRIIFORMES" | 
                                                                                                  Order == "PHAETHONTIFORMES"))))
        PELECANIFORMES_edge    <- which.edge(plot.tree, group = row.names(subset(plot.data, !(Order == "ANSERIFORMES" | Order == "CHARADRIIFORMES" | 
                                                                                                  Order == "PHAETHONTIFORMES" | Order == "GAVIIFORMES"))))
        SULIFORMES_edge        <- which.edge(plot.tree, group = row.names(subset(plot.data, !(Order == "ANSERIFORMES" | Order == "CHARADRIIFORMES" | 
                                                                                                  Order == "PHAETHONTIFORMES" | Order == "GAVIIFORMES" | 
                                                                                                  Order == "PELECANIFORMES"))))
        SPHENISCIFORMES_edge   <- which.edge(plot.tree, group = row.names(subset(plot.data, !(Order == "ANSERIFORMES" | Order == "CHARADRIIFORMES" | 
                                                                                                  Order == "PHAETHONTIFORMES" | Order == "GAVIIFORMES" | 
                                                                                                  Order == "PELECANIFORMES" | Order == "SULIFORMES"))))
        PROCELLARIIFORMES_edge <- which.edge(plot.tree, group = row.names(subset(plot.data, Order == "PROCELLARIIFORMES")))
        
        #Colours for the tree
        clcolr<-rep(as.character(tree.plot.colours["ANSERIFORMES",]), dim(plot.tree$edge)[1]) #vector as long as the first edge column and populating it with the colour for insects
        clcolr[all]    <- as.character(tree.plot.colours["ANSERIFORMES",])   # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
        clcolr[ANSERIFORMES_edge]      <-as.character(tree.plot.colours["ANSERIFORMES",])   # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
        clcolr[CHARADRIIFORMES_edge]   <-as.character(tree.plot.colours["CHARADRIIFORMES",])   # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
        clcolr[PHAETHONTIFORMES_edge]  <-as.character(tree.plot.colours["PHAETHONTIFORMES",])   # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
        clcolr[GAVIIFORMES_edge]       <-as.character(tree.plot.colours["GAVIIFORMES",])   # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
        clcolr[PELECANIFORMES_edge]    <-as.character(tree.plot.colours["PELECANIFORMES",])   # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
        clcolr[SULIFORMES_edge]        <-as.character(tree.plot.colours["SULIFORMES",])   # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
        clcolr[SPHENISCIFORMES_edge]   <- as.character(tree.plot.colours["SPHENISCIFORMES",]) # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
        clcolr[PROCELLARIIFORMES_edge] <-as.character(tree.plot.colours["PROCELLARIIFORMES",]) # this defines the ingroup and then sets up a vector to colour each edge of the phylogeny depending on whether it is in the group or not
        
    ### Draw Tree - Tiplabels are offset to allow for the polygon
        par(mar = c(5,5,5,5) + 1, xpd = NA)

        # (phylo.plot is from ape package)
        plot(plot.tree, type = "fan", open.angle = 360 - tree.angle, rotate = 270, 
             root.edge = TRUE, 
             show.tip.label = T, label.offset = .36, cex = 0.3, tip.color = col1, # careful balance between edge width and cex to make sure labels are visable
             edge.width = 1.5,
             x.lim = c(-1 * treeheight, 1.2 * treeheight), 
             y.lim = c(-1 * treeheight, 1.2 * treeheight), 
             edge.color = clcolr)
  
        ### Draw Prediction bars, background and labels
        
        # Draw background
        theta.start <- -0.5*(pi/180)*tree.angle/nrow(plot.data) + (pi/180)*tree.start
        theta.subtend <- abs(2*theta.start)
        
        bar.scale <- 0.3 #Multiplication factor for the bars
        bar.offset <- 0.03 #Offset to add white space between the bars and the tree, to separate the colours
        
        x.bg       <- sin(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset)
        y.bg       <- cos(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset)
        x.bg.outer <- sin(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (bar.scale*treeheight))
        y.bg.outer <- cos(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (bar.scale*treeheight))
        x.0.25     <- sin(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.25*bar.scale*treeheight))
        y.0.25     <- cos(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.25*bar.scale*treeheight))
        x.0.5      <- sin(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.5*bar.scale*treeheight))
        y.0.5      <- cos(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.5*bar.scale*treeheight))
        x.0.75     <- sin(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.75*bar.scale*treeheight))
        y.0.75     <- cos(theta.start+c(-1:(nrow(plot.data)-1))*theta.subtend)*(treeheight + bar.offset + (0.75*bar.scale*treeheight))
        
        #par(mfrow = c(1,1), mar = c(4,4,0,0)+0.5)
        #plot(y.bg.outer ~ x.bg.outer, type = "n")
        polygon(x = c(x.bg, rev(x.bg.outer)),
                y = c(y.bg, rev(y.bg.outer)),
                col = "grey93", border = "grey93") # This could also be "dark grey" 
        
        lines(y.0.25 ~ x.0.25, col = "black", lwd = 1.5) # This could also be "white"
        lines(y.0.5 ~ x.0.5, col = "black", lwd = 1.5)
        lines(y.0.75 ~ x.0.75, col = "black", lwd = 1.5)
        
        theta.start+c(1:nrow(plot.data))*theta.subtend
        
        
        # Bars    
        temp.x <- NA
        temp.y <- NA
        temp.theta <- NA
        for(i in 1:nrow(plot.data)){
            #for(i in 1:4){ 
            #outer layer first
            theta1 <- theta.start + (i-1)*theta.subtend
            theta2 <- theta1 - theta.subtend
            
            x1 <- sin(theta1)*(treeheight + bar.offset)
            x2 <- sin(theta2)*(treeheight + bar.offset)
            y1 <- cos(theta1)*(treeheight + bar.offset)
            y2 <- cos(theta2)*(treeheight + bar.offset)
            
            temp.theta[i] <- theta1
            temp.x[i] <- x1
            temp.y[i] <- y1
            
            x3 <- sin(theta1)*(treeheight + bar.offset + (bar.scale*treeheight)*(plot.data[i,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))
            x4 <- sin(theta2)*(treeheight + bar.offset + (bar.scale*treeheight)*(plot.data[i,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))
            y3 <- cos(theta1)*(treeheight + bar.offset + (bar.scale*treeheight)*(plot.data[i,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))
            y4 <- cos(theta2)*(treeheight + bar.offset + (bar.scale*treeheight)*(plot.data[i,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))
            
            x5 <- sin(theta1)*(treeheight + bar.offset + (bar.scale*treeheight))
            x6 <- sin(theta2)*(treeheight + bar.offset + (bar.scale*treeheight))
            y5 <- cos(theta1)*(treeheight + bar.offset + (bar.scale*treeheight))
            y6 <- cos(theta2)*(treeheight + bar.offset + (bar.scale*treeheight))
            #x3.1 <- sin(theta1)*(treeheight + bar.offset + (bar.scale*treeheight)*(data[i,1]-min(data[,1]))/(max(data[,1])-min(data[,1])) + 
            #                       (bar.scale*treeheight)*(data[i,2]-min(data[,2]))/(max(data[,2])-min(data[,2])))
            #x4.1 <- sin(theta2)*(treeheight + bar.offset + (bar.scale*treeheight)*(data[i,1]-min(data[,1]))/(max(data[,1])-min(data[,1])) + 
            #                       (bar.scale*treeheight)*(data[i,2]-min(data[,2]))/(max(data[,2])-min(data[,2])))
            #y3.1 <- cos(theta1)*(treeheight + bar.offset + (bar.scale*treeheight)*(data[i,1]-min(data[,1]))/(max(data[,1])-min(data[,1])) + 
            #                       (bar.scale*treeheight)*(data[i,2]-min(data[,2]))/(max(data[,2])-min(data[,2])))
            #y4.1 <- cos(theta2)*(treeheight + bar.offset + (bar.scale*treeheight)*(data[i,1]-min(data[,1]))/(max(data[,1])-min(data[,1])) + 
            #                       (bar.scale*treeheight)*(data[i,2]-min(data[,2]))/(max(data[,2])-min(data[,2])))
            
            # polygon(c(x1,x2,x6,x5),
            #         c(y1,y2,y6,y5),
            #         #col = col1[i], border = col1[i],
            #         col = "grey80", border = "grey80")
            
            polygon(c(x1,x2,x4,x3),
                    c(y1,y2,y4,y3),
                    #col = "darkorange", border = "darkorange",
                    col = col1[i], border = col1[i])
            #polygon(c(x3,x4,x4.1,x3.1),c(y3,y4,y4.1,y3.1),
            #        #col = "darkgreen", border = "darkgreen",
            #        col = col2[i], border = col2[i])
        }
        
        
        ### Add scales
        
        
        # Upper
        lines(y = rep(-0*bar.offset,2), 
              x = c(-1*(treeheight+bar.offset), 
                    -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
              lwd = 1)
        lines(y = c(-0*bar.offset,-1*bar.offset), 
              x = c(-1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
                    -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
              lwd = 1)
        lines(y = c(-0*bar.offset,-1*bar.offset), 
              x = c(-1*(treeheight+bar.offset+(0.5*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
                    -1*(treeheight+bar.offset+(0.5*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
              lwd = 1)
        lines(y = c(-0*bar.offset,-1*bar.offset), 
              x = c(-1*(treeheight+bar.offset+(0.25*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
                    -1*(treeheight+bar.offset+(0.25*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
              lwd = 1)
        lines(y = c(-0*bar.offset,-1*bar.offset), 
              x = c(-1*(treeheight+bar.offset+(0.75*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
                    -1*(treeheight+bar.offset+(0.75*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
              lwd = 1)
        lines(y = c(-0*bar.offset,-1*bar.offset), 
              x = c(-1*(treeheight+bar.offset), 
                    -1*(treeheight+bar.offset)),
              lwd = 1)
        
        text(y = -1.5*bar.offset,
             x = c(-1*(treeheight+bar.offset), 
                   -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))))[1],
             labels = "0",
             #labels = expression(bold("Does not ingest plastic")),
             cex = .8,
             pos = 1)
        text(y = -1.5*bar.offset,
             x = c(-1*(treeheight+bar.offset), 
                   -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))))[2],
             #labels = expression(bold("Ingests plastic")),
             labels = "1",
             cex = .8,
             pos = 1)
        
        # Lower
        lines(x = rep(-1*bar.offset,2), 
              y = c(-1*(treeheight+bar.offset), 
                    -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
              lwd = 1)
        lines(x = c(-2*bar.offset,-1*bar.offset), 
              y = c(-1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
                    -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
              lwd = 1)
        lines(x = c(-2*bar.offset,-1*bar.offset), 
              y = c(-1*(treeheight+bar.offset+(0.25*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
                    -1*(treeheight+bar.offset+(0.25*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
              lwd = 1)
        lines(x = c(-2*bar.offset,-1*bar.offset), 
              y = c(-1*(treeheight+bar.offset+(0.5*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
                    -1*(treeheight+bar.offset+(0.5*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
              lwd = 1)
        lines(x = c(-2*bar.offset,-1*bar.offset), 
              y = c(-1*(treeheight+bar.offset+(0.75*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))), 
                    -1*(treeheight+bar.offset+(0.75*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"]))))),
              lwd = 1)
        lines(x = c(-2*bar.offset,-1*bar.offset), 
              y = c(-1*(treeheight+bar.offset), 
                    -1*(treeheight+bar.offset)),
              lwd = 1)
        
        text(x = -1.5*bar.offset,
             y = c(-1*(treeheight+bar.offset), 
                   -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))))[1],
             labels = "0",
             #labels = expression(bold("Does not ingest plastic")),
             cex = .8,
             pos = 2)
        # text(x = -1.5*bar.offset,
        #      y = c(-1*(treeheight+bar.offset), 
        #            -1*(treeheight+bar.offset+(0.5*bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))))[2],
        #      #labels = expression(bold("Ingests plastic")),
        #      labels = "0.5",
        #      cex = 1,
        #      pos = 2)
        text(x = -1.5*bar.offset,
             y = c(-1*(treeheight+bar.offset), 
                   -1*(treeheight+bar.offset+(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))))[2],
             #labels = expression(bold("Ingests plastic")),
             labels = "1",
             cex = .8,
             pos = 2)
        
        
        text(x = -4*bar.offset,
             y = -1*(treeheight+bar.offset+0.15*(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))),
             labels = expression(bold("Predicted")),
             cex = .8,
             pos = 2)
        text(x = -4*bar.offset,
             y = -1*(treeheight+bar.offset+0.5*(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))),
             labels = expression(bold("Frequency of Occurrence")),
             cex = .8,
             pos = 2)
        text(x = -4*bar.offset,
             y = -1*(treeheight+bar.offset+0.85*(bar.scale*treeheight)*(max(plot.data[,"mean"]-min(plot.data[,"mean"]))/(max(plot.data[,"mean"])-min(plot.data[,"mean"])))),
             labels = expression(bold("of plastic ingestion")),
             cex = .8,
             pos = 2)
    
        
# Add legend            
    legend("bottomleft", 
      legend =c('Anseriformes', 'Charadriiformes', 'Phaethontiformes', 'Gaviiformes', 'Pelecaniformes', 'Suliformes', 'Sphenisciformes', 'Procellariiformes'), 
    pch=16, pt.cex=1.5, cex = 0.8, bty='n',
    col = c('#DCE319FF', '#73D055FF', '#3CBB75FF', '#1F968BFF', '#33638DFF', "#404788FF","#404788FF","#482677FF"),
    title = "Order", title.adj = 0.1)
    

if(plot.pdf == TRUE){
    dev.off()
    system2(command = "open", args = paste0("./figs_tables/PHYLOPLAS.Predicted__Figure_",Sys.Date(),".pdf"), wait = FALSE)
}
```


REFERENCES

ggplot element options
<https://rstudio-pubs-static.s3.amazonaws.com/3364_d1a578f521174152b46b19d0c83cbe7e.html>

Define customizxed order for non-alphabetic factor levels (IUCN.Status) for use in ggplot aes REF1 <https://stackoverflow.com/questions/12774210/how-do-you-specifically-order-ggplot2-x-axis-nstead-of-alphabetical-order>

Grid Arrangement - using gridExtra
<http://www.sthda.com/english/wiki/wiki.php?id_contents=7930>