---
title: "Avery-Gomm et al. (TBD) Global seabird plastic ingestion vulnerability predicted using life history and phylogeny"
authors: "Stephanie Avery-Gomm, Craig White"
date: '2019-04-19'
---

The purpose of this code is to 
- prepare a 'clean' version of the empirical dataset
- prepare a dataset suitable for the ASReml-R V3 analysis (in next script)



Input files
"./output/2018-11-07_study_lvl_plastic_data_traits.csv"
"./R.analysis/ConsensusTree.phy"
"./R.functions/pin.R"

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```


```{r initialize}

# Initialize
getwd()

# Initializing
# Clear workspace
rm(list=ls())
gc()

sessionInfo()  # Matches? 

# Run this in     
    
    # R version 3.5.3 (2019-03-11)
    # Platform: x86_64-apple-darwin15.6.0 (64-bit)
    # Running under: macOS Sierra 10.12.6


# # First time? Load packages that are the same as the ones downloaded to run this project
install.packages("checkpoint")
library(checkpoint)
checkpoint::setSnapshot("2019-04-19")
# install.packages("ape", type = "source") 
# install.packages("beepr", type = "source")
# install.packages("boot", type = "source")
# install.packages("caper", type = "source")
# install.packages("car", type = "source")
# install.packages("dplyr", type = "source") 
# install.packages("gtools", type = "source")
# install.packages("knitr", type = "source")
# install.packages("lattice", type = "source") 
# install.packages("lme4", type = "source")
# install.packages("lmtest", type = "source")
# install.packages("maps", type = "source") 
# install.packages("MCMCglmm", type = "source")
# install.packages("MuMIn", type = "source")
# install.packages("phylolm", type = "source")
# install.packages("phytools", type = "source") 
# install.packages("rotl", type = "source")
# install.packages("tidyverse", type = "source")

# Not first time? Assume these all will load your sessionInfo() mathces
    # R version 3.5.3 (2019-03-11)
    # Platform: x86_64-apple-darwin15.6.0 (64-bit)
    # Running under: macOS Sierra 10.12.6
  
# Load Packages
library(caper)
library(car)
library(phylolm) 
library(lmtest)
library(phytools) # used for 'read.tree'
library(boot)
library(lme4)
library(gtools)
library(ape)
library(MCMCglmm)
library(MuMIn)
library(tidyverse)
library(beepr)

`%notin%` <- Negate(`%in%`) # Add this function!

# pin is used to calculate standard errors for phylogenetic heritability in PMM
# using the 'delta' method, as in pin files for stand-alone ASReml
# http://www.homepages.ed.ac.uk/iwhite/asreml/
# http://www.homepages.ed.ac.uk/iwhite/asreml/uop
# http://www.vsni.co.uk/forum/viewtopic.php?t=660

options(scipen=999, digits = 3)

```

```{r setup_questions}

# Setup Options

# Load published versions where options exist?
use.published <- TRUE # FALSE here will load files created today by default, otherwise edits must be made to the 'read.csv' code each time. 

# Recreate tidy Plastic data
recreate.clean.input.FO.data <- TRUE # Published version will load if FALSE

# Prep Phylogenetic Trees
subset.consensus.tree.phy <- FALSE # This should stay 'FALSE'. Trees should not be re-downloaded

# Recreate clean data for ASreml-R analysis (in next script)
recreate.clean.asreml.input.data.datanoNAs <- TRUE
    
```

This code re-classifies some variables and generally tidies up. Study data that may be incomplete (i.e., unreported FO, sample size or year of sampling) are set to NA.
Not necessary to re-run each time, unless you want to make changes - beware changes here may affect code elsewhere.
```{r recreate.clean.input.FO.data}

# Load plastic ingestion/trait data & prepare for asreml/mcmcglmm (or load cleaned input data which rearranges, reorders and creates new variables - BUT DOES NOT not FILTER data out because of NAs - that is the next step)

if(recreate.clean.input.FO.data == TRUE){

# Load base FO of Plastic Ingestion data
# Published
data <- read.csv("./data/study_lvl_plastic_data_traits_2019-03-15_PUBLISHED.csv") 
    
    # View(data)
    colnames(data)    
    
            
            # # Data summary of the empirical data that was collected for this study (before exclusions for study or trait NAs.)
            # data.sources <- unique(data$Source) # 155 Sources, 154 if you exclude NAs, which you should. 
            # data.sources #154
            # 
            # nrow(data) #1684
            # 
            # number.of.birds <- sum(data$n, na.rm = TRUE) 
            # number.of.birds #  48773
            # 
            # number.of.sps <- data %>%
            #     filter(!is.na(Source)) %>%
            #     droplevels()
            # number.of.sps <- unique(number.of.sps$TipLabel_BirdTree) # 214 species
            # number.of.sps #214
    
# REMOVE NON-BIRDTREE SPECIES
    
        # Where TipLabel_BirdTree is NA(details) and error is thrown and a NA is introduced. First remove those rows, then redo. 
        TipLabel_BirdTree_NA_positions <- which(grepl("NA ", data$TipLabel_BirdTree, ignore.case = FALSE, perl = FALSE,
          fixed = FALSE, useBytes = FALSE))
        
        TipLabel_BirdTree_NA_positions 
       # 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492
        
         TipLabel_BirdTree_NAs <- data$TipLabel_BirdTree[c(TipLabel_BirdTree_NA_positions)]

           class(TipLabel_BirdTree_NAs)
           length(TipLabel_BirdTree_NAs) # 24
            
       
        data.excluded <- data %>%
            filter(TipLabel_BirdTree %in% TipLabel_BirdTree_NAs)
        write.csv(data.excluded, file = paste0("./FYI/excluded_bc_TipLabel_Birdtree_NAs_",Sys.Date(),".csv"), row.names = F)
        data.excluded$UniqueID_Plastic.study # 1346 1347 1348
       
        `%notin%` <- Negate(`%in%`)
        data2 <- data %>%
            filter(TipLabel_BirdTree %notin% TipLabel_BirdTree_NAs)
        nrow(data2) #1660
        nrow(data) #1684
        nrow(data.excluded) # 24
        
        # Is the filtered dataset missing the same number of rows as there were rows removed?
        (nrow(data) - nrow(data2)) == length(TipLabel_BirdTree_NAs)
        
        data2<- droplevels(data2)
        nrow(data2) # 1660
 

# DEAL WITH VARIABLES        
                      
    # ORDER
        # Delete any Orders thave have min.spp.per.order (= 0) records
        min.spp.per.order <- 0 
        table(data2$Order)
            for(i in 1:length(table(data2$Order))){
              if(table(data2$Order)[i] < min.spp.per.order){
                data2 <- subset(data2, Order != names(table(data2$Order)[i]))
                                                  }        }
        levels(data2$Order)
        data2$Order <- factor(data2$Order, levels = levels(data2$Order)[c(1,2,5,3,4,8,7,6)])
        levels(data2$Order)
    
        # It makes no sense to have >350 species in any one Order since there are only this many seabird species. But, this reflects the number of RECORDs, not species. To confirm, see # View(filter(data2, Order == "CHARADRIIFORMES"))
        table(data2$Order)
        nrow(data2)
    
    # PLASTIC (binary)
        # Introduce new variable based on data2$Plastic but retain NAs for unstudied species
        table(data2$Plastic)
    
        data2$Ingests_Plastic <- NA
        data2$Ingests_Plastic[data2$Plastic == "No"] <- 0
        data2$Ingests_Plastic[data2$Plastic == "Yes"] <- 1
        data2$Ingests_Plastic
    

    # OPPORTUNISTIC.INFERRED   
        # View(data2 %>%
            # filter(is.na(Opportunistic.Inferred))) # These rows can be removed because they relate to species that are not of interest in the analysis bc they aren't recognized by BirdTree
        x <- subset(data2, is.na(Opportunistic.Inferred))
        x$Common.name_BLVr9 #  NA (Subantarctic Skua not recognized by BLVr9) NA (Red-billed Gull not recognized by BLVr9)  
        rm(x)
        data2 <- subset(data2, !is.na(Opportunistic.Inferred))
    
    
# PLASTIC STUDIES UNSUITABLE FOR ANALYSIS BC STUDY LEVEL DATA INCOMPLETE
    # I don't want to remove rows with is.na(Date_FirstYR) because they could be the only case for a species, and because many species have NO plastic data2. 
    # I define rows that should have the plastic data2 excluded by figuring out the relevant UniqueID_Plastic.study, and setting values for rows 38:61 to NA. "Relevant" UniqueID_Plastic.study means, an case where:
    
            # BC WE DON"T KNOW WhEN THE STUDY WAS DONE!   i.e.,    Date_FirstYR = NA
                test <- data2 %>%
                    filter(is.na(Date_FirstYR)) %>%
                    droplevels()
                test.UniqueID_Plastic.study1 <- unique(test$UniqueID_Plastic.study)
           
             # BC SAMPLE SIZE WASN'T REPORTED!     i.e., n = Sample Size = NA
                test <- data2 %>%
                    filter(is.na(n)) %>%
                    droplevels()
          
                test.UniqueID_Plastic.study2 <- unique(test$UniqueID_Plastic.study)
                
            # BC DIET CURRENTLY UNKNOWN!     i.e., Diet = NA
                test <- data2 %>%
                    filter(is.na(Diet))
                test.UniqueID_Plastic.study3 <- unique(test$UniqueID_Plastic.study) # Empty
                test <- data2 %>%
                    filter(Diet == "Unknown")
                test.UniqueID_Plastic.study3 <- unique(test$UniqueID_Plastic.study)

    
        
    # Create vector of all UniqueID_Plastic.study that need to have plastic study values set to NA because they aren't complete enough to be included in our analysis.
    relevant <- c(test.UniqueID_Plastic.study1,test.UniqueID_Plastic.study2,test.UniqueID_Plastic.study3)
    length(relevant) #60
    
            # Add a column that identifies rows that are 'relevant' i.e., should have values associated with a plastic study set to NA. 
            data2 <- data2 %>%
                mutate(set.NA = ifelse(UniqueID_Plastic.study %in% relevant, "Y","N"))

        # Save a subset that show the rows where plastic data was cleared
        data.excluded.incomplete <- data2 %>%
            filter(set.NA %in% c("Y")) %>%
            filter(!is.na(UniqueID_Plastic.study))
        nrow(data.excluded.incomplete) # 44 rows are missing one type of information we need
        # View(data.excluded.incomplete)
        
        write.csv(data.excluded.incomplete, file = paste0("./FYI/excluded_bc_plastic_study_level_data_incomplete_",Sys.Date(),".csv"), row.names = F)
        
            
            ## rows where UniqueID_Plastic.study has been identified as relevant, set values for plastic related columns to NA. So, make subset DF, only of the ones with set.NA == "Y", then clear out the columns you don't want
            data3 <- data2 %>%
              filter(set.NA=="Y") %>%
              dplyr::select(-(40:63)) # From UniqueID_Plastic.study:Ingests_Plastic
            colnames(data2)
            ## subset the original DF, retaining all info for those with set.na == "N", then rejoin the cleared out rows of the ones you don't want
            data4 <- data2 %>%
              filter(set.NA == "N") %>%
              bind_rows(data3)
            
        data2 <- droplevels(data4)
        nrow(data2) #1658
        rm(data3, data4)
        
    # SQRT N
    data2$sqrtN <- sqrt(data2$n)
    
    # ANIMAL
    # data2frame tidying. Add 'animal' variable, which is TipLabel_BirdTree & identify & remove any NAs.
    levels(unique(data2$TipLabel_BirdTree))
    data2$animal <- data2$TipLabel_BirdTree
    # View(data2)

# DATE etc
    data2$Date <- data2$Date_FirstYR
    data2$Date_mean <- rowMeans(data.frame(data2$Date_FirstYR, data2$Date_LastYR), na.rm = TRUE)
    data2$Date_mean[data2$Date_mean == "NaN"] <- NA
    data2$Date_median <- data2$Date - median(data2$Date, na.rm = TRUE)
        
# DECADE        
    data2$Date_Decade <- NA
    
    data2<- data2 %>%
        mutate(Date_Decade = ifelse(data2$Date_FirstYR < 1970, "1960s", 
                                     ifelse(data2$Date_FirstYR < 1980, "1970s",
                                     ifelse(data2$Date_FirstYR < 1990, "1980s", 
                                     ifelse(data2$Date_FirstYR < 2000, "1990s", 
                                     ifelse(data2$Date_FirstYR < 2010, "2000s",
                                     ifelse(data2$Date_FirstYR < 2020, "2010s",
                                     ifelse(is.na(data2$Date_FirstYR), NA, "ERROR"))))))))
     
    data2$Date_Decade <- as.factor(data2$Date_Decade)
    table(data2$Date_Decade)
    
# SAMPLE SIZE, n
    data2$n_bins <- as.character(data2$n)
    data2 <- data2 %>%
            mutate(n_bins = ifelse(data2$n < 6, data2$n, 
                            ifelse(data2$n < 11, "6-10",
                            ifelse(data2$n < 21, "11-20", 
                            ifelse(data2$n < 51, "21-50", 
                            ifelse(data2$n < 101, "51-100", ">100"))))))
    data2$n_bins <- as.factor(data2$n_bins)
    levels(data2$n_bins)
    data2$n_bins <- factor(data2$n_bins, levels = levels(data2$n_bins)[c(2,4,6,7,8,10,3,5,9,1)])
    levels(data2$n_bins)
    table(data2$n_bins)
    
# MASS
    data2$mass_bin <- NA
    data2 <- data2 %>%
            mutate(mass_bin = ifelse(data2$Body.Mass.g < 100, "< 100", 
                            ifelse(data2$Body.Mass.g < 500, "100-500",
                            ifelse(data2$Body.Mass.g < 1000, "500-1000", "> 1000"))))    
    
    
    data2$mass_bin <- as.factor(data2$mass_bin)
    levels(data2$mass_bin)
    data2$mass_bin <- factor(data2$mass_bin, levels = levels(data2$mass_bin)[c(1,3,4,2)])
    levels(data2$mass_bin)
    table(data2$mass_bin)
    
    data2$ln.body.mass <- log(data2$Body.Mass.g)
    
    # Mean normalization
    data2$scaled.body.mass <- (data2$ln.body.mass - mean(data2$ln.body.mass, na.rm = TRUE)/(max(data2$ln.body.mass, na.rm = TRUE)-min(data2$ln.body.mass, na.rm = TRUE))) 
    # str(data2) 
    
    # Rescaling (min-max normalization)
    data2$scaled.body.mass1 <- (data2$ln.body.mass/max(data2$ln.body.mass, na.rm = T)) 
    
# AGE CLASS
    data2$Age.Class <- as.character(data2$Age.Class)
    data2$Age.Class[data2$Age.Class == "A_SA"] <- "SA_A"
    data2$Age.Class[data2$Age.Class == "C"] <- "Nest-bound"
    data2$Age.Class <- as.factor(data2$Age.Class)
    levels(data2$Age.Class)
    data2$Age.Class <- factor(data2$Age.Class, levels = levels(data2$Age.Class)[c(3,4,1, 5, 2)])
    levels(data2$Age.Class)

# FO
    data2$FO.percent <- data2$FO
    data2$FO <- data2$FO/100
    
    # Logit transformed FO, following Warton and Hui (2011, Ecology)
    logit.delta <- min(min(data2$FO[data2$FO != 0], na.rm = T), 
                   max(data2$FO[data2$FO != 1], na.rm = T))
    
    data2$logit.F0 <- log((data2$FO + logit.delta) / ((1-data2$FO) + logit.delta))
    
    data2 <- droplevels(data2)
    
    data2<- data2 %>%
        arrange(UniqueID_Plastic.study, Common.name_BirdTree)

    # Save data2 as intermediate files so can run asreml steps in earlier version of R.
    write.csv(data2, paste0("./output/study_lvl_plastic_data2_traits_clean_",Sys.Date(),".csv"), row.names = F) 
    nrow(data2) # 1658 rows
    list.files("./RData.Session/")
    save.image(paste0("./RData.Session/R.3.5.3_(2019-03-11)_Session_",Sys.Date(),".RData"))
    
    

}else{
    
    if(use.published == TRUE){
    # load("./RData.Session/R.3.5.3_(2019-03-11)_Session_2019-04-19.RData")
    data2 <- read.csv("./output/study_lvl_plastic_data2_traits_clean_2019-03-18_PUBLISHED.csv")
    }else{
    # If don't want to use published version, load one created today or specify date of latest version (look up latest using list.files())
    list.files("./RData.Session/")
    # load(paste0("./RData.Session/R.3.5.3_(2019-03-11)_Session_",Sys.Date(),".RData")) 
    list.files("./output/")
    data2 <- read.csv(paste0("./output/study_lvl_plastic_data2_traits_clean_",Sys.Date(),".csv"))
    }
    
    }
    
    
    
    # Plot Sample Size versus FO
    par(mfrow = c(2,2), mar = c(8,4,0,0) + 0.5)
    plot(FO ~ n, data = data2, las = 1, log = "x")

    # Plot logit transformed data, to see how that works
    par(mfrow = c(1,1), mar = c(4,4,0,0)+0.5)
    plot(logit.F0 ~ FO, data = data2) # looks good.
    
    nrow(data2) # 1658
    
    
```

Not necessary to re-download the phylogentic data. The one downloaded in 2018 is sufficient ("./ConsensusTree.phy"). 
Also not necessary to re-extract the seabird phylogentic data from the all-birds phylogenetic tree every time. The seabird subset is provided ("./output/ConsensusTree_seabird_matched.phy"). However, changes to the subset of seabirds included in the ConsensusTree_seabird_matched.phy can be made if desired.
```{r load.phylogenetic.trees}

subset.consensus.tree.phy <- FALSE

if(subset.consensus.tree.phy == TRUE){ 
source("./R.analysis/subset.consensus.tree.phy_if_TRUE.R")
    
} else {

tree.complete <- read.tree("./output/ConsensusTree.phy")
tree.seabird <- read.tree("./output/ConsensusTree_seabird_matched.phy")

}

# Exploratory plotting
par(mfrow = c(2,1), mar = rep(0.5,4))
plot.phylo(tree.seabird, show.tip.label = FALSE)
plot.phylo(tree.complete, show.tip.label = FALSE)
        
        
```

Final bit of rearrangement before switching to R 3.0.2 for ASREML

This paper involves two analyses. 
1. ASreml analysis of empirical data: evaluation of traits associated with plastic ingestion 
2. MGMGglmm predictions of plastic ingestion across all species

Each has different requirements, and so two input datasets are generated from the 'cleaned' master ("./study_lvl_plastic_data2_traits_clean_2019-04-19.csv").

This chunk generates the input data for (1). Plastic ingestion data was but omitted if the FO, the sample size, or the collection year were not reported, or where species-level data relating to the factors used in the phylogenetic analysis was not available. (This differs from the MCMCGLMM analysis where species with NO FO data could be included. For that analysis only those species for which Feeding Method and Diet were unknown needed to be excluded, based on the findings of the )
```{r create_data_subset_noFOisNA_asreml_R.3.4.0}

 if(recreate.clean.asreml.input.data.datanoNAs == TRUE){ 
   
# Option exists to load the version of data created above, or to load the published version.     
    if(use.published == TRUE){
    # load("./RData.Session/R.3.5.3_(2019-03-11)_Session_2019-04-19.RData")
    data2 <- read.csv("./output/study_lvl_plastic_data2_traits_clean_2019-03-18_PUBLISHED.csv")
    }else{
# If don't want to use published version, load one created today or specify date of latest version (look up latest using list.files())
    list.files("./RData.Session/")
    # load(paste0("./RData.Session/R.3.5.3_(2019-03-11)_Session_",Sys.Date(),".RData")) 
    list.files("./output/")
    datanoNAs <- read.csv(paste0("./output/study_lvl_plastic_data2_traits_clean_",Sys.Date(),".csv"))
    }
    
# For the ASREML analysis it is important to remove species where we lack data on Feeding Method, Mass, Nocturnal Foraging, Opportunistic and Diet so the NAs don't mess up the analysis. It is also important that we remove records (and species) where we have insufficient Study level data on Decade_Date, N, FO and Age.Class
    
     nrow(datanoNAs) # 1658
    species.list <- as.character(levels(datanoNAs$TipLabel_BirdTree))
    
    datanoNAs$animal[!datanoNAs$animal %in% tree.seabird$tip.label] 
    nrow(filter(datanoNAs, datanoNAs$animal %notin% tree.seabird$tip.label))
    nrow(datanoNAs)

# Species factors
    
        # FEEDING METHOD
        # View(subset(datanoNAs, is.na(Feeding.Method)))
        f <- subset(datanoNAs, is.na(Feeding.Method))
        f$Common.name_BirdTree # None
        datanoNAs <- subset(datanoNAs, !is.na(Feeding.Method))
        nrow(datanoNAs) # 1658
    
        # MASS - which sps were excluded bc we lacked mass data?
        # View(subset(datanoNAs, is.na(ln.body.mass)))
        n <- subset(datanoNAs, is.na(ln.body.mass))
        n$Common.name_BirdTree # (No plastic data on them anyways) Socotra Cormorant     Jamaican Petrel       Heinroth's Shearwater Black-bellied Tern         
        datanoNAs <- subset(datanoNAs, !is.na(ln.body.mass))
        nrow(datanoNAs) # 1654
        
        # NOCTURNAL FORAGING
        # View(subset(datanoNAs, is.na(Nocturnal.Foraging)))
        j <- subset(datanoNAs, is.na(Nocturnal.Foraging))
        j$Common.name_BirdTree # none
        datanoNAs <- subset(datanoNAs, !is.na(Nocturnal.Foraging))
        nrow(datanoNAs) # 1654
        
        # OPPORTUNISTIC INFERRED
        # View(subset(datanoNAs, is.na(Opportunistic.Inferred)))
        j <- subset(datanoNAs, is.na(Opportunistic.Inferred))
        j$Common.name_BirdTree # None 
        datanoNAs <- subset(datanoNAs, !is.na(Opportunistic.Inferred))
        nrow(datanoNAs) # 1654
        
        # DIET
        # View(subset(datanoNAs, Diet == "Unknown"))
        h <- subset(datanoNAs, Diet == "Unknown")
        h$Common.name_BirdTree  # (No plastic data on them anyways) Matsudaira's Storm-petrel Ringed Storm-petrel       Swinhoe's Storm-petrel    Fiji Petrel    Mascarene Petrel   
        datanoNAs <- subset(datanoNAs, Diet != "Unknown")
        nrow(datanoNAs) # 1649
        
        d <- subset(datanoNAs, is.na(Diet))
        d$Common.name_BirdTree # None
        datanoNAs <- subset(datanoNAs, !is.na(Diet))
        nrow(datanoNAs) # 1649
        
        
# Study factors      
   
        # Unstudied species
        nope <- subset(datanoNAs, is.na(UniqueID_Plastic.study))
        datanoNAs <- subset(datanoNAs, !is.na(UniqueID_Plastic.study))
        nrow(datanoNAs) # 1475

        # FO
        g <- subset(datanoNAs, is.na(FO))
        nrow(g) # 184
        g <- droplevels(g)
        unique(g$Common.name_BirdTree) # Losing 10 records on 9 species bc FO data not reported.
        #  Little Penguin             White-bellied Storm-petrel Broad-billed Prion         White-faced Storm-petrel   Red PhalaropeWhite-chinned Petrel       Great Shearwater           Short-tailed Shearwater    Black-legged Kittiwake   
        # unique(levels(g$Source)) "Baltz and Morejohn 1976"   "Day et al. 1984/Bond 1971" "Harrigan 1991"             "Ryan, 2008"                "Yamashita et al. 2011" 
        datanoNAs <- subset(datanoNAs, !is.na(FO))
        nrow(datanoNAs) # 1465
        
        # DATE    
        z<-subset(datanoNAs, is.na(Date_Decade))
        z$Common.name_BirdTree # None
        datanoNAs <- subset(datanoNAs, !is.na(Date_Decade))
        nrow(datanoNAs) # 1465

        # SAMPLE SIZE
        s <- subset(datanoNAs, is.na(n))
        s$Common.name_BirdTree # None
        datanoNAs <- subset(datanoNAs, !is.na(n))
        nrow(datanoNAs) # 1465

        # AGE_CLASS
        i <- subset(datanoNAs, is.na(Age.Class))
        nrow(i) # None
        datanoNAs <- subset(datanoNAs, !is.na(Age.Class))
        nrow(datanoNAs) #1465
        
        
        # RECLASSIFY DMS DATA
        datanoNAs <- datanoNAs %>%
        mutate(DMS.responsive_Dell.Ariccia = as.character(DMS.responsive_Dell.Ariccia)) %>%
        mutate(DMS.responsive_Dell.Ariccia = ifelse(is.na(DMS.responsive_Dell.Ariccia), "Unknown", 
                                                    ifelse(DMS.responsive_Dell.Ariccia == "Y", "Yes",
                                                           ifelse(DMS.responsive_Dell.Ariccia == "N", "No", "ERROR"))))
        unique(datanoNAs$DMS.responsive_Dell.Ariccia) 

    # str(datanoNAs)    
    # View(datanoNAs) 
    colnames(datanoNAs)
    nrow(datanoNAs) #1465
    datanoNAs <- droplevels(datanoNAs)  
        
    write.csv(datanoNAs,file = paste0("./output/study_lvl_plastic_data_traits_asreml_FOisNA_removed_", Sys.Date(),".csv"), row.names = FALSE )
    print(paste0("Created *datanoNAs* with FO is NA removed = ", nrow(datanoNAs)," rows")) # 1465 rows is peferct
        
    save.image(paste0("./RData.Session/R.3.5.3_(2019-03-11)_",Sys.Date(),".RData"))
    
    
    # Save bonus dataset for DMS sensititivity analysis
    levels(datanoNAs$Order)
    class(datanoNAs$Order)
    datanoNAs$Order <- as.factor(datanoNAs$Order)

    procellariformes <- datanoNAs %>%
        dplyr::filter(Order == "PROCELLARIIFORMES") %>%
        droplevels()
        
    write.csv(procellariformes,file = paste0("./output/study_lvl_plastic_data_traits_asreml_FOisNA_removed_", Sys.Date(),"_procellariformes.csv"), row.names = FALSE )
    print(paste0("Created *datanoNAs version for just Procellariformes* with FO is NA removed = ", nrow(procellariformes)," rows")) # 1034 rows is peferct

} 

```


The input files are now prepared. 

If you wish to rerun- the phylogenetic mixed model of empirical data to evaluate traits associated with plastic ingestion this will require ASReml-R v3 and R v3.0.2. 
A subscription to download the ASreml-R package can be purchased here: https://www.vsni.co.uk/software/asreml-r/.

If you have access to this package and wish to run the code below to identify the minumum adequate model
1. Save
2. Switch to R 3.0.2 
    Helpful notes:
        - https://support.rstudio.com/hc/en-us/articles/200486138-Changing-R-versions-for-RStudio-desktop
        - An application like R Switch is an easy way to swap between versions of R without needing to reinstall and restart your computer)
3. Close this script and open "./R.analysis/3 Minimum_adequate_model_FO_req_R.3.0.2_ASReml-R_v3.Rmd"

Otherwise, move on to "./R.analysis/4 Predicting_FO_req_R.3.5.3.Rmd" to generate species predictions of the proportion of individuals that have ingested (at least some) plastic. 
